<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitCoach Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, deleteDoc, query, where, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBjN44TuKM2q5tA-4SXvIHlLFZ0hbXawWM",
            authDomain: "gymb-6006c.firebaseapp.com",
            projectId: "gymb-6006c",
            storageBucket: "gymb-6006c.firebasestorage.app",
            messagingSenderId: "99807290871",
            appId: "1:99807290871:web:24df0fbf56c79c93d43af2",
            measurementId: "G-JXY7XZ8V1H"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.db = db;
        window.auth = auth;
        window.analytics = analytics;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.collection = collection;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
    </script>
    
    <style>
        :root {
            --color-primary: #006A67;
            --color-primary-dark: #004A47;
            --color-secondary: #92DDA2;
            --color-bg: #E7FFE1;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #E7FFE1;
            color: #1f2937;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }

        .mobile-menu-toggle.active {
            background: #dc2626;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #006A67, #92DDA2, #006A67);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 420px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: #1f2937;
            position: relative;
        }

        .login-title:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--color-primary);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }

        .btn {
            padding: 0.9rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 95, 106, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(to bottom, #006A67, #004A47);
            color: white;
            padding: 1.5rem 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        /* Close button for mobile sidebar */
        .sidebar-close {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .sidebar-close:hover {
            transform: rotate(90deg);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #374151;
            color: white;
        }

        .logo i {
            color: var(--color-primary);
            font-size: 1.8rem;
        }

        .nav-menu {
            list-style: none;
            margin-top: 1rem;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            color: #d1d5db;
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(0, 95, 106, 0.15);
            color: white;
        }

        .nav-link i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            background: var(--color-bg);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-title i {
            color: var(--color-primary);
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-refresh {
            background: #e5e7eb;
            color: #4b5563;
        }

        .btn-refresh:hover {
            background: #d1d5db;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Table wrapper for horizontal scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .stat-card {
            background: white;
            padding: 1.75rem;
            border-radius: 0.85rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        }

        .stat-title {
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 0.25rem;
        }

        .stat-change {
            font-size: 0.85rem;
            color: #059669;
            font-weight: 500;
        }

        .consultations-table {
            background: white;
            border-radius: 0.85rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-top: 2rem;
        }

        .table-header {
            background: #f9fafb;
            padding: 1.25rem 1.75rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .filters {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-select {
            padding: 0.65rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            background: white;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1.15rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            padding: 0.35rem 0.85rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .status-new {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status-contacted {
            background: #fef3c7;
            color: #d97706;
        }

        .status-scheduled {
            background: #d1fae5;
            color: #059669;
        }

        .status-completed {
            background: #e0e7ff;
            color: #7c3aed;
        }

        .status-registered {
            background: #f3e8ff;
            color: #9333ea;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-view {
            background: var(--color-primary);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-update {
            background: #4b5563;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-success {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-success:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Enhanced Orders Styles */
        .orders-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .orders-stat-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .orders-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }

        .orders-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .orders-stat-card.total-orders::before {
            background: linear-gradient(90deg, #006A67 0%, #92DDA2 100%);
        }

        .orders-stat-card.pending-orders::before {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .orders-stat-card.confirmed-orders::before {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .orders-stat-card.revenue-card::before {
            background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .orders-stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .total-orders .stat-icon {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .pending-orders .stat-icon {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .confirmed-orders .stat-icon {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .revenue-card .stat-icon {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .orders-stat-card .stat-content {
            flex: 1;
        }

        .orders-stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .orders-stat-card .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .orders-stat-card .stat-trend {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-trend.positive {
            color: #059669;
        }

        .stat-trend.negative {
            color: #dc2626;
        }

        .stat-trend.neutral {
            color: #6b7280;
        }

        /* Enhanced Search and Filters */
        .orders-controls {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .search-section {
            margin-bottom: 1.5rem;
        }

        .search-input-wrapper {
            position: relative;
            max-width: 400px;
        }

        .search-input-wrapper i.fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            z-index: 1;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: #f9fafb;
        }

        .search-input-wrapper input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }

        .clear-search {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.2s ease;
        }

        .clear-search:hover {
            color: #6b7280;
        }

        .filters-section {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 150px;
        }

        .filter-group label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modern-select {
            padding: 0.625rem 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
            color: #374151;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .modern-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modern-select:hover {
            border-color: #d1d5db;
        }

        /* Quick Actions Bar */
        .quick-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .bulk-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .selected-count {
            font-size: 0.875rem;
            color: #374151;
            font-weight: 500;
        }

        .view-options {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-options label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .view-btn {
            padding: 0.5rem 0.875rem;
            border: 2px solid #e5e7eb;
            background: white;
            color: #6b7280;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .view-btn:hover {
            border-color: #d1d5db;
            color: #374151;
        }

        .view-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        /* Enhanced Table Container */
        .orders-table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .table-header-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .table-header-enhanced .table-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .orders-count {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 400;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            background: none;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #374151;
        }

        /* Enhanced Table */
        .enhanced-table {
            width: 100%;
            border-collapse: collapse;
        }

        .enhanced-table th {
            background: #f9fafb;
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .enhanced-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .enhanced-table th.sortable:hover {
            background: #f3f4f6;
        }

        .enhanced-table th.sortable i {
            margin-left: 0.5rem;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .enhanced-table th.sortable:hover i {
            opacity: 1;
        }

        .enhanced-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .enhanced-table tr:hover {
            background: #f9fafb;
        }

        .enhanced-table tr.selected {
            background: rgba(59, 130, 246, 0.05);
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        .actions-column {
            width: 180px;
            text-align: center;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #6b7280;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }

        .empty-icon {
            font-size: 3rem;
            color: #d1d5db;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        /* Cards View */
        .orders-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .order-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #d1d5db;
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .order-id {
            font-family: monospace;
            font-size: 0.875rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .order-card-body {
            margin-bottom: 1rem;
        }

        .customer-info {
            margin-bottom: 0.75rem;
        }

        .customer-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .customer-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .order-items {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .order-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: #059669;
            margin-bottom: 0.75rem;
        }

        .order-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #f3f4f6;
        }

        .order-date {
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-numbers {
            display: flex;
            gap: 0.25rem;
        }

        .page-number {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .page-number:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .page-number.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .items-per-page label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .items-per-page select {
            padding: 0.375rem 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .orders-stats-grid {
                grid-template-columns: 1fr;
            }

            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                min-width: unset;
            }

            .quick-actions-bar {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .pagination-container {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .orders-cards-grid {
                grid-template-columns: 1fr;
            }

            .enhanced-table {
                font-size: 0.75rem;
            }

            .enhanced-table th,
            .enhanced-table td {
                padding: 0.75rem 0.5rem;
            }
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
            margin: 0 0.125rem;
        }

        .payment-method-badge {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .payment-method-badge.instapay {
            background: #dbeafe;
            color: #1e40af;
        }

        .payment-method-badge.bank-transfer {
            background: #f0fdf4;
            color: #166534;
        }

        .payment-method-badge.cash {
            background: #fef3c7;
            color: #92400e;
        }

        .page-ellipsis {
            padding: 0.5rem 0.75rem;
            color: #9ca3af;
            font-size: 0.875rem;
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: #059669;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2.5rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            resize: vertical;
        }

        .form-group select {
            background: white;
        }

        .meal-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: #f9fafb;
        }

        .meal-section h4 {
            margin: 0 0 1.25rem 0;
            color: #1f2937;
            font-size: 1.15rem;
            font-weight: 600;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meal-items {
            margin-bottom: 1rem;
        }

        .meal-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 1rem;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .serving-controls {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.75rem;
            grid-column: 1 / -1;
        }

        .serving-controls input {
            width: 100%;
            padding: 0.65rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9rem;
        }

        .serving-controls select {
            padding: 0.65rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            background: white;
        }

        .serving-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .nutrition-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            grid-column: 1 / -1;
        }

        .nutrition-input {
            padding: 0.85rem;
            border-radius: 0.5rem;
            background: #f9fafb;
            text-align: center;
        }

        .nutrition-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .nutrition-value {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .btn-add-food {
            background: #4b5563;
            color: white;
            border: none;
            padding: 0.65rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-add-food:hover {
            background: #374151;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 0.85rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            border: 1px solid #fecaca;
        }

        .success-message {
            background: #f0fdf4;
            color: #059669;
            padding: 0.85rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            border: 1px solid #a7f3d0;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .content-section {
            width: 100%;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .sidebar {
                width: 260px;
            }
            .main-content {
                margin-left: 260px;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 240px;
            }
            .main-content {
                margin-left: 240px;
                padding: 1.5rem;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-close {
                display: block;
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
                padding-top: 4rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.25rem;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .meal-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .table {
                font-size: 0.8rem;
                min-width: 600px;
            }
            
            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                padding: 1.5rem;
                width: 95%;
                max-width: none;
                margin: 1rem;
            }
            
            .filters {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }
            
            .login-card {
                margin: 1rem;
                padding: 2rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 0.75rem;
                padding-top: 3.5rem;
            }
            
            .page-title {
                font-size: 1.25rem;
            }
            
            .page-title i {
                font-size: 1.2rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .stat-title {
                font-size: 0.85rem;
            }
            
            .table {
                font-size: 0.75rem;
            }
            
            .table th,
            .table td {
                padding: 0.5rem 0.25rem;
            }
            
            .modal-content {
                padding: 1rem;
                border-radius: 0.5rem;
            }
            
            .modal-title {
                font-size: 1.25rem;
            }
            
            .form-group label {
                font-size: 0.9rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.9rem;
                padding: 0.75rem;
            }
            
            .btn {
                padding: 0.65rem 1rem;
                font-size: 0.85rem;
            }
            
            .status-badge {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .login-card {
                padding: 1.5rem;
            }
            
            .login-title {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 360px) {
            .main-content {
                padding: 0.5rem;
                padding-top: 3.5rem;
            }
            
            .page-title {
                font-size: 1.1rem;
                gap: 0.5rem;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .table {
                font-size: 0.7rem;
            }
            
            .btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        /* Landscape mode adjustments */
        @media (max-height: 600px) and (orientation: landscape) {
            .sidebar {
                padding: 1rem 0.75rem;
            }
            
            .logo {
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
            }
            
            .nav-link {
                padding: 0.65rem 0.75rem;
            }
            
            .main-content {
                padding-top: 1rem;
            }
        }

        /* Nutrition Progress Bars */
        .nutrition-progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .nutrition-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Enhanced meal section styling */
        .meal-section {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: border-color 0.3s ease;
        }

        .meal-section:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
        }

        .meal-section h4 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            color: #1f2937;
            font-size: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .meal-section h4 i {
            color: #2563eb;
            font-size: 1.5rem;
        }

        /* Enhanced meal item styling */
        .meal-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .meal-item:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced food selection button */
        .btn-add-food {
            background: linear-gradient(135deg, #006A67, #92DDA2);
            color: white;
            border: 2px dashed transparent;
            padding: 1rem;
            border-radius: 0.75rem;
            width: 100%;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-add-food:hover {
            background: linear-gradient(135deg, #004A47, #006A67);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* Nutrition value styling */
        .nutrition-value {
            font-weight: 600;
            color: #2563eb;
        }

        /* Creative animations */
        @keyframes pulse-success {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .nutrition-goals-complete {
            animation: pulse-success 2s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .nutrition-warning {
            animation: shake 0.5s ease-in-out;
            border-color: #f59e0b !important;
        }

        /* Day Tabs Styling */
        .day-tabs {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .day-tab {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
        }

        .day-tab:hover {
            border-color: #2563eb;
            background: #f8fafc;
            transform: translateY(-2px);
        }

        .day-tab.active {
            background: linear-gradient(135deg, #006A67, #92DDA2);
            border-color: #006A67;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 106, 103, 0.3);
        }

        .day-tab.active i {
            color: #93c5fd;
        }

        .btn-add-day {
            background: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 3rem;
        }

        .btn-add-day:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: scale(1.05);
        }

        /* Day Controls */
        .day-controls {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 0.5rem;
        }

        /* Enhanced meal sections for multi-day */
        .meal-section[data-day] {
            border-left: 4px solid #2563eb;
            position: relative;
        }

        .meal-section[data-day]:before {
            content: attr(data-day-label);
            position: absolute;
            top: -10px;
            left: -4px;
            background: #006A67;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Nutrition summary animation */
        #dayNutritionSummary {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive day tabs */
        @media (max-width: 768px) {
            .day-tabs {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }
            
            .day-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .day-controls {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.75rem;
            }
            
            .day-controls > div {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* View Modal Styles */
        .plan-info-card, .nutrition-summary-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .info-row {
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .nutrition-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }

        .nutrition-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .nutrition-value {
            font-weight: 600;
            color: #111827;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-style: italic;
        }

        .empty-meal {
            padding: 0.75rem;
            background: #f3f4f6;
            border-radius: 0.375rem;
            color: #6b7280;
            font-style: italic;
            text-align: center;
        }

        .edit-day-tab {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-day-tab:hover {
            background: #f3f4f6;
        }

        .edit-day-tab.active {
            background: #dbeafe !important;
            border-color: #3b82f6 !important;
            color: #1e40af;
            font-weight: 600;
        }

        .food-item-view {
            transition: all 0.2s ease;
        }

        .food-item-view:hover {
            background: #f3f4f6 !important;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo" style="justify-content: center; border: none; margin-bottom: 1rem;">
                <i class="fas fa-dumbbell"></i>
                <span>FitCoach Admin</span>
            </div>
            <h1 class="login-title">Administrator Login</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="adminEmail"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="adminEmail" placeholder="admin@fitcoach.com" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container" style="display: none;">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-close" id="sidebarClose">
                <i class="fas fa-times"></i>
            </button>
            <div class="logo">
                <i class="fas fa-dumbbell"></i>
                <span>FitCoach Admin</span>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="clients">
                        <i class="fas fa-users"></i> Clients
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="nutrition">
                        <i class="fas fa-utensils"></i> Nutrition Plans
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="exercises">
                        <i class="fas fa-dumbbell"></i> Exercises
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="orders">
                        <i class="fas fa-shopping-cart"></i> Orders
                    </a>
                </div>
                <div class="nav-item">
                    <button class="nav-link" id="logoutBtn" style="width: 100%; text-align: left; background: none; border: none; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-chart-line"></i> Dashboard Overview
                    </h1>
                    <div class="header-actions">
                        <button class="btn btn-refresh" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-calendar"></i> Total Consultations</div>
                        <div class="stat-value" id="totalConsultations">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="consultationsChange">0%</span> from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-exclamation-circle"></i> New Requests</div>
                        <div class="stat-value" id="newConsultations">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-down"></i> <span id="newChange">0%</span> from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-clock"></i> Scheduled</div>
                        <div class="stat-value" id="scheduledConsultations">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="scheduledChange">0%</span> from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-check-circle"></i> Completed</div>
                        <div class="stat-value" id="completedConsultations">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="completedChange">0%</span> from last week</div>
                    </div>
                </div>

                <div class="consultations-table">
                    <div class="table-header">
                        <h2 class="table-title">Recent Consultations</h2>
                        <div class="filters">
                            <select class="filter-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="new">New</option>
                                <option value="contacted">Contacted</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                    <table class="table" id="consultationsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Service</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="consultationsTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Nutrition Plans Section -->
            <div id="nutritionSection" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-utensils"></i> Nutrition Plans
                    </h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showCreateNutritionPlanModal().catch(console.error)">
                            <i class="fas fa-plus"></i> Create New Plan
                        </button>
                        <button class="btn btn-refresh" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-book"></i> Total Plans</div>
                        <div class="stat-value" id="totalNutritionPlans">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="plansChange">0%</span> from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-check-circle"></i> Active Plans</div>
                        <div class="stat-value" id="activeNutritionPlans">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="activeChange">0%</span> from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-calendar"></i> This Month</div>
                        <div class="stat-value" id="newNutritionPlans">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-down"></i> <span id="newPlansChange">0%</span> from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-flag-checkered"></i> Completed</div>
                        <div class="stat-value" id="completedNutritionPlans">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="completedPlansChange">0%</span> from last month</div>
                    </div>
                </div>

                <div class="consultations-table">
                    <div class="table-header">
                        <h2 class="table-title">Nutrition Plans</h2>
                        <div class="filters">
                            <select class="filter-select" id="nutritionStatusFilter">
                                <option value="">All Plans</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="paused">Paused</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                    <table class="table" id="nutritionTable">
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>Plan Name</th>
                                <th>Calories</th>
                                <th>Protein</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="nutritionTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Clients Section -->
            <div id="clientsSection" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-users"></i> Clients
                    </h1>
                    <div class="header-actions">
                        <button class="btn btn-refresh" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="consultations-table">
                    <div class="table-header">
                        <h2 class="table-title">Registered Clients</h2>
                    </div>
                    <div class="table-wrapper">
                    <table class="table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Exercises Section -->
            <div id="exercisesSection" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-dumbbell"></i> Exercise Management
                    </h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showCreateExerciseModal()">
                            <i class="fas fa-plus"></i> Add Exercise to Client
                        </button>
                        <button class="btn btn-refresh" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-dumbbell"></i> Total Exercises</div>
                        <div class="stat-value" id="totalExercises">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="exercisesChange">0%</span> from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-users"></i> Active Clients</div>
                        <div class="stat-value" id="activeExerciseClients">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="activeClientsChange">0%</span> from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-play-circle"></i> Videos Available</div>
                        <div class="stat-value" id="exerciseVideos">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-down"></i> <span id="videosChange">0%</span> from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-check-circle"></i> Completed</div>
                        <div class="stat-value" id="completedExercises">0</div>
                        <div class="stat-change"><i class="fas fa-arrow-up"></i> <span id="completedExercisesChange">0%</span> from last month</div>
                    </div>
                </div>

                <div class="consultations-table">
                    <div class="table-header">
                        <h2 class="table-title">Client Exercises</h2>
                        <div class="filters">
                            <select class="filter-select" id="exerciseStatusFilter">
                                <option value="">All Exercises</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="paused">Paused</option>
                            </select>
                            <select class="filter-select" id="exerciseCategoryFilter">
                                <option value="">All Categories</option>
                                <option value="chest">Chest</option>
                                <option value="biceps">Biceps</option>
                                <option value="triceps">Triceps</option>
                                <option value="shoulders">Shoulders</option>
                                <option value="back">Back</option>
                                <option value="legs">Legs</option>
                                <option value="abs">Abs</option>
                                <option value="cardio">Cardio</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                    <table class="table" id="exercisesTable">
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>Exercise Name</th>
                                <th>Category</th>
                                <th>Video</th>
                                <th>Status</th>
                                <th>Assigned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="exercisesTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="ordersSection" class="content-section" style="display: none;">
                <div class="header">
                    <h1 class="page-title">
                        <i class="fas fa-shopping-cart"></i> Orders Management
                    </h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportOrders()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-refresh" onclick="refreshOrdersData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Enhanced Statistics Grid -->
                <div class="orders-stats-grid">
                    <div class="orders-stat-card total-orders">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalOrders">0</div>
                            <div class="stat-label">Total Orders</div>
                            <div class="stat-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="ordersChange">0%</span> vs last month
                            </div>
                        </div>
                    </div>
                    
                    <div class="orders-stat-card pending-orders">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="pendingOrders">0</div>
                            <div class="stat-label">Pending Payment</div>
                            <div class="stat-trend neutral">
                                <i class="fas fa-minus"></i>
                                <span id="pendingChange">0</span> awaiting confirmation
                            </div>
                        </div>
                    </div>
                    
                    <div class="orders-stat-card confirmed-orders">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="confirmedOrders">0</div>
                            <div class="stat-label">Confirmed Orders</div>
                            <div class="stat-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="confirmedChange">0%</span> vs last week
                            </div>
                        </div>
                    </div>
                    
                    <div class="orders-stat-card revenue-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalRevenue">$0</div>
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span id="revenueChange">0%</span> vs last month
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Search and Filters -->
                <div class="orders-controls">
                    <div class="search-section">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="ordersSearchInput" placeholder="Search by customer name, email, or order ID..." onkeyup="searchOrders()">
                            <button class="clear-search" onclick="clearOrdersSearch()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="filters-section">
                        <div class="filter-group">
                            <label>Status:</label>
                            <select class="modern-select" id="orderStatusFilter" onchange="applyOrdersFilters()">
                                <option value="">All Status</option>
                                <option value="pending">🕐 Pending Payment</option>
                                <option value="confirmed">✅ Payment Confirmed</option>
                                <option value="cancelled">❌ Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Date Range:</label>
                            <select class="modern-select" id="dateRangeFilter" onchange="applyOrdersFilters()">
                                <option value="">All Time</option>
                                <option value="today">📅 Today</option>
                                <option value="week">📅 This Week</option>
                                <option value="month">📅 This Month</option>
                                <option value="custom">📅 Custom Range</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Payment Method:</label>
                            <select class="modern-select" id="paymentMethodFilter" onchange="applyOrdersFilters()">
                                <option value="">All Methods</option>
                                <option value="instapay">📱 InstaPay</option>
                                <option value="bank-transfer">🏦 Bank Transfer</option>
                                <option value="cash">💰 Cash</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-outline" onclick="resetOrdersFilters()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Quick Actions Bar -->
                <div class="quick-actions-bar">
                    <div class="bulk-actions" id="bulkActions" style="display: none;">
                        <span class="selected-count">0 selected</span>
                        <button class="btn btn-success" onclick="bulkConfirmPayments()">
                            <i class="fas fa-check"></i> Confirm Selected
                        </button>
                        <button class="btn btn-danger" onclick="bulkDeleteOrders()">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                    </div>
                    
                    <div class="view-options">
                        <label>View:</label>
                        <button class="view-btn active" data-view="table" onclick="switchOrdersView('table')">
                            <i class="fas fa-table"></i> Table
                        </button>
                        <button class="view-btn" data-view="cards" onclick="switchOrdersView('cards')">
                            <i class="fas fa-th-large"></i> Cards
                        </button>
                    </div>
                </div>

                <!-- Enhanced Orders Table -->
                <div class="orders-table-container">
                    <div class="table-header-enhanced">
                        <h3 class="table-title">
                            <span id="ordersTableTitle">All Orders</span>
                            <span class="orders-count" id="ordersCount">(0)</span>
                        </h3>
                        <div class="table-actions">
                            <button class="btn btn-icon" onclick="toggleColumnsMenu()" title="Customize Columns">
                                <i class="fas fa-columns"></i>
                            </button>
                            <button class="btn btn-icon" onclick="refreshOrdersTable()" title="Refresh Table">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div class="loading-state" id="ordersLoadingState" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Loading orders...</p>
                    </div>
                    
                    <!-- Table View -->
                    <div class="enhanced-table-wrapper" id="ordersTableView">
                        <table class="enhanced-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th class="checkbox-column">
                                        <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders()">
                                    </th>
                                    <th class="sortable" onclick="sortOrders('id')">
                                        Order ID <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortOrders('customerName')">
                                        Customer <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortOrders('total')">
                                        Total <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Payment Method</th>
                                    <th class="sortable" onclick="sortOrders('paymentStatus')">
                                        Status <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" onclick="sortOrders('timestamp')">
                                        Date <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="actions-column" style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Cards View -->
                    <div class="orders-cards-view" id="ordersCardsView" style="display: none;">
                        <div class="orders-cards-grid" id="ordersCardsGrid">
                            <!-- Cards will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div class="empty-state" id="ordersEmptyState" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3>No Orders Found</h3>
                        <p>There are no orders matching your current filters.</p>
                        <button class="btn btn-primary" onclick="resetOrdersFilters()">
                            <i class="fas fa-refresh"></i> Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="ordersPagination">
                    <div class="pagination-info">
                        Showing <span id="paginationStart">0</span>-<span id="paginationEnd">0</span> of <span id="paginationTotal">0</span> orders
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-icon" onclick="previousOrdersPage()" id="prevPageBtn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="page-numbers" id="pageNumbers">
                            <!-- Page numbers will be populated by JavaScript -->
                        </span>
                        <button class="btn btn-icon" onclick="nextOrdersPage()" id="nextPageBtn" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="items-per-page">
                        <label>Items per page:</label>
                        <select class="modern-select" id="itemsPerPage" onchange="changeItemsPerPage()">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Nutrition Plan Modal -->
    <div class="modal" id="nutritionPlanModal">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; overflow-y: auto;">
            <style>
                @media (max-width: 768px) {
                    #nutritionPlanModal .modal-content {
                        width: 100% !important;
                        height: 100% !important;
                        max-width: none !important;
                        max-height: none !important;
                        border-radius: 0 !important;
                        margin: 0 !important;
                        padding: 1rem !important;
                    }
                    
                    #nutritionPlanModal .form-row {
                        flex-direction: column !important;
                        gap: 1rem !important;
                    }
                    
                    #nutritionPlanModal .form-group {
                        width: 100% !important;
                    }
                    
                    #nutritionPlanModal .day-tabs {
                        flex-wrap: wrap !important;
                        gap: 0.25rem !important;
                    }
                    
                    #nutritionPlanModal .day-tab {
                        flex: 1 1 calc(50% - 0.25rem) !important;
                        min-width: 120px !important;
                        font-size: 0.875rem !important;
                        padding: 0.5rem 0.75rem !important;
                    }
                    
                    #nutritionPlanModal .day-controls {
                        flex-direction: column !important;
                        gap: 0.75rem !important;
                    }
                    
                    #nutritionPlanModal .day-controls > div {
                        width: 100% !important;
                        justify-content: center !important;
                    }
                    
                    #nutritionPlanModal .meal-item {
                        flex-direction: column !important;
                        gap: 0.75rem !important;
                        padding: 1rem !important;
                    }
                    
                    #nutritionPlanModal .serving-controls {
                        flex-direction: column !important;
                        gap: 0.5rem !important;
                        align-items: stretch !important;
                    }
                    
                    #nutritionPlanModal .nutrition-inputs {
                        grid-template-columns: repeat(2, 1fr) !important;
                        gap: 0.5rem !important;
                    }
                    
                    #nutritionPlanModal .nutrition-input {
                        padding: 0.5rem !important;
                        font-size: 0.875rem !important;
                    }
                    
                    #nutritionPlanModal .nutrition-summary {
                        grid-template-columns: repeat(2, 1fr) !important;
                        gap: 0.5rem !important;
                    }
                    
                    #nutritionPlanModal .action-buttons {
                        flex-direction: column !important;
                        gap: 0.75rem !important;
                    }
                    
                    #nutritionPlanModal .action-buttons .btn {
                        width: 100% !important;
                        padding: 0.75rem 1rem !important;
                    }
                    
                    #nutritionPlanModal h3, #nutritionPlanModal h4, #nutritionPlanModal h5 {
                        font-size: 1.1rem !important;
                        margin-bottom: 0.75rem !important;
                    }
                    
                    #nutritionPlanModal input, #nutritionPlanModal select, #nutritionPlanModal textarea {
                        font-size: 16px !important;
                        padding: 0.75rem !important;
                    }
                    
                    #nutritionPlanModal label {
                        font-size: 0.9rem !important;
                        margin-bottom: 0.5rem !important;
                    }
                }
            </style>
            <div class="modal-header">
                <h3 class="modal-title">Create Nutrition Plan</h3>
                <button class="modal-close" onclick="closeModal('nutritionPlanModal')">&times;</button>
            </div>
            <form id="nutritionPlanForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nutritionClientSelect">Select Client</label>
                        <select id="nutritionClientSelect" required>
                            <option value="">Choose a client...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="planName">Plan Name</label>
                        <input type="text" id="planName" placeholder="e.g., Weight Loss Plan, Muscle Gain Plan" required>
                    </div>
                </div>

                <!-- Smart Nutrition Calculator -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; color: white;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-calculator"></i> Smart Nutrition Calculator
                    </h3>
                    <p style="margin: 0 0 1rem 0; opacity: 0.9;">Set your targets below or let the system auto-calculate from your meal selections!</p>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="calculationMode" value="manual" checked onchange="toggleCalculationMode()">
                            <span>Manual Entry</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="calculationMode" value="auto" onchange="toggleCalculationMode()">
                            <span>Auto-Calculate from Foods</span>
                        </label>
                    </div>
                </div>

                <!-- Nutrition Goals Section -->
                <div id="nutritionGoalsSection" style="background: #f8fafc; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-bullseye"></i> Daily Nutrition Goals
                        </h4>
                        <button type="button" id="autoCalculateBtn" class="btn btn-primary" onclick="autoCalculateFromMeals()" style="display: none;">
                            <i class="fas fa-magic"></i> Auto-Calculate
                        </button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                            <label for="dailyCalories" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Daily Calories</span>
                                <span id="calculatedCalories" style="font-size: 0.875rem; color: #059669; font-weight: 500;"></span>
                            </label>
                            <input type="number" id="dailyCalories" min="800" max="5000" step="50" value="1800" required onchange="updateNutritionProgress()">
                            <div class="nutrition-progress-bar">
                                <div id="caloriesProgress" class="nutrition-progress-fill"></div>
                            </div>
                    </div>
                    <div class="form-group">
                            <label for="dailyProtein" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Daily Protein (g)</span>
                                <span id="calculatedProtein" style="font-size: 0.875rem; color: #059669; font-weight: 500;"></span>
                            </label>
                            <input type="number" id="dailyProtein" min="20" max="300" step="5" value="140" required onchange="updateNutritionProgress()">
                            <div class="nutrition-progress-bar">
                                <div id="proteinProgress" class="nutrition-progress-fill"></div>
                            </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                            <label for="dailyCarbs" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Daily Carbs (g)</span>
                                <span id="calculatedCarbs" style="font-size: 0.875rem; color: #059669; font-weight: 500;"></span>
                            </label>
                            <input type="number" id="dailyCarbs" min="20" max="500" step="5" value="200" required onchange="updateNutritionProgress()">
                            <div class="nutrition-progress-bar">
                                <div id="carbsProgress" class="nutrition-progress-fill"></div>
                            </div>
                    </div>
                    <div class="form-group">
                            <label for="dailyFat" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Daily Fat (g)</span>
                                <span id="calculatedFat" style="font-size: 0.875rem; color: #059669; font-weight: 500;"></span>
                            </label>
                            <input type="number" id="dailyFat" min="10" max="150" step="5" value="60" required onchange="updateNutritionProgress()">
                            <div class="nutrition-progress-bar">
                                <div id="fatProgress" class="nutrition-progress-fill"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Nutrition Summary Card -->
                    <div id="nutritionSummary" style="background: white; border-radius: 0.75rem; padding: 1rem; margin-top: 1rem; border: 1px solid #e5e7eb;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #374151; text-align: center;">📊 Current Meal Plan Totals</h5>
                        <div class="nutrition-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                            <div style="background: #fef2f2; padding: 0.75rem; border-radius: 0.5rem;">
                                <div id="totalCalories" style="font-size: 1.25rem; font-weight: 700; color: #dc2626;">0</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Calories</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 0.5rem;">
                                <div id="totalProtein" style="font-size: 1.25rem; font-weight: 700; color: #059669;">0g</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Protein</div>
                            </div>
                            <div style="background: #fefbeb; padding: 0.75rem; border-radius: 0.5rem;">
                                <div id="totalCarbs" style="font-size: 1.25rem; font-weight: 700; color: #d97706;">0g</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Carbs</div>
                            </div>
                            <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem;">
                                <div id="totalFat" style="font-size: 1.25rem; font-weight: 700; color: #6b7280;">0g</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Fat</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="planDescription">Plan Description</label>
                    <textarea id="planDescription" rows="3" placeholder="Describe the nutrition plan goals and guidelines..." required>This plan focuses on balanced macronutrients for sustainable weight loss while maintaining muscle mass. It includes lean proteins, complex carbohydrates, and healthy fats.</textarea>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-calendar-alt"></i> Multi-Day Meal Plan
                    </label>
                    
                    <!-- Day Selection Tabs -->
                    <div class="day-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; overflow-x: auto; padding-bottom: 0.5rem;">
                        <button type="button" class="day-tab active" data-day="1" onclick="switchDay(1)">
                            <i class="fas fa-calendar-day"></i> Day 1
                        </button>
                        <button type="button" class="day-tab" data-day="2" onclick="switchDay(2)">
                            <i class="fas fa-calendar-day"></i> Day 2
                        </button>
                        <button type="button" class="day-tab" data-day="3" onclick="switchDay(3)">
                            <i class="fas fa-calendar-day"></i> Day 3
                        </button>
                        <button type="button" class="day-tab" data-day="4" onclick="switchDay(4)">
                            <i class="fas fa-calendar-day"></i> Day 4
                        </button>
                        <button type="button" class="day-tab" data-day="5" onclick="switchDay(5)">
                            <i class="fas fa-calendar-day"></i> Day 5
                        </button>
                        <button type="button" class="day-tab" data-day="6" onclick="switchDay(6)">
                            <i class="fas fa-calendar-day"></i> Day 6
                        </button>
                        <button type="button" class="day-tab" data-day="7" onclick="switchDay(7)">
                            <i class="fas fa-calendar-day"></i> Day 7
                        </button>
                        <button type="button" class="btn-add-day" onclick="addNewDay()" title="Add more days">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <!-- Day Control Panel -->
                    <div class="day-controls" style="background: #f8fafc; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <h4 style="margin: 0; color: #374151;" id="currentDayTitle">
                                    <i class="fas fa-calendar-day"></i> Day 1 Meal Plan
                                </h4>
                                <span id="dayNutritionSummary" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">
                                    0 cal • 0g protein • 0g carbs • 0g fat
                                </span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary btn-small" onclick="copyFromPreviousDay()">
                                    <i class="fas fa-copy"></i> Copy Previous Day
                                </button>
                                <button type="button" class="btn btn-danger btn-small" onclick="clearCurrentDay()">
                                    <i class="fas fa-trash"></i> Clear Day
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Meal Plan Container for Current Day -->
                    <div id="mealPlanContainer">
                        <div class="meal-section">
                            <h4><i class="fas fa-sun"></i> Breakfast</h4>
                            <div class="meal-items">
                                <div class="meal-item">
                                    <div class="serving-controls">
                                        <span class="serving-label">Amount:</span>
                                        <input type="number" class="serving-amount" value="100" min="1" step="1">
                                        <select class="serving-unit">
                                            <option value="grams">Grams</option>
                                            <option value="cups">Cups</option>
                                            <option value="tablespoons">Tablespoons</option>
                                            <option value="pieces">Pieces</option>
                                        </select>
                                    </div>
                                    <input type="text" value="Greek Yogurt" class="food-item" readonly>
                                    <div class="nutrition-inputs">
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Calories</div>
                                            <div class="nutrition-value" id="caloriesValue">59</div>
                                        </div>
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Protein (g)</div>
                                            <div class="nutrition-value" id="proteinValue">10</div>
                                        </div>
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Carbs (g)</div>
                                            <div class="nutrition-value" id="carbsValue">3.6</div>
                                        </div>
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Fat (g)</div>
                                            <div class="nutrition-value" id="fatValue">0.4</div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-small" onclick="removeMealItem(this)">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-add-food" onclick="showFoodSelectionModal('breakfast')">
                                <i class="fas fa-plus"></i> Add Food Item
                            </button>
                        </div>

                        <div class="meal-section">
                            <h4><i class="fas fa-sun"></i> Lunch</h4>
                            <div class="meal-items">
                                <div class="meal-item">
                                    <div class="serving-controls">
                                        <span class="serving-label">Amount:</span>
                                        <input type="number" class="serving-amount" value="150" min="1" step="1">
                                        <select class="serving-unit">
                                            <option value="grams">Grams</option>
                                            <option value="cups">Cups</option>
                                            <option value="pieces">Pieces</option>
                                        </select>
                                    </div>
                                    <input type="text" value="Chicken Breast" class="food-item" readonly>
                                    <div class="nutrition-inputs">
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Calories</div>
                                            <div class="nutrition-value" id="caloriesValue">165</div>
                                        </div>
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Protein (g)</div>
                                            <div class="nutrition-value" id="proteinValue">31</div>
                                        </div>
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Carbs (g)</div>
                                            <div class="nutrition-value" id="carbsValue">0</div>
                                        </div>
                                        <div class="nutrition-input">
                                            <div class="nutrition-label">Fat (g)</div>
                                            <div class="nutrition-value" id="fatValue">3.6</div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-small" onclick="removeMealItem(this)">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-add-food" onclick="showFoodSelectionModal('lunch')">
                                <i class="fas fa-plus"></i> Add Food Item
                            </button>
                        </div>
                        <div class="meal-section">
                            <h4><i class="fas fa-moon"></i> Dinner</h4>
                            <div class="meal-items">
                                <!-- Dinner items here -->
                            </div>
                            <button type="button" class="btn btn-add-food" onclick="showFoodSelectionModal('dinner')">
                                <i class="fas fa-plus"></i> Add Food Item
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="planNotes">Additional Notes</label>
                    <textarea id="planNotes" rows="3" placeholder="Any additional instructions or notes for the client...">Client prefers plant-based alternatives where possible. Avoid dairy if possible.</textarea>
                </div>

                <div class="action-buttons" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Create Nutrition Plan
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('nutritionPlanModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Food Selection Modal -->
    <div class="modal" id="foodSelectionModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Select Food Item</h3>
                <button class="modal-close" onclick="closeModal('foodSelectionModal')">&times;</button>
            </div>
            <div class="food-selection-content">
                <div class="food-search" style="margin-bottom: 1.5rem;">
                    <input type="text" id="foodSearchInput" placeholder="Search for food..." style="flex: 1; padding: 0.9rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                    <select id="foodCategoryFilter" style="padding: 0.9rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; min-width: 180px;">
                        <option value="">All Categories</option>
                        <option value="protein">🥩 Protein Sources</option>
                        <option value="vegetables">🥬 Vegetables</option>
                        <option value="fruits">🍎 Fruits</option>
                        <option value="grains">🌾 Grains & Starches</option>
                        <option value="legumes">🫘 Legumes</option>
                        <option value="dairy">🥛 Dairy & Alternatives</option>
                        <option value="nuts">🥜 Nuts & Seeds</option>
                        <option value="fats">🫒 Healthy Fats & Oils</option>
                        <option value="snacks">🍿 Snacks & Treats</option>
                        <option value="herbs">🌿 Herbs & Spices</option>
                        <option value="beverages">☕ Beverages</option>
                        <option value="arabic">🥙 Arabic & Middle Eastern</option>
                        <option value="egyptian">🏺 Egyptian Traditional</option>
                        <option value="arabic-spices">🌶️ Arabic Spices & Seasonings</option>
                        <option value="arabic-grains">🌾 Arabic Grains & Legumes</option>
                        <option value="arabic-fruits">🍯 Arabic Fruits & Sweets</option>
                        <option value="arabic-dairy">🧀 Arabic Dairy & Cheese</option>
                        <option value="arabic-beverages">🍵 Arabic Beverages</option>
                    </select>
                </div>
                <div id="foodList" class="food-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; max-height: 60vh; overflow-y: auto; padding: 0.5rem;">
                    <!-- Food items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- View Nutrition Plan Modal -->
    <div class="modal" id="viewNutritionPlanModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">View Nutrition Plan</h3>
                <button class="modal-close" onclick="closeModal('viewNutritionPlanModal')">&times;</button>
            </div>
            <div id="viewPlanContent">
                <!-- Plan details will be dynamically inserted here -->
            </div>
            <div class="action-buttons" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-primary" onclick="editNutritionPlanFromView()">
                    <i class="fas fa-edit"></i> Edit Plan
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('viewNutritionPlanModal')">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Create Exercise Modal -->
    <div class="modal" id="createExerciseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Exercise to Client</h3>
                <button class="modal-close" onclick="closeModal('createExerciseModal')">&times;</button>
            </div>
            <form id="createExerciseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="exerciseClientSelect">Select Client</label>
                        <select id="exerciseClientSelect" required>
                            <option value="">Choose a client...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exerciseName">Exercise Name</label>
                        <input type="text" id="exerciseName" placeholder="e.g., Push-ups, Bench Press, Bicep Curls" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="workoutSplit">Workout Split</label>
                        <select id="workoutSplit" required onchange="updateExerciseCategories()">
                            <option value="">Select Workout Split</option>
                            <option value="push-pull-legs">Push Pull Legs (3 Days)</option>
                            <option value="arnold-split">Arnold Split (4 Days)</option>
                            <option value="bro-split">Bro Split (5-6 Days)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exerciseCategory">Exercise Category</label>
                        <select id="exerciseCategory" required>
                            <option value="">Select Workout Split First</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="exerciseVideo">Video File Name(s)</label>
                        <div style="position: relative;">
                            <input type="text" id="exerciseVideo" placeholder="Start typing to search videos..." autocomplete="off">
                            <div id="videoAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);"></div>
                        </div>
                        <div id="selectedVideos" style="margin-top: 0.5rem;"></div>
                        <div style="margin-top: 0.5rem;">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVideoToList()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                <i class="fas fa-plus"></i> Add Video
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearVideoList()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-left: 0.5rem;">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                        <small style="color: #6b7280; font-size: 0.875rem;">Add multiple videos for different angles or variations. At least one video is required.</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="exerciseSets">Number of Sets</label>
                        <input type="number" id="exerciseSets" min="1" max="20" value="3" required>
                    </div>
                    <div class="form-group">
                        <label for="exerciseReps">Reps per Set</label>
                        <input type="number" id="exerciseReps" min="1" max="100" value="12" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="exerciseDescription">Exercise Description</label>
                    <textarea id="exerciseDescription" rows="3" placeholder="Describe the exercise, proper form, and any special instructions..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="exerciseNotes">Additional Notes</label>
                    <textarea id="exerciseNotes" rows="2" placeholder="Any additional notes for the client..."></textarea>
                </div>

                <div class="action-buttons" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Add Exercise
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createExerciseModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Exercise Modal -->
    <div class="modal" id="viewExerciseModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Exercise Details</h3>
                <button class="modal-close" onclick="closeModal('viewExerciseModal')">&times;</button>
            </div>
            <div id="viewExerciseContent">
                <!-- Exercise details will be dynamically inserted here -->
            </div>
            <div class="action-buttons" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-primary" onclick="editExerciseFromView()">
                    <i class="fas fa-edit"></i> Edit Exercise
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('viewExerciseModal')">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Exercise Modal -->
    <div class="modal" id="editExerciseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Exercise</h3>
                <button class="modal-close" onclick="closeModal('editExerciseModal')">&times;</button>
            </div>
            <form id="editExerciseForm">
                <input type="hidden" id="editExerciseId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editExerciseName">Exercise Name</label>
                        <input type="text" id="editExerciseName" required>
                    </div>
                    <div class="form-group">
                        <label for="editWorkoutSplit">Workout Split</label>
                        <select id="editWorkoutSplit" required onchange="updateEditExerciseCategories()">
                            <option value="">Select Workout Split</option>
                            <option value="push-pull-legs">Push Pull Legs (3 Days)</option>
                            <option value="arnold-split">Arnold Split (4 Days)</option>
                            <option value="bro-split">Bro Split (5-6 Days)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editExerciseCategory">Exercise Category</label>
                        <select id="editExerciseCategory" required>
                            <option value="">Select Workout Split First</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editExerciseVideo">Video File Name(s)</label>
                        <div style="position: relative;">
                            <input type="text" id="editExerciseVideo" placeholder="Start typing to search videos..." autocomplete="off">
                            <div id="editVideoAutocomplete" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);"></div>
                        </div>
                        <div id="editSelectedVideos" style="margin-top: 0.5rem;"></div>
                        <div style="margin-top: 0.5rem;">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditVideoToList()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                <i class="fas fa-plus"></i> Add Video
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearEditVideoList()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-left: 0.5rem;">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                        <small style="color: #6b7280; font-size: 0.875rem;">Add multiple videos for different angles or variations. At least one video is required.</small>
                    </div>
                    <div class="form-group">
                        <label for="editExerciseStatus">Status</label>
                        <select id="editExerciseStatus" required>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="paused">Paused</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editExerciseSets">Number of Sets</label>
                        <input type="number" id="editExerciseSets" min="1" max="20" required>
                    </div>
                    <div class="form-group">
                        <label for="editExerciseReps">Reps per Set</label>
                        <input type="number" id="editExerciseReps" min="1" max="100" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editExerciseDescription">Exercise Description</label>
                    <textarea id="editExerciseDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editExerciseNotes">Additional Notes</label>
                    <textarea id="editExerciseNotes" rows="2"></textarea>
                </div>
                <div class="action-buttons" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editExerciseModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Nutrition Plan Modal -->
    <div class="modal" id="editNutritionPlanModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Nutrition Plan</h3>
                <button class="modal-close" onclick="closeModal('editNutritionPlanModal')">&times;</button>
            </div>
            <form id="editNutritionPlanForm">
                <input type="hidden" id="editPlanId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPlanName">Plan Name</label>
                        <input type="text" id="editPlanName" required>
                    </div>
                    <div class="form-group">
                        <label for="editDailyCalories">Daily Calories</label>
                        <input type="number" id="editDailyCalories" min="800" max="5000" step="50" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editDailyProtein">Daily Protein (g)</label>
                        <input type="number" id="editDailyProtein" min="20" max="300" step="5" required>
                    </div>
                    <div class="form-group">
                        <label for="editDailyCarbs">Daily Carbs (g)</label>
                        <input type="number" id="editDailyCarbs" min="20" max="500" step="5" required>
                    </div>
                    <div class="form-group">
                        <label for="editDailyFat">Daily Fat (g)</label>
                        <input type="number" id="editDailyFat" min="10" max="150" step="5" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editPlanDescription">Plan Description</label>
                    <textarea id="editPlanDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editPlanNotes">Additional Notes</label>
                    <textarea id="editPlanNotes" rows="3"></textarea>
                </div>
                <div id="editMealPlanContainer">
                    <!-- Meal sections will be dynamically inserted here -->
                </div>
                <div class="action-buttons" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editNutritionPlanModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase collections
        const CONSULTATIONS_COLLECTION = "consultations";
        const NUTRITION_PLANS_COLLECTION = "nutritionPlans";
        const CLIENTS_COLLECTION = "clients";
        const EXERCISES_COLLECTION = "exercises";
        
        // Global variables
        let consultations = [];
        let nutritionPlans = [];
        let clients = [];
        let exercises = [];
        let currentConsultationId = null;
        let currentSection = 'dashboard';
        let currentMealType = '';
        let selectedFood = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Firebase is ready
            if (window.onAuthStateChanged && window.auth) {
                window.onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        // Check if user is admin
                        if (user.email === 'admin@fitcoach.com' || user.email.endsWith('@fitcoach.com')) {
                            showDashboard();
                            loadDashboardData();
                            setupNavigation();
                        } else {
                            showLogin();
                            showError('Access denied. Admin privileges required.');
                        }
                    } else {
                        showLogin();
                    }
                });
            } else {
                console.error('Firebase Auth not ready');
                showError('Firebase not ready. Please refresh the page.');
            }
        });

        // Setup navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    switchSection(section);
                });
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await window.signOut(window.auth);
                    showLogin();
                } catch (error) {
                    console.error('Logout error:', error);
                    showError('Failed to logout. Please try again.');
                }
            });
        }

        function switchSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => {
                s.style.display = 'none';
            });

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section and activate nav link
            document.getElementById(section + 'Section').style.display = 'block';
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            currentSection = section;

            // Load data for the section
            setTimeout(() => {
                switch(section) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'consultations':
                        loadConsultations();
                        break;
                    case 'clients':
                        loadClients();
                        break;
                    case 'nutrition':
                        loadNutritionPlans();
                        break;
                    case 'exercises':
                        loadExercises();
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                }
            }, 500);
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            try {
                await window.signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please check your credentials.');
            }
        });

        // Nutrition plan form handler
        document.getElementById('nutritionPlanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const clientId = document.getElementById('nutritionClientSelect').value;
            const planName = document.getElementById('planName').value;
            const dailyCalories = parseInt(document.getElementById('dailyCalories').value);
            const dailyProtein = parseInt(document.getElementById('dailyProtein').value);
            const dailyCarbs = parseInt(document.getElementById('dailyCarbs').value);
            const dailyFat = parseInt(document.getElementById('dailyFat').value);
            const planDescription = document.getElementById('planDescription').value;
            const planNotes = document.getElementById('planNotes').value;

            // Get client name
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showError('Client not found. Please try again.');
                return;
            }

            // Debug: Log client data to verify UID is available
            console.log('Selected client:', client);

            // Collect multi-day meal plan data
            saveCurrentDayData(); // Save current day before submission
            const mealPlan = collectMultiDayMealPlan();

            try {
                await window.addDoc(window.collection(window.db, NUTRITION_PLANS_COLLECTION), {
                    clientId: clientId,
                    clientUid: client.uid, // Add the Firebase Auth UID for querying by client dashboard
                    clientName: client.name,
                    clientEmail: client.email,
                    planName: planName,
                    dailyCalories: dailyCalories,
                    dailyProtein: dailyProtein,
                    dailyCarbs: dailyCarbs,
                    dailyFat: dailyFat,
                    planDescription: planDescription,
                    mealPlan: mealPlan,
                    planNotes: planNotes,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });

                closeModal('nutritionPlanModal');
                showSuccess('Nutrition plan created successfully!');
                
                // Refresh nutrition plans if on nutrition section
                if (currentSection === 'nutrition') {
                    loadNutritionPlans();
                }
            } catch (error) {
                console.error('Error creating nutrition plan:', error);
                showError('Failed to create nutrition plan. Please try again.');
            }
        });

        // Exercise form handler
        document.getElementById('createExerciseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const clientId = document.getElementById('exerciseClientSelect').value;
            const exerciseName = document.getElementById('exerciseName').value;
            const workoutSplit = document.getElementById('workoutSplit').value;
            const category = document.getElementById('exerciseCategory').value;
            const videoFiles = selectedVideos.length > 0 ? selectedVideos : [document.getElementById('exerciseVideo').value.trim()].filter(v => v);
            
            if (videoFiles.length === 0) {
                showError('Please add at least one video file.');
                return;
            }
            const sets = parseInt(document.getElementById('exerciseSets').value);
            const reps = parseInt(document.getElementById('exerciseReps').value);
            const description = document.getElementById('exerciseDescription').value;
            const notes = document.getElementById('exerciseNotes').value;

            // Get client name
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showError('Client not found. Please try again.');
                return;
            }

            try {
                await window.addDoc(window.collection(window.db, EXERCISES_COLLECTION), {
                    clientId: clientId,
                    clientUid: client.uid,
                    clientName: client.name,
                    clientEmail: client.email,
                    exerciseName: exerciseName,
                    workoutSplit: workoutSplit,
                    category: category,
                    videoFiles: videoFiles,
                    sets: sets,
                    reps: reps,
                    description: description,
                    notes: notes,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });

                closeModal('createExerciseModal');
                showSuccess('Exercise added successfully!');
                
                // Refresh exercises if on exercises section
                if (currentSection === 'exercises') {
                    loadExercises();
                }
            } catch (error) {
                console.error('Error creating exercise:', error);
                showError('Failed to create exercise. Please try again.');
            }
        });

        // Data loading functions
        async function loadDashboardData() {
            try {
                // Load consultations
                const consultationsSnapshot = await window.getDocs(window.collection(window.db, CONSULTATIONS_COLLECTION));
                consultations = [];
                consultationsSnapshot.forEach((doc) => {
                    consultations.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Load nutrition plans
                const nutritionPlansSnapshot = await window.getDocs(window.collection(window.db, NUTRITION_PLANS_COLLECTION));
                nutritionPlans = [];
                nutritionPlansSnapshot.forEach((doc) => {
                    nutritionPlans.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateDashboardStats();
                renderConsultationsTable();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data. Please try again.');
            }
        }
        
        async function loadConsultations() {
            try {
                console.log('[DEBUG] Loading consultations and orders...');
                
                let allItems = [];
                
                // Load consultations collection
                try {
                    console.log('[DEBUG] Loading consultations collection...');
                const consultationsSnapshot = await window.getDocs(window.collection(window.db, CONSULTATIONS_COLLECTION));
                consultationsSnapshot.forEach((doc) => {
                        allItems.push({
                        id: doc.id,
                            collection: 'consultations',
                        ...doc.data()
                    });
                });
                    console.log('[DEBUG] Loaded consultations:', consultationsSnapshot.size);
            } catch (error) {
                console.error('[ERROR] Error loading consultations:', error);
                }
                
                // Load orders collection
                try {
                    console.log('[DEBUG] Loading orders collection...');
                    const ordersSnapshot = await window.getDocs(window.collection(window.db, "orders"));
                    ordersSnapshot.forEach((doc) => {
                        allItems.push({
                            id: doc.id,
                            collection: 'orders',
                            ...doc.data()
                        });
                    });
                    console.log('[DEBUG] Loaded orders:', ordersSnapshot.size);
                } catch (error) {
                    console.error('[ERROR] Error loading orders:', error);
                    // Orders collection might not exist yet, that's okay
                }
                
                // Sort by timestamp (newest first)
                allItems.sort((a, b) => {
                    const timestampA = new Date(a.timestamp || a.createdAt || 0);
                    const timestampB = new Date(b.timestamp || b.createdAt || 0);
                    return timestampB - timestampA;
                });
                
                consultations = allItems;
                console.log('[DEBUG] Total items loaded:', consultations.length);
                renderConsultationsTable();
            } catch (error) {
                console.error('[ERROR] Error loading consultations and orders:', error);
                showError('Failed to load consultations and orders. ' + (error && error.message ? error.message : 'Please try again.'));
            }
        }
        
        async function loadClients() {
            try {
                const clientsSnapshot = await window.getDocs(window.collection(window.db, CLIENTS_COLLECTION));
                clients = [];
                clientsSnapshot.forEach((doc) => {
                    clients.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderClientsTable();
            } catch (error) {
                console.error('Error loading clients:', error);
                showError('Failed to load clients. Please try again.');
            }
        }
        
        async function loadNutritionPlans() {
            try {
                const nutritionPlansSnapshot = await window.getDocs(window.collection(window.db, NUTRITION_PLANS_COLLECTION));
                nutritionPlans = [];
                nutritionPlansSnapshot.forEach((doc) => {
                    nutritionPlans.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateNutritionStats();
                renderNutritionTable();
            } catch (error) {
                console.error('Error loading nutrition plans:', error);
                showError('Failed to load nutrition plans. Please try again.');
            }
        }

        async function loadExercises() {
            try {
                const exercisesSnapshot = await window.getDocs(window.collection(window.db, EXERCISES_COLLECTION));
                exercises = [];
                exercisesSnapshot.forEach((doc) => {
                    exercises.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateExerciseStats();
                renderExercisesTable();
            } catch (error) {
                console.error('Error loading exercises:', error);
                showError('Failed to load exercises. Please try again.');
            }
        }

        // Global orders array
        let orders = [];

        async function loadOrders() {
            try {
                console.log('[DEBUG] Loading orders from orders collection...');
                const ordersSnapshot = await window.getDocs(window.collection(window.db, 'orders'));
                orders = [];
                ordersSnapshot.forEach((doc) => {
                    orders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort orders by timestamp (newest first)
                orders.sort((a, b) => {
                    const aTime = a.timestamp?.toDate?.() || new Date(a.timestamp) || new Date(0);
                    const bTime = b.timestamp?.toDate?.() || new Date(b.timestamp) || new Date(0);
                    return bTime - aTime;
                });
                
                console.log('[DEBUG] Loaded orders:', orders.length);
                
                // Initialize enhanced functionality
                initializeOrdersEnhancements();
                
                // Render based on current view
                const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
                if (currentView === 'table') {
                    renderOrdersTable();
                } else {
                    renderOrdersCards();
                }
                
                updateOrdersStats();
            } catch (error) {
                console.error('Error loading orders:', error);
                showError('Failed to load orders.');
            }
        }

        // Enhanced orders functionality variables
        let filteredOrders = [];
        let currentOrdersPage = 1;
        let itemsPerPage = 25;
        let ordersSortField = 'timestamp';
        let ordersSortDirection = 'desc';
        let selectedOrders = [];

        function renderOrdersTable() {
            showLoadingState();
            
            setTimeout(() => {
                const tbody = document.getElementById('ordersTableBody');
                const emptyState = document.getElementById('ordersEmptyState');
                const tableView = document.getElementById('ordersTableView');
                
                if (!tbody) return;

                hideLoadingState();

                if (filteredOrders.length === 0) {
                    tableView.style.display = 'none';
                    emptyState.style.display = 'block';
                    updateOrdersCount(0);
                    return;
                }

                tableView.style.display = 'block';
                emptyState.style.display = 'none';

                // Calculate pagination
                const startIndex = (currentOrdersPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedOrders = filteredOrders.slice(startIndex, endIndex);

                tbody.innerHTML = paginatedOrders.map(order => {
                    const date = order.timestamp?.toDate?.() || new Date(order.timestamp) || new Date();
                    const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const statusBadge = getOrderStatusBadge(order.paymentStatus);
                    const itemsSummary = order.items?.map(item => 
                        `${item.serviceName} × ${item.quantity}`
                    ).join(', ') || 'N/A';

                    const actions = order.paymentStatus === 'pending' ? 
                        `<button class="btn btn-success btn-sm" onclick="confirmOrderPayment('${order.id}', '${order.customerName}', ${order.total}, '${order.paymentMethod}')" title="Confirm Payment">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="viewOrderDetails('${order.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}', '${order.customerName}')" title="Delete Order">
                            <i class="fas fa-trash"></i>
                        </button>` : 
                        `<span style="color: #10b981; font-size: 0.875rem;">
                            <i class="fas fa-check-circle"></i> Confirmed
                        </span>
                        <button class="btn btn-outline btn-sm" onclick="viewOrderDetails('${order.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}', '${order.customerName}')" title="Delete Order">
                            <i class="fas fa-trash"></i>
                        </button>`;

                    const isSelected = selectedOrders.includes(order.id);

                    return `
                        <tr class="${isSelected ? 'selected' : ''}" onclick="toggleOrderSelection('${order.id}', event)">
                            <td class="checkbox-column">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleOrderSelection('${order.id}', event)">
                            </td>
                            <td>
                                <div class="order-id">${order.id.substring(0, 8)}...</div>
                            </td>
                            <td>
                                <div class="customer-name">${order.customerName || 'N/A'}</div>
                                <div class="customer-email">${order.customerEmail || 'N/A'}</div>
                            </td>
                            <td>
                                <div class="order-total">$${order.total}</div>
                            </td>
                            <td>
                                <span class="payment-method-badge ${order.paymentMethod}">
                                    ${order.paymentMethod === 'instapay' ? '📱 InstaPay' : 
                                      order.paymentMethod === 'bank-transfer' ? '🏦 Bank Transfer' : 
                                      order.paymentMethod === 'cash' ? '💰 Cash' : order.paymentMethod || 'N/A'}
                                </span>
                            </td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="order-date">${formattedDate}</div>
                            </td>
                            <td class="actions-column" onclick="event.stopPropagation();">
                                ${actions}
                            </td>
                        </tr>
                    `;
                }).join('');

                updateOrdersCount(filteredOrders.length);
                updatePagination();
                updateBulkActions();
            }, 300); // Small delay for better UX
        }

        function renderOrdersCards() {
            const cardsGrid = document.getElementById('ordersCardsGrid');
            const emptyState = document.getElementById('ordersEmptyState');
            const cardsView = document.getElementById('ordersCardsView');
            
            if (!cardsGrid) return;

            if (filteredOrders.length === 0) {
                cardsView.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            cardsView.style.display = 'block';
            emptyState.style.display = 'none';

            // Calculate pagination for cards
            const startIndex = (currentOrdersPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedOrders = filteredOrders.slice(startIndex, endIndex);

            cardsGrid.innerHTML = paginatedOrders.map(order => {
                const date = order.timestamp?.toDate?.() || new Date(order.timestamp) || new Date();
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const statusBadge = getOrderStatusBadge(order.paymentStatus);
                const itemsSummary = order.items?.map(item => 
                    `${item.serviceName} × ${item.quantity}`
                ).join(', ') || 'N/A';

                const actions = order.paymentStatus === 'pending' ? 
                    `<button class="btn btn-success" onclick="confirmOrderPayment('${order.id}', '${order.customerName}', ${order.total}, '${order.paymentMethod}')">
                        <i class="fas fa-check"></i> Confirm Payment
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}', '${order.customerName}')" title="Delete Order">
                        <i class="fas fa-trash"></i>
                    </button>` : 
                    `<span style="color: #10b981; font-size: 0.875rem;">
                        <i class="fas fa-check-circle"></i> Payment Confirmed
                    </span>
                    <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}', '${order.customerName}')" title="Delete Order">
                        <i class="fas fa-trash"></i>
                    </button>`;

                return `
                    <div class="order-card" onclick="viewOrderDetails('${order.id}')">
                        <div class="order-card-header">
                            <div class="order-id">#${order.id.substring(0, 8)}</div>
                            ${statusBadge}
                        </div>
                        <div class="order-card-body">
                            <div class="customer-info">
                                <div class="customer-name">${order.customerName || 'N/A'}</div>
                                <div class="customer-email">${order.customerEmail || 'N/A'}</div>
                            </div>
                            <div class="order-items">${itemsSummary}</div>
                            <div class="order-total">$${order.total}</div>
                        </div>
                        <div class="order-card-footer">
                            <div class="order-date">${formattedDate}</div>
                            <div onclick="event.stopPropagation();">
                                ${actions}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateOrdersCount(filteredOrders.length);
            updatePagination();
        }

        function getOrderStatusBadge(status) {
            switch(status) {
                case 'pending':
                    return '<span class="status-badge status-new">⏳ Pending Payment</span>';
                case 'confirmed':
                    return '<span class="status-badge status-completed">✅ Payment Confirmed</span>';
                case 'cancelled':
                    return '<span class="status-badge status-cancelled">❌ Cancelled</span>';
                default:
                    return '<span class="status-badge status-new">❓ Unknown</span>';
            }
        }

        function updateOrdersStats() {
            const totalOrdersEl = document.getElementById('totalOrders');
            const pendingOrdersEl = document.getElementById('pendingOrders');
            const confirmedOrdersEl = document.getElementById('confirmedOrders');
            const totalRevenueEl = document.getElementById('totalRevenue');

            if (totalOrdersEl) totalOrdersEl.textContent = orders.length;
            
            const pendingCount = orders.filter(o => o.paymentStatus === 'pending').length;
            if (pendingOrdersEl) pendingOrdersEl.textContent = pendingCount;
            
            const confirmedCount = orders.filter(o => o.paymentStatus === 'confirmed').length;
            if (confirmedOrdersEl) confirmedOrdersEl.textContent = confirmedCount;
            
            const totalRevenue = orders
                .filter(o => o.paymentStatus === 'confirmed')
                .reduce((sum, o) => sum + (o.total || 0), 0);
            if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue}`;
        }

        function refreshOrdersData() {
            loadOrders();
        }

        function filterOrders() {
            const filter = document.getElementById('orderStatusFilter').value;
            const filteredOrders = filter ? orders.filter(order => order.paymentStatus === filter) : orders;
            
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;

            if (filteredOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: #6b7280;">
                            <i class="fas fa-filter" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <br>No orders match the selected filter
                        </td>
                    </tr>
                `;
                return;
            }

            // Re-render with filtered data
            const originalOrders = orders;
            orders = filteredOrders;
            renderOrdersTable();
            orders = originalOrders; // Restore original data
        }

        async function confirmOrderPayment(orderId, customerName, amount, paymentMethod) {
            if (!confirm(`Confirm payment of $${amount} from ${customerName} via ${paymentMethod}?`)) {
                return;
            }

            try {
                await window.updateDoc(window.doc(window.db, 'orders', orderId), {
                    paymentStatus: 'confirmed',
                    paymentConfirmedAt: new Date(),
                    paymentConfirmedBy: 'admin'
                });

                showSuccess(`Payment confirmed for order ${orderId.substring(0, 8)}! Customer will be notified.`);
                loadOrders(); // Refresh the table
            } catch (error) {
                console.error('Error confirming payment:', error);
                showError('Failed to confirm payment. Please try again.');
            }
        }

        // Enhanced Orders UI Functions
        function showLoadingState() {
            const loadingState = document.getElementById('ordersLoadingState');
            const tableView = document.getElementById('ordersTableView');
            const cardsView = document.getElementById('ordersCardsView');
            const emptyState = document.getElementById('ordersEmptyState');
            
            if (loadingState) loadingState.style.display = 'flex';
            if (tableView) tableView.style.display = 'none';
            if (cardsView) cardsView.style.display = 'none';
            if (emptyState) emptyState.style.display = 'none';
        }

        function hideLoadingState() {
            const loadingState = document.getElementById('ordersLoadingState');
            if (loadingState) loadingState.style.display = 'none';
        }

        function updateOrdersCount(count) {
            const ordersCount = document.getElementById('ordersCount');
            const ordersTableTitle = document.getElementById('ordersTableTitle');
            
            if (ordersCount) ordersCount.textContent = `(${count})`;
            
            // Update title based on active filters
            const statusFilter = document.getElementById('orderStatusFilter')?.value;
            const dateFilter = document.getElementById('dateRangeFilter')?.value;
            
            let title = 'All Orders';
            if (statusFilter) {
                title = statusFilter === 'pending' ? 'Pending Orders' : 
                       statusFilter === 'confirmed' ? 'Confirmed Orders' : 
                       statusFilter === 'cancelled' ? 'Cancelled Orders' : 'Filtered Orders';
            } else if (dateFilter) {
                title = dateFilter === 'today' ? 'Today\'s Orders' :
                       dateFilter === 'week' ? 'This Week\'s Orders' :
                       dateFilter === 'month' ? 'This Month\'s Orders' : 'Filtered Orders';
            }
            
            if (ordersTableTitle) ordersTableTitle.textContent = title;
        }

        // Search functionality
        function searchOrders() {
            const searchInput = document.getElementById('ordersSearchInput');
            const clearBtn = searchInput?.parentElement?.querySelector('.clear-search');
            const searchTerm = searchInput?.value?.toLowerCase().trim() || '';
            
            if (clearBtn) {
                clearBtn.style.display = searchTerm ? 'block' : 'none';
            }
            
            applyOrdersFilters();
        }

        function clearOrdersSearch() {
            const searchInput = document.getElementById('ordersSearchInput');
            const clearBtn = searchInput?.parentElement?.querySelector('.clear-search');
            
            if (searchInput) searchInput.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            
            applyOrdersFilters();
        }

        // Enhanced filtering
        function applyOrdersFilters() {
            const searchTerm = document.getElementById('ordersSearchInput')?.value?.toLowerCase().trim() || '';
            const statusFilter = document.getElementById('orderStatusFilter')?.value || '';
            const dateFilter = document.getElementById('dateRangeFilter')?.value || '';
            const paymentMethodFilter = document.getElementById('paymentMethodFilter')?.value || '';
            
            filteredOrders = orders.filter(order => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    order.customerName?.toLowerCase().includes(searchTerm) ||
                    order.customerEmail?.toLowerCase().includes(searchTerm) ||
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.items?.some(item => item.serviceName?.toLowerCase().includes(searchTerm));
                
                // Status filter
                const matchesStatus = !statusFilter || order.paymentStatus === statusFilter;
                
                // Payment method filter
                const matchesPaymentMethod = !paymentMethodFilter || order.paymentMethod === paymentMethodFilter;
                
                // Date filter
                let matchesDate = true;
                if (dateFilter) {
                    const orderDate = order.timestamp?.toDate?.() || new Date(order.timestamp) || new Date();
                    const now = new Date();
                    
                    switch(dateFilter) {
                        case 'today':
                            matchesDate = orderDate.toDateString() === now.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesDate = orderDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            matchesDate = orderDate >= monthAgo;
                            break;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesPaymentMethod && matchesDate;
            });
            
            // Apply sorting
            sortOrdersArray();
            
            // Reset to first page
            currentOrdersPage = 1;
            
            // Re-render
            const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
            if (currentView === 'table') {
                renderOrdersTable();
            } else {
                renderOrdersCards();
            }
        }

        function resetOrdersFilters() {
            // Clear all filters
            const searchInput = document.getElementById('ordersSearchInput');
            const statusFilter = document.getElementById('orderStatusFilter');
            const dateFilter = document.getElementById('dateRangeFilter');
            const paymentMethodFilter = document.getElementById('paymentMethodFilter');
            const clearBtn = document.querySelector('.clear-search');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (dateFilter) dateFilter.value = '';
            if (paymentMethodFilter) paymentMethodFilter.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            
            // Reset filtered orders to all orders
            filteredOrders = [...orders];
            sortOrdersArray();
            currentOrdersPage = 1;
            
            // Re-render
            const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
            if (currentView === 'table') {
                renderOrdersTable();
            } else {
                renderOrdersCards();
            }
        }

        // Sorting functionality
        function sortOrders(field) {
            if (ordersSortField === field) {
                ordersSortDirection = ordersSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                ordersSortField = field;
                ordersSortDirection = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.enhanced-table th.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const currentHeader = document.querySelector(`[onclick="sortOrders('${field}')"] i`);
            if (currentHeader) {
                currentHeader.className = ordersSortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            sortOrdersArray();
            
            const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
            if (currentView === 'table') {
                renderOrdersTable();
            } else {
                renderOrdersCards();
            }
        }

        function sortOrdersArray() {
            filteredOrders.sort((a, b) => {
                let aVal, bVal;
                
                switch(ordersSortField) {
                    case 'id':
                        aVal = a.id;
                        bVal = b.id;
                        break;
                    case 'customerName':
                        aVal = a.customerName || '';
                        bVal = b.customerName || '';
                        break;
                    case 'total':
                        aVal = a.total || 0;
                        bVal = b.total || 0;
                        break;
                    case 'paymentStatus':
                        aVal = a.paymentStatus || '';
                        bVal = b.paymentStatus || '';
                        break;
                    case 'timestamp':
                    default:
                        aVal = a.timestamp?.toDate?.() || new Date(a.timestamp) || new Date(0);
                        bVal = b.timestamp?.toDate?.() || new Date(b.timestamp) || new Date(0);
                        break;
                }
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (ordersSortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
        }

        // View switching
        function switchOrdersView(view) {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            const tableView = document.getElementById('ordersTableView');
            const cardsView = document.getElementById('ordersCardsView');
            
            if (view === 'table') {
                tableView.style.display = 'block';
                cardsView.style.display = 'none';
                renderOrdersTable();
            } else {
                tableView.style.display = 'none';
                cardsView.style.display = 'block';
                renderOrdersCards();
            }
        }

        // Selection functionality
        function toggleOrderSelection(orderId, event) {
            if (event) event.stopPropagation();
            
            const index = selectedOrders.indexOf(orderId);
            if (index > -1) {
                selectedOrders.splice(index, 1);
            } else {
                selectedOrders.push(orderId);
            }
            
            updateBulkActions();
            
            // Re-render to update selection state
            const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
            if (currentView === 'table') {
                renderOrdersTable();
            }
        }

        function toggleSelectAllOrders() {
            const selectAllCheckbox = document.getElementById('selectAllOrders');
            const isChecked = selectAllCheckbox?.checked;
            
            if (isChecked) {
                selectedOrders = filteredOrders.map(order => order.id);
            } else {
                selectedOrders = [];
            }
            
            updateBulkActions();
            renderOrdersTable();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.querySelector('.selected-count');
            const selectAllCheckbox = document.getElementById('selectAllOrders');
            
            if (selectedOrders.length > 0) {
                bulkActions.style.display = 'flex';
                selectedCount.textContent = `${selectedOrders.length} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
            
            // Update select all checkbox state
            if (selectAllCheckbox) {
                const visibleOrderIds = filteredOrders.slice(
                    (currentOrdersPage - 1) * itemsPerPage,
                    currentOrdersPage * itemsPerPage
                ).map(order => order.id);
                
                const allVisibleSelected = visibleOrderIds.length > 0 && 
                    visibleOrderIds.every(id => selectedOrders.includes(id));
                const someVisibleSelected = visibleOrderIds.some(id => selectedOrders.includes(id));
                
                selectAllCheckbox.checked = allVisibleSelected;
                selectAllCheckbox.indeterminate = someVisibleSelected && !allVisibleSelected;
            }
        }

        // Bulk actions
        async function bulkConfirmPayments() {
            const pendingOrders = selectedOrders.filter(orderId => {
                const order = orders.find(o => o.id === orderId);
                return order && order.paymentStatus === 'pending';
            });
            
            if (pendingOrders.length === 0) {
                showError('No pending orders selected for confirmation.');
                return;
            }
            
            if (!confirm(`Confirm payment for ${pendingOrders.length} selected orders?`)) {
                return;
            }
            
            try {
                const updatePromises = pendingOrders.map(orderId => 
                    window.updateDoc(window.doc(window.db, 'orders', orderId), {
                        paymentStatus: 'confirmed',
                        paymentConfirmedAt: new Date(),
                        paymentConfirmedBy: 'admin'
                    })
                );
                
                await Promise.all(updatePromises);
                
                showSuccess(`${pendingOrders.length} payments confirmed successfully!`);
                selectedOrders = [];
                loadOrders();
            } catch (error) {
                console.error('Error confirming bulk payments:', error);
                showError('Failed to confirm some payments. Please try again.');
            }
        }

        // Individual order deletion
        async function deleteOrder(orderId, customerName) {
            // Double confirmation for safety
            const confirmMessage = `⚠️ WARNING: This will permanently delete the order from ${customerName}.

Order ID: ${orderId.substring(0, 8)}...

This action CANNOT be undone. Are you absolutely sure?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Second confirmation with typing requirement for extra safety
            const secondConfirmation = prompt(`To confirm deletion, please type "DELETE" (in capital letters):`);
            
            if (secondConfirmation !== 'DELETE') {
                showError('Order deletion cancelled. You must type "DELETE" exactly to confirm.');
                return;
            }

            try {
                // Delete the order document from Firestore
                await window.deleteDoc(window.doc(window.db, 'orders', orderId));

                showSuccess(`Order ${orderId.substring(0, 8)} has been permanently deleted.`);
                
                // Remove from selected orders if it was selected
                const index = selectedOrders.indexOf(orderId);
                if (index > -1) {
                    selectedOrders.splice(index, 1);
                }
                
                // Refresh the orders list
                loadOrders();
            } catch (error) {
                console.error('Error deleting order:', error);
                showError('Failed to delete order. Please try again.');
            }
        }

        // Bulk orders deletion
        async function bulkDeleteOrders() {
            if (selectedOrders.length === 0) {
                showError('No orders selected for deletion.');
                return;
            }
            
            // Get order details for confirmation
            const selectedOrderDetails = selectedOrders.map(orderId => {
                const order = orders.find(o => o.id === orderId);
                return order ? `• ${order.customerName || 'Unknown'} - $${order.total || 0}` : `• Order ${orderId.substring(0, 8)}`;
            }).join('\n');

            const confirmMessage = `⚠️ WARNING: You are about to permanently delete ${selectedOrders.length} orders:

${selectedOrderDetails}

This action CANNOT be undone. Are you absolutely sure?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Second confirmation with typing requirement for extra safety
            const secondConfirmation = prompt(`To confirm bulk deletion of ${selectedOrders.length} orders, please type "DELETE ALL" (in capital letters):`);
            
            if (secondConfirmation !== 'DELETE ALL') {
                showError('Bulk deletion cancelled. You must type "DELETE ALL" exactly to confirm.');
                return;
            }
            
            try {
                // Delete all selected orders
                const deletePromises = selectedOrders.map(orderId => 
                    window.deleteDoc(window.doc(window.db, 'orders', orderId))
                );
                
                await Promise.all(deletePromises);
                
                showSuccess(`${selectedOrders.length} orders have been permanently deleted.`);
                selectedOrders = [];
                loadOrders();
            } catch (error) {
                console.error('Error deleting bulk orders:', error);
                showError('Failed to delete some orders. Please try again.');
            }
        }

        // Pagination
        function updatePagination() {
            const totalItems = filteredOrders.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentOrdersPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentOrdersPage * itemsPerPage, totalItems);
            
            // Update pagination info
            document.getElementById('paginationStart').textContent = totalItems > 0 ? startIndex : 0;
            document.getElementById('paginationEnd').textContent = endIndex;
            document.getElementById('paginationTotal').textContent = totalItems;
            
            // Update pagination controls
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentOrdersPage <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentOrdersPage >= totalPages;
            }
            
            // Update page numbers
            updatePageNumbers(totalPages);
        }

        function updatePageNumbers(totalPages) {
            const pageNumbers = document.getElementById('pageNumbers');
            if (!pageNumbers) return;
            
            let pages = [];
            const maxVisiblePages = 5;
            
            if (totalPages <= maxVisiblePages) {
                for (let i = 1; i <= totalPages; i++) {
                    pages.push(i);
                }
            } else {
                const startPage = Math.max(1, currentOrdersPage - 2);
                const endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                for (let i = startPage; i <= endPage; i++) {
                    pages.push(i);
                }
                
                if (startPage > 1) {
                    pages.unshift('...');
                    pages.unshift(1);
                }
                
                if (endPage < totalPages) {
                    pages.push('...');
                    pages.push(totalPages);
                }
            }
            
            pageNumbers.innerHTML = pages.map(page => {
                if (page === '...') {
                    return '<span class="page-ellipsis">...</span>';
                }
                
                const isActive = page === currentOrdersPage;
                return `<button class="page-number ${isActive ? 'active' : ''}" onclick="goToOrdersPage(${page})">${page}</button>`;
            }).join('');
        }

        function goToOrdersPage(page) {
            currentOrdersPage = page;
            const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
            if (currentView === 'table') {
                renderOrdersTable();
            } else {
                renderOrdersCards();
            }
        }

        function previousOrdersPage() {
            if (currentOrdersPage > 1) {
                currentOrdersPage--;
                const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
                if (currentView === 'table') {
                    renderOrdersTable();
                } else {
                    renderOrdersCards();
                }
            }
        }

        function nextOrdersPage() {
            const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            if (currentOrdersPage < totalPages) {
                currentOrdersPage++;
                const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
                if (currentView === 'table') {
                    renderOrdersTable();
                } else {
                    renderOrdersCards();
                }
            }
        }

        function changeItemsPerPage() {
            const select = document.getElementById('itemsPerPage');
            itemsPerPage = parseInt(select.value);
            currentOrdersPage = 1;
            
            const currentView = document.querySelector('.view-btn.active')?.dataset?.view || 'table';
            if (currentView === 'table') {
                renderOrdersTable();
            } else {
                renderOrdersCards();
            }
        }

        // Additional features
        function refreshOrdersTable() {
            showLoadingState();
            setTimeout(() => {
                loadOrders();
            }, 500);
        }

        function exportOrders() {
            try {
                const dataToExport = filteredOrders.map(order => ({
                    'Order ID': order.id,
                    'Customer Name': order.customerName || '',
                    'Customer Email': order.customerEmail || '',
                    'Items': order.items?.map(item => `${item.serviceName} × ${item.quantity}`).join(', ') || '',
                    'Total': order.total || 0,
                    'Payment Method': order.paymentMethod || '',
                    'Payment Status': order.paymentStatus || '',
                    'Date': (order.timestamp?.toDate?.() || new Date(order.timestamp) || new Date()).toLocaleString()
                }));
                
                const csv = convertToCSV(dataToExport);
                downloadCSV(csv, `orders-export-${new Date().toISOString().split('T')[0]}.csv`);
                
                showSuccess('Orders exported successfully!');
            } catch (error) {
                console.error('Error exporting orders:', error);
                showError('Failed to export orders. Please try again.');
            }
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Create and show order details modal
            showOrderDetailsModal(order);
        }

        function toggleColumnsMenu() {
            // Placeholder for column customization feature
            showSuccess('Column customization coming soon!');
        }

        // Initialize enhanced orders functionality
        function initializeOrdersEnhancements() {
            // Set initial filtered orders
            filteredOrders = [...orders];
            sortOrdersArray();
        }

        // Order details modal placeholder
        function showOrderDetailsModal(order) {
            const date = order.timestamp?.toDate?.() || new Date(order.timestamp) || new Date();
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            
            const itemsList = order.items?.map(item => 
                `• ${item.serviceName} × ${item.quantity} = $${item.price * item.quantity}`
            ).join('\n') || 'No items';
            
            const paymentInfo = order.paymentConfirmedAt ? 
                `Payment confirmed on ${new Date(order.paymentConfirmedAt).toLocaleDateString()} by ${order.paymentConfirmedBy || 'admin'}` :
                'Payment not yet confirmed';
            
            const details = `Order Details: #${order.id}

Customer Information:
• Name: ${order.customerName || 'N/A'}
• Email: ${order.customerEmail || 'N/A'}
• Phone: ${order.customerPhone || 'N/A'}

Order Items:
${itemsList}

Payment Information:
• Total: $${order.total}
• Method: ${order.paymentMethod || 'N/A'}
• Status: ${order.paymentStatus || 'N/A'}
• ${paymentInfo}

Order Date: ${formattedDate}`;
            
            alert(details);
        }
        
        // Stats and rendering functions
        function updateDashboardStats() {
            const total = consultations.length;
            const newCount = consultations.filter(c => c.status === 'new').length;
            const scheduledCount = consultations.filter(c => c.status === 'scheduled').length;
            const completedCount = consultations.filter(c => c.status === 'completed').length;
            
            // Calculate changes (dummy values for demo)
            const consultationsChange = Math.round(Math.random() * 15);
            const newChange = Math.round(Math.random() * 10);
            const scheduledChange = Math.round(Math.random() * 20);
            const completedChange = Math.round(Math.random() * 15);

            document.getElementById('totalConsultations').textContent = total;
            document.getElementById('newConsultations').textContent = newCount;
            document.getElementById('scheduledConsultations').textContent = scheduledCount;
            document.getElementById('completedConsultations').textContent = completedCount;
            
            document.getElementById('consultationsChange').textContent = consultationsChange + '%';
            document.getElementById('newChange').textContent = newChange + '%';
            document.getElementById('scheduledChange').textContent = scheduledChange + '%';
            document.getElementById('completedChange').textContent = completedChange + '%';
        }
        
        function updateNutritionStats() {
            const total = nutritionPlans.length;
            const active = nutritionPlans.filter(p => p.status === 'active').length;
            const completed = nutritionPlans.filter(p => p.status === 'completed').length;
            
            // Calculate changes (dummy values for demo)
            const plansChange = Math.round(Math.random() * 8);
            const activeChange = Math.round(Math.random() * 15);
            const newPlansChange = Math.round(Math.random() * 5);
            const completedPlansChange = Math.round(Math.random() * 10);

            document.getElementById('totalNutritionPlans').textContent = total;
            document.getElementById('activeNutritionPlans').textContent = active;
            document.getElementById('completedNutritionPlans').textContent = completed;
            
            document.getElementById('plansChange').textContent = plansChange + '%';
            document.getElementById('activeChange').textContent = activeChange + '%';
            document.getElementById('newPlansChange').textContent = newPlansChange + '%';
            document.getElementById('completedPlansChange').textContent = completedPlansChange + '%';
        }
        
        function renderConsultationsTable() {
            try {
                const tbody = document.getElementById('consultationsTableBody');
                if (!tbody) {
                    console.error('[ERROR] consultationsTableBody element not found!');
                    showError('Consultations table not found in the DOM.');
                    return;
                }
                const statusFilter = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : '';
                let filteredConsultations = consultations;
                if (statusFilter) {
                    filteredConsultations = consultations.filter(c => c.status === statusFilter);
                }
                tbody.innerHTML = '';
                if (!Array.isArray(filteredConsultations)) {
                    console.error('[ERROR] filteredConsultations is not an array:', filteredConsultations);
                    showError('Consultations data is invalid.');
                    return;
                }
                if (filteredConsultations.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="7" style="text-align:center; color:#888;">No consultations found.</td>';
                    tbody.appendChild(row);
                } else {
                    filteredConsultations.slice(0, 5).forEach(consultation => {
                        const row = document.createElement('tr');
                        
                        // Determine service display
                        const serviceType = consultation.serviceType || 'free-consultation';
                        const servicePrice = consultation.servicePrice || consultation.total || 0;
                        const isCoachingOrder = consultation.type === 'coaching-program-order';
                        let serviceDisplay = '';
                        
                        if (isCoachingOrder) {
                            // Coaching program order
                            const itemSummary = consultation.items?.map(item => 
                                `${item.serviceName} × ${item.quantity}`
                            ).join('<br>') || 'Coaching Programs';
                            serviceDisplay = `<div style="color: #7c3aed;">
                                <strong>🏋️ Coaching Order</strong><br>
                                <small>${itemSummary}</small>
                            </div>`;
                        } else if (serviceType === 'free-consultation') {
                            serviceDisplay = '<span style="color: #10b981;">Free Consultation</span>';
                        } else if (serviceType === 'nutrition-plan') {
                            serviceDisplay = `<span style="color: #3b82f6;">Nutrition Plan</span><br><small>${servicePrice} EGP</small>`;
                        } else if (serviceType === 'full-program') {
                            serviceDisplay = `<span style="color: #8b5cf6;">Full Program</span><br><small>${servicePrice} EGP</small>`;
                        }
                        
                        // Determine payment display
                        const paymentStatus = consultation.paymentStatus || 'not-required';
                        const paymentMethod = consultation.paymentMethod || '';
                        let paymentDisplay = '';
                        
                        if (paymentStatus === 'not-required') {
                            paymentDisplay = '<span style="color: #6b7280;">Free Service</span>';
                        } else if (paymentStatus === 'pending') {
                            const currency = isCoachingOrder ? '$' : 'EGP';
                            paymentDisplay = `<span class="status-badge" style="background: #fef3c7; color: #d97706;">Pending</span><br><small>${paymentMethod}</small><br><small>${currency}${servicePrice}</small>`;
                        } else if (paymentStatus === 'confirmed') {
                            const currency = isCoachingOrder ? '$' : 'EGP';
                            paymentDisplay = `<span class="status-badge" style="background: #d1fae5; color: #059669;">Confirmed</span><br><small>${paymentMethod}</small><br><small>${currency}${servicePrice}</small>`;
                        } else if (paymentStatus === 'required') {
                            paymentDisplay = '<span style="color: #dc2626;">Payment Required</span>';
                        }
                        
                        row.innerHTML = `
                            <td>${consultation.name || 'N/A'}</td>
                            <td>${consultation.email || 'N/A'}</td>
                            <td>${serviceDisplay}</td>
                            <td>${paymentDisplay}</td>
                            <td><span class="status-badge status-${consultation.status || 'new'}">${consultation.status || 'new'}</span></td>
                            <td>${consultation.createdAt ? new Date(consultation.createdAt).toLocaleDateString() : consultation.timestamp ? new Date(consultation.timestamp).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-view" onclick="viewConsultation('${consultation.id}')">View</button>
                                    ${paymentStatus === 'pending' ? 
                                        `<button class="btn btn-success" onclick="confirmPayment('${consultation.id}', '${consultation.customerName || consultation.name}', '${servicePrice}', '${paymentMethod}', ${isCoachingOrder})">Confirm Payment</button>` 
                                        : ''
                                    }
                                    <button class="btn btn-update" onclick="updateStatus('${consultation.id}')">Update</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                console.log('[DEBUG] Consultations table rendered.');
            } catch (error) {
                console.error('[ERROR] Error rendering consultations table:', error);
                showError('Failed to render consultations table. ' + (error && error.message ? error.message : ''));
            }
        }
        
        function renderNutritionTable() {
            const tbody = document.getElementById('nutritionTableBody');
            const statusFilter = document.getElementById('nutritionStatusFilter').value;
            
            let filteredPlans = nutritionPlans;
            if (statusFilter) {
                filteredPlans = nutritionPlans.filter(p => p.status === statusFilter);
            }

            tbody.innerHTML = '';
            
            filteredPlans.forEach(plan => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${plan.clientName || 'N/A'}</td>
                    <td>${plan.planName || 'N/A'}</td>
                    <td>${plan.dailyCalories || 'N/A'} cal</td>
                    <td>${plan.dailyProtein || 'N/A'}g</td>
                    <td><span class="status-badge status-${plan.status || 'active'}">${plan.status || 'active'}</span></td>
                    <td>${new Date(plan.createdAt).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewNutritionPlan('${plan.id}')">View</button>
                            <button class="btn btn-update" onclick="editNutritionPlan('${plan.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteNutritionPlan('${plan.id}', '${plan.planName}', '${plan.clientName}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function deleteClient(clientId, clientName, clientEmail) {
            const confirmMessage = `Are you sure you want to delete this client?

👤 Client: ${clientName}
📧 Email: ${clientEmail}

⚠️ This action will also delete:
• All exercises assigned to this client
• All consultations for this client
• All nutrition plans for this client

⚠️ This action cannot be undone!`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const deleteButtons = document.querySelectorAll(`[onclick*="deleteClient('${clientId}',"]`);
                deleteButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                });

                // Delete client's exercises first
                const exercisesSnapshot = await window.getDocs(
                    window.query(window.collection(window.db, EXERCISES_COLLECTION), 
                    window.where('clientId', '==', clientId))
                );
                
                const exerciseDeletePromises = exercisesSnapshot.docs.map(doc => 
                    window.deleteDoc(window.doc(window.db, EXERCISES_COLLECTION, doc.id))
                );
                await Promise.all(exerciseDeletePromises);

                // Delete client's consultations
                const consultationsSnapshot = await window.getDocs(
                    window.query(window.collection(window.db, CONSULTATIONS_COLLECTION), 
                    window.where('clientId', '==', clientId))
                );
                
                const consultationDeletePromises = consultationsSnapshot.docs.map(doc => 
                    window.deleteDoc(window.doc(window.db, CONSULTATIONS_COLLECTION, doc.id))
                );
                await Promise.all(consultationDeletePromises);

                // Delete client's nutrition plans
                const nutritionPlansSnapshot = await window.getDocs(
                    window.query(window.collection(window.db, NUTRITION_PLANS_COLLECTION), 
                    window.where('clientId', '==', clientId))
                );
                
                const nutritionPlanDeletePromises = nutritionPlansSnapshot.docs.map(doc => 
                    window.deleteDoc(window.doc(window.db, NUTRITION_PLANS_COLLECTION, doc.id))
                );
                await Promise.all(nutritionPlanDeletePromises);

                // Finally, delete the client
                await window.deleteDoc(window.doc(window.db, CLIENTS_COLLECTION, clientId));

                showSuccess(`✅ Client "${clientName}" and all associated data deleted successfully!`);
                
                // Refresh data
                await loadClients();
                await loadExercises();
                await loadConsultations();
                await loadNutritionPlans();

            } catch (error) {
                console.error('Error deleting client:', error);
                showError('❌ Failed to delete client. Please try again.');

                const deleteButtons = document.querySelectorAll(`[onclick*="deleteClient('${clientId}',"]`);
                deleteButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                });
            }
        }

        function renderClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            clients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.name || 'N/A'}</td>
                    <td>${client.email || 'N/A'}</td>
                    <td>${client.phone || 'N/A'}</td>
                    <td>${client.createdAt ? new Date(client.createdAt).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="alert('Client: ${client.name || ''}\nEmail: ${client.email || ''}\nPhone: ${client.phone || ''}');">View</button>
                            <button class="btn btn-danger" onclick="deleteClient('${client.id}', '${client.name || 'Unknown'}', '${client.email || 'Unknown'}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderExercisesTable() {
            const tbody = document.getElementById('exercisesTableBody');
            const statusFilter = document.getElementById('exerciseStatusFilter').value;
            const categoryFilter = document.getElementById('exerciseCategoryFilter').value;
            
            let filteredExercises = exercises;
            if (statusFilter) {
                filteredExercises = exercises.filter(e => e.status === statusFilter);
            }
            if (categoryFilter) {
                filteredExercises = filteredExercises.filter(e => e.category === categoryFilter);
            }

            tbody.innerHTML = '';
            
            filteredExercises.forEach(exercise => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exercise.clientName || 'N/A'}</td>
                    <td>${exercise.exerciseName || 'N/A'}</td>
                    <td><span class="status-badge status-${exercise.category || 'active'}">${exercise.category || 'N/A'}</span></td>
                    <td>
                        ${(exercise.videoFiles && exercise.videoFiles.length > 0) || exercise.videoFile ? `
                            ${exercise.videoFiles && exercise.videoFiles.length > 0 ? `
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <span style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">${exercise.videoFiles.length} Video${exercise.videoFiles.length > 1 ? 's' : ''}</span>
                                    <button class="btn btn-view" onclick="viewExerciseVideo('${exercise.videoFiles[0]}')" title="View First Video">
                                        <i class="fas fa-play"></i> ${exercise.videoFiles[0]}
                                    </button>
                                    ${exercise.videoFiles.length > 1 ? `
                                        <button class="btn btn-view" onclick="viewExerciseVideo('${exercise.videoFiles[1]}')" title="View Second Video" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                            <i class="fas fa-play"></i> +${exercise.videoFiles.length - 1} more
                                        </button>
                                    ` : ''}
                                </div>
                            ` : `
                        <button class="btn btn-view" onclick="viewExerciseVideo('${exercise.videoFile}')" title="View Video">
                                    <i class="fas fa-play"></i> ${exercise.videoFile}
                        </button>
                            `}
                        ` : `
                            <span style="color: #9ca3af; font-style: italic;">No videos</span>
                        `}
                    </td>
                    <td><span class="status-badge status-${exercise.status || 'active'}">${exercise.status || 'active'}</span></td>
                    <td>${exercise.createdAt ? new Date(exercise.createdAt).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewExercise('${exercise.id}')">View</button>
                            <button class="btn btn-update" onclick="editExercise('${exercise.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteExercise('${exercise.id}', '${exercise.exerciseName}', '${exercise.clientName}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateExerciseStats() {
            const total = exercises.length;
            const active = exercises.filter(e => e.status === 'active').length;
            const completed = exercises.filter(e => e.status === 'completed').length;
            const uniqueVideos = [...new Set(
                exercises.flatMap(e => {
                    if (e.videoFiles && Array.isArray(e.videoFiles)) {
                        return e.videoFiles;
                    } else if (e.videoFile) {
                        return [e.videoFile];
                    }
                    return [];
                })
            )].length;
            
            // Calculate changes (dummy values for demo)
            const exercisesChange = Math.round(Math.random() * 15);
            const activeClientsChange = Math.round(Math.random() * 10);
            const videosChange = Math.round(Math.random() * 5);
            const completedExercisesChange = Math.round(Math.random() * 8);

            document.getElementById('totalExercises').textContent = total;
            document.getElementById('activeExerciseClients').textContent = active;
            document.getElementById('exerciseVideos').textContent = uniqueVideos;
            document.getElementById('completedExercises').textContent = completed;
            
            document.getElementById('exercisesChange').textContent = exercisesChange + '%';
            document.getElementById('activeClientsChange').textContent = activeClientsChange + '%';
            document.getElementById('videosChange').textContent = videosChange + '%';
            document.getElementById('completedExercisesChange').textContent = completedExercisesChange + '%';
        }
        
        // Modal functions
        async function showCreateNutritionPlanModal() {
            try {
                await loadClientsForNutrition();
            showModal('nutritionPlanModal');
            } catch (error) {
                console.error('Error loading clients:', error);
                showError('Failed to load clients. Please try again.');
            }
        }

        async function showCreateExerciseModal() {
            try {
                await loadClientsForExercise();
                showModal('createExerciseModal');
            } catch (error) {
                console.error('Error loading clients:', error);
                showError('Failed to load clients. Please try again.');
            }
        }
        
        async function loadClientsForExercise() {
            try {
                const clientsSnapshot = await window.getDocs(window.collection(window.db, CLIENTS_COLLECTION));
                clients = [];
                clientsSnapshot.forEach((doc) => {
                    clients.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                const clientSelect = document.getElementById('exerciseClientSelect');
                clientSelect.innerHTML = '<option value="">Choose a client...</option>';
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (${client.email})`;
                    clientSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
                showError('Failed to load clients. Please try again.');
            }
        }
        
        async function loadClientsForNutrition() {
            try {
                const clientsSnapshot = await window.getDocs(window.collection(window.db, CLIENTS_COLLECTION));
                clients = [];
                clientsSnapshot.forEach((doc) => {
                    clients.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                const clientSelect = document.getElementById('nutritionClientSelect');
                clientSelect.innerHTML = '<option value="">Choose a client...</option>';
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (${client.email})`;
                    clientSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
                showError('Failed to load clients. Please try again.');
            }
        }
        
        // Food Selection Functions
        function showFoodSelectionModal(mealType) {
            currentMealType = mealType;
            selectedFood = null;
            populateFoodList();
            showModal('foodSelectionModal');
        }

        // Comprehensive Food Database with accurate nutrition per 100g and realistic serving units
        const foodDatabase = [
            // ===== PROTEIN SOURCES =====
            // Poultry
            { name: "Chicken Breast", calories: 165, protein: 31, carbs: 0, fat: 3.6, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Chicken Thigh", calories: 209, protein: 26, carbs: 0, fat: 11, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Turkey Breast", calories: 135, protein: 30, carbs: 0, fat: 0.7, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Duck Breast", calories: 132, protein: 23, carbs: 0, fat: 4.2, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Fish & Seafood
            { name: "Salmon", calories: 208, protein: 25, carbs: 0, fat: 12, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Tuna", calories: 144, protein: 30, carbs: 0, fat: 1, category: "protein", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Cod", calories: 82, protein: 18, carbs: 0, fat: 0.7, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Mackerel", calories: 205, protein: 19, carbs: 0, fat: 14, category: "protein", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Sardines", calories: 208, protein: 25, carbs: 0, fat: 11, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Shrimp", calories: 99, protein: 18, carbs: 0.9, fat: 1.7, category: "protein", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Crab", calories: 97, protein: 19, carbs: 0, fat: 1.8, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            
            // Red Meat
            { name: "Lean Beef", calories: 186, protein: 26, carbs: 0, fat: 8, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Ground Beef (93% lean)", calories: 176, protein: 25, carbs: 0, fat: 8, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Pork Tenderloin", calories: 143, protein: 26, carbs: 0, fat: 3.5, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Lamb", calories: 250, protein: 25, carbs: 0, fat: 16, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Plant-Based Proteins
            { name: "Tofu", calories: 76, protein: 8, carbs: 1.9, fat: 4.8, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Tempeh", calories: 192, protein: 19, carbs: 9, fat: 11, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Seitan", calories: 125, protein: 25, carbs: 4, fat: 0.5, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            
            // Eggs & Dairy Proteins
            { name: "Eggs", calories: 140, protein: 12, carbs: 1, fat: 10, category: "protein", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Egg Whites", calories: 52, protein: 11, carbs: 0.7, fat: 0.2, category: "protein", defaultServingAmount: 4, defaultServingUnit: "pieces" },
            { name: "Greek Yogurt", calories: 59, protein: 10, carbs: 3.6, fat: 0.4, category: "protein", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Cottage Cheese", calories: 98, protein: 11, carbs: 3.4, fat: 4.3, category: "protein", defaultServingAmount: 200, defaultServingUnit: "grams" },
            
            // ===== VEGETABLES =====
            // Leafy Greens
            { name: "Spinach", calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Kale", calories: 49, protein: 4.3, carbs: 9, fat: 0.9, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Arugula", calories: 25, protein: 2.6, carbs: 3.7, fat: 0.7, category: "vegetables", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Lettuce", calories: 15, protein: 1.4, carbs: 2.9, fat: 0.2, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            
            // Cruciferous Vegetables
            { name: "Broccoli", calories: 34, protein: 2.8, carbs: 7, fat: 0.4, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Cauliflower", calories: 25, protein: 1.9, carbs: 5, fat: 0.3, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Brussels Sprouts", calories: 43, protein: 3.4, carbs: 9, fat: 0.3, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Cabbage", calories: 25, protein: 1.3, carbs: 6, fat: 0.1, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Root Vegetables
            { name: "Carrots", calories: 41, protein: 0.9, carbs: 10, fat: 0.2, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Beets", calories: 43, protein: 1.6, carbs: 10, fat: 0.2, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Sweet Potato", calories: 86, protein: 1.6, carbs: 20, fat: 0.1, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Turnips", calories: 28, protein: 0.9, carbs: 6, fat: 0.1, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Other Vegetables
            { name: "Bell Peppers", calories: 31, protein: 1, carbs: 7, fat: 0.3, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Zucchini", calories: 17, protein: 1.2, carbs: 3.1, fat: 0.3, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Asparagus", calories: 20, protein: 2.2, carbs: 3.9, fat: 0.1, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Green Beans", calories: 31, protein: 1.8, carbs: 7, fat: 0.2, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Cucumber", calories: 16, protein: 0.7, carbs: 4, fat: 0.1, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Tomatoes", calories: 18, protein: 0.9, carbs: 3.9, fat: 0.2, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Mushrooms", calories: 22, protein: 3.1, carbs: 3.3, fat: 0.3, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Onions", calories: 40, protein: 1.1, carbs: 9, fat: 0.1, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Garlic", calories: 42, protein: 1.9, carbs: 9.3, fat: 0.1, category: "vegetables", defaultServingAmount: 10, defaultServingUnit: "grams" },
            
            // ===== FRUITS =====
            // Common Fruits
            { name: "Apple", calories: 52, protein: 0.3, carbs: 14, fat: 0.2, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Banana", calories: 89, protein: 1.1, carbs: 23, fat: 0.3, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Orange", calories: 47, protein: 0.9, carbs: 12, fat: 0.1, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Grapes", calories: 62, protein: 0.6, carbs: 16, fat: 0.2, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Pineapple", calories: 50, protein: 0.5, carbs: 13, fat: 0.1, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Mango", calories: 60, protein: 0.8, carbs: 15, fat: 0.4, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Berries
            { name: "Strawberries", calories: 32, protein: 0.7, carbs: 7.7, fat: 0.3, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Blueberries", calories: 57, protein: 0.7, carbs: 14, fat: 0.3, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Raspberries", calories: 52, protein: 1.2, carbs: 12, fat: 0.7, category: "fruits", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Blackberries", calories: 43, protein: 1.4, carbs: 10, fat: 0.5, category: "fruits", defaultServingAmount: 120, defaultServingUnit: "grams" },
            
            // Other Fruits
            { name: "Avocado", calories: 160, protein: 2, carbs: 9, fat: 15, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Kiwi", calories: 61, protein: 1.1, carbs: 15, fat: 0.5, category: "fruits", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Pear", calories: 57, protein: 0.4, carbs: 15, fat: 0.1, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Peach", calories: 39, protein: 0.9, carbs: 10, fat: 0.2, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Watermelon", calories: 30, protein: 0.6, carbs: 8, fat: 0.2, category: "fruits", defaultServingAmount: 200, defaultServingUnit: "grams" },
            
            // ===== GRAINS & STARCHES =====
            // Rice & Grains
            { name: "Brown Rice", calories: 111, protein: 2.6, carbs: 23, fat: 0.9, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "White Rice", calories: 130, protein: 2.7, carbs: 28, fat: 0.3, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Quinoa", calories: 120, protein: 4.4, carbs: 22, fat: 1.9, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Wild Rice", calories: 101, protein: 4, carbs: 21, fat: 0.3, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Barley", calories: 123, protein: 2.3, carbs: 28, fat: 0.4, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Bulgur", calories: 83, protein: 3, carbs: 19, fat: 0.2, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            
            // Oats & Cereals
            { name: "Oatmeal (cooked)", calories: 68, protein: 2.4, carbs: 12, fat: 1.4, category: "grains", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Steel Cut Oats (cooked)", calories: 62, protein: 2.5, carbs: 11, fat: 1.2, category: "grains", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Pasta & Noodles
            { name: "Whole Wheat Pasta", calories: 124, protein: 5, carbs: 25, fat: 1, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Regular Pasta", calories: 131, protein: 5, carbs: 25, fat: 1.1, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            
            // Bread
            { name: "Whole Wheat Bread", calories: 160, protein: 8, carbs: 28, fat: 2.5, category: "grains", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Sourdough Bread", calories: 220, protein: 9, carbs: 43, fat: 1.2, category: "grains", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Ezekiel Bread", calories: 80, protein: 4, carbs: 15, fat: 0.5, category: "grains", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            
            // ===== LEGUMES =====
            { name: "Lentils", calories: 116, protein: 9, carbs: 20, fat: 0.4, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Chickpeas", calories: 164, protein: 8, carbs: 27, fat: 2.6, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Black Beans", calories: 132, protein: 9, carbs: 24, fat: 0.5, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Kidney Beans", calories: 127, protein: 9, carbs: 23, fat: 0.5, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Pinto Beans", calories: 143, protein: 9, carbs: 26, fat: 0.7, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Navy Beans", calories: 140, protein: 8, carbs: 26, fat: 0.6, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Green Peas", calories: 81, protein: 5, carbs: 14, fat: 0.4, category: "legumes", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // ===== DAIRY =====
            { name: "Milk (2%)", calories: 50, protein: 3.3, carbs: 4.8, fat: 2, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Whole Milk", calories: 61, protein: 3.3, carbs: 4.8, fat: 3.3, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Skim Milk", calories: 34, protein: 3.4, carbs: 5, fat: 0.2, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Almond Milk", calories: 17, protein: 0.6, carbs: 1.5, fat: 1.4, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Oat Milk", calories: 47, protein: 1, carbs: 8, fat: 1.5, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Soy Milk", calories: 33, protein: 2.9, carbs: 1.2, fat: 1.8, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            
            // Cheese
            { name: "Cheddar Cheese", calories: 121, protein: 7.5, carbs: 0.4, fat: 10, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Mozzarella", calories: 84, protein: 8.4, carbs: 0.7, fat: 5.1, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Parmesan", calories: 86, protein: 7.6, carbs: 0.8, fat: 5.8, category: "dairy", defaultServingAmount: 20, defaultServingUnit: "grams" },
            { name: "Feta Cheese", calories: 79, protein: 4.2, carbs: 1.2, fat: 6.3, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Swiss Cheese", calories: 118, protein: 8.1, carbs: 1.5, fat: 9.3, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            
            // ===== NUTS & SEEDS =====
            // Nuts
            { name: "Almonds", calories: 174, protein: 6.4, carbs: 6.6, fat: 15, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Walnuts", calories: 196, protein: 4.6, carbs: 4.1, fat: 19.5, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Cashews", calories: 166, protein: 5.4, carbs: 9, fat: 13.2, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Pistachios", calories: 168, protein: 6, carbs: 8.4, fat: 13.5, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Pecans", calories: 207, protein: 2.7, carbs: 4.2, fat: 21.6, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Brazil Nuts", calories: 132, protein: 2.8, carbs: 2.4, fat: 13.4, category: "nuts", defaultServingAmount: 20, defaultServingUnit: "grams" },
            { name: "Hazelnuts", calories: 188, protein: 4.5, carbs: 5.1, fat: 18.3, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            
            // Seeds
            { name: "Chia Seeds", calories: 73, protein: 2.6, carbs: 6.3, fat: 4.7, category: "nuts", defaultServingAmount: 15, defaultServingUnit: "grams" },
            { name: "Flax Seeds", calories: 80, protein: 2.7, carbs: 4.4, fat: 6.3, category: "nuts", defaultServingAmount: 15, defaultServingUnit: "grams" },
            { name: "Pumpkin Seeds", calories: 168, protein: 5.7, carbs: 16.2, fat: 14.7, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Sunflower Seeds", calories: 175, protein: 6.3, carbs: 6, fat: 15.3, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Hemp Seeds", calories: 111, protein: 6.2, carbs: 1.6, fat: 9.8, category: "nuts", defaultServingAmount: 20, defaultServingUnit: "grams" },
            { name: "Sesame Seeds", calories: 86, protein: 2.7, carbs: 3.5, fat: 7.5, category: "nuts", defaultServingAmount: 15, defaultServingUnit: "grams" },
            
            // ===== HEALTHY FATS & OILS =====
            { name: "Olive Oil", calories: 119, protein: 0, carbs: 0, fat: 13.5, category: "fats", defaultServingAmount: 1, defaultServingUnit: "tablespoons" },
            { name: "Coconut Oil", calories: 117, protein: 0, carbs: 0, fat: 13.5, category: "fats", defaultServingAmount: 1, defaultServingUnit: "tablespoons" },
            { name: "Avocado Oil", calories: 124, protein: 0, carbs: 0, fat: 14, category: "fats", defaultServingAmount: 1, defaultServingUnit: "tablespoons" },
            { name: "Peanut Butter", calories: 190, protein: 8, carbs: 8, fat: 16, category: "fats", defaultServingAmount: 2, defaultServingUnit: "tablespoons" },
            { name: "Almond Butter", calories: 196, protein: 7, carbs: 7, fat: 18, category: "fats", defaultServingAmount: 2, defaultServingUnit: "tablespoons" },
            { name: "Tahini", calories: 119, protein: 3.6, carbs: 4.6, fat: 10.5, category: "fats", defaultServingAmount: 2, defaultServingUnit: "tablespoons" },
            
            // ===== SNACKS & TREATS =====
            { name: "Dark Chocolate (70%)", calories: 164, protein: 2.3, carbs: 13.5, fat: 9.3, category: "snacks", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Popcorn (Air-popped)", calories: 115, protein: 3.8, carbs: 23, fat: 1.3, category: "snacks", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Rice Cakes", calories: 35, protein: 0.7, carbs: 7.3, fat: 0.4, category: "snacks", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            
            // ===== HERBS & SPICES =====
            { name: "Ginger", calories: 80, protein: 1.8, carbs: 18, fat: 0.8, category: "herbs", defaultServingAmount: 5, defaultServingUnit: "grams" },
            { name: "Turmeric", calories: 7, protein: 0.16, carbs: 1.3, fat: 0.2, category: "herbs", defaultServingAmount: 2, defaultServingUnit: "grams" },
            { name: "Basil", calories: 22, protein: 3.2, carbs: 2.6, fat: 0.6, category: "herbs", defaultServingAmount: 5, defaultServingUnit: "grams" },
            { name: "Parsley", calories: 36, protein: 3, carbs: 6, fat: 0.8, category: "herbs", defaultServingAmount: 10, defaultServingUnit: "grams" },
            
            // ===== ARABIC & MIDDLE EASTERN FOODS =====
            // Traditional Dishes
            { name: "Hummus", calories: 166, protein: 8, carbs: 14, fat: 10, category: "arabic", defaultServingAmount: 100, defaultServingUnit: "grams", 
              ingredients: "Chickpeas (cooked) 60g, Tahini 15g, Lemon juice 10g, Garlic 3g, Olive oil 8g, Salt 1g, Cumin 0.5g, Water 2.5g" },
            { name: "Falafel", calories: 333, protein: 13, carbs: 32, fat: 18, category: "arabic", defaultServingAmount: 4, defaultServingUnit: "pieces",
              ingredients: "Chickpeas (dried, soaked) 50g, Parsley 10g, Onion 15g, Garlic 5g, Cumin 2g, Coriander 2g, Salt 2g, Baking powder 1g, Oil for frying 13g" },
            { name: "Tabbouleh", calories: 36, protein: 1.5, carbs: 6, fat: 1.2, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Parsley 80g, Tomatoes 40g, Bulgur wheat 15g, Mint 10g, Lemon juice 10g, Olive oil 8g, Salt 2g, Onion 5g" },
            { name: "Fattoush", calories: 79, protein: 2.8, carbs: 12, fat: 3, category: "arabic", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Mixed lettuce 60g, Tomatoes 50g, Cucumber 40g, Pita bread (toasted) 20g, Sumac 3g, Lemon juice 15g, Olive oil 10g, Mint 2g" },
            { name: "Baba Ganoush", calories: 112, protein: 2.8, carbs: 9, fat: 8, category: "arabic", defaultServingAmount: 100, defaultServingUnit: "grams",
              ingredients: "Eggplant (roasted) 70g, Tahini 12g, Lemon juice 8g, Garlic 4g, Olive oil 5g, Salt 1g" },
            { name: "Shawarma (Chicken)", calories: 250, protein: 27, carbs: 5, fat: 14, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Chicken thigh 120g, Onion 15g, Yogurt 8g, Olive oil 5g, Garlic 2g, Baharat spice 2g, Salt 1g, Lemon juice 2g" },
            { name: "Shawarma (Lamb)", calories: 295, protein: 23, carbs: 4, fat: 21, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Lamb shoulder 120g, Onion 15g, Yogurt 8g, Olive oil 5g, Garlic 2g, Baharat spice 2g, Salt 1g, Sumac 1g" },
            { name: "Chicken Kebab", calories: 200, protein: 26, carbs: 2, fat: 9, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Chicken breast 130g, Onion 10g, Garlic 3g, Olive oil 4g, Yogurt 5g, Paprika 1g, Cumin 1g, Salt 1g" },
            { name: "Lamb Kebab", calories: 280, protein: 24, carbs: 1, fat: 20, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Ground lamb 130g, Onion 10g, Parsley 5g, Garlic 2g, Baharat spice 2g, Salt 1g" },
            { name: "Manakish (Za'atar)", calories: 285, protein: 8, carbs: 45, fat: 9, category: "arabic", defaultServingAmount: 1, defaultServingUnit: "pieces",
              ingredients: "Pita dough 80g, Za'atar blend 8g, Olive oil 12g" },
            { name: "Labneh", calories: 80, protein: 6, carbs: 4, fat: 5, category: "arabic", defaultServingAmount: 100, defaultServingUnit: "grams",
              ingredients: "Greek yogurt 120g (strained overnight with salt 2g)" },
            { name: "Halloumi Cheese", calories: 257, protein: 19.2, carbs: 1.6, fat: 19.2, category: "arabic", defaultServingAmount: 80, defaultServingUnit: "grams",
              ingredients: "Traditional cheese (no recipe - commercial product)" },
            { name: "Makloubeh", calories: 180, protein: 8, carbs: 25, fat: 6, category: "arabic", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Basmati rice 60g, Chicken pieces 40g, Eggplant 30g, Cauliflower 25g, Onion 20g, Olive oil 8g, Baharat spice 3g, Salt 2g, Almonds 5g, Pine nuts 3g, Stock 4g" },
            { name: "Mjaddara", calories: 140, protein: 6, carbs: 26, fat: 2, category: "arabic", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Brown lentils 50g, Rice 40g, Onion (caramelized) 30g, Olive oil 6g, Cumin 2g, Salt 2g, Bay leaves 1g, Water/stock 69g" },
            
            // ===== EGYPTIAN FOODS =====
            // Traditional Egyptian Dishes
            { name: "Ful Medames", calories: 187, protein: 12, carbs: 33, fat: 1, category: "egyptian", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Fava beans (cooked) 150g, Tomato 20g, Onion 15g, Garlic 5g, Lemon juice 8g, Olive oil 4g, Cumin 2g, Salt 2g, Parsley 4g" },
            { name: "Ta'meya (Egyptian Falafel)", calories: 310, protein: 12, carbs: 35, fat: 15, category: "egyptian", defaultServingAmount: 4, defaultServingUnit: "pieces",
              ingredients: "Fava beans (dried, soaked) 60g, Parsley 15g, Cilantro 10g, Onion 20g, Garlic 8g, Cumin 3g, Coriander seeds 2g, Salt 3g, Sesame seeds 5g, Oil for frying 15g" },
            { name: "Koshari", calories: 165, protein: 6, carbs: 30, fat: 3, category: "egyptian", defaultServingAmount: 250, defaultServingUnit: "grams",
              ingredients: "Rice 60g, Brown lentils 40g, Macaroni 30g, Chickpeas 25g, Onion (fried) 20g, Tomato sauce 50g, Garlic 5g, Cumin 2g, Vinegar 10g, Oil 8g" },
            { name: "Molokhia (Jute Soup)", calories: 45, protein: 4, carbs: 8, fat: 0.5, category: "egyptian", defaultServingAmount: 250, defaultServingUnit: "grams",
              ingredients: "Molokhia leaves (chopped) 100g, Chicken stock 120g, Garlic 8g, Coriander (ground) 2g, Onion 15g, Lemon juice 5g" },
            { name: "Mahshi Waraq Enab (Stuffed Grape Leaves)", calories: 98, protein: 2.5, carbs: 18, fat: 2, category: "egyptian", defaultServingAmount: 6, defaultServingUnit: "pieces",
              ingredients: "Grape leaves 30g, Rice 40g, Tomato (diced) 15g, Onion 10g, Parsley 8g, Mint 3g, Lemon juice 8g, Olive oil 6g, Salt 2g, Pine nuts 3g" },
            { name: "Mahshi Kousa (Stuffed Zucchini)", calories: 110, protein: 4, carbs: 20, fat: 2.5, category: "egyptian", defaultServingAmount: 3, defaultServingUnit: "pieces",
              ingredients: "Small zucchini (hollowed) 120g, Rice 35g, Ground meat 20g, Tomato 10g, Onion 8g, Parsley 5g, Dill 3g, Olive oil 5g, Salt 2g, Spices 2g" },
            { name: "Bamia (Egyptian Okra Stew)", calories: 85, protein: 3, carbs: 16, fat: 2, category: "egyptian", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Okra 120g, Tomato sauce 40g, Onion 20g, Garlic 5g, Beef/lamb pieces 30g, Olive oil 6g, Coriander 2g, Salt 2g, Water 25g" },
            { name: "Roz bel Laban (Rice Pudding)", calories: 130, protein: 4, carbs: 24, fat: 2.5, category: "egyptian", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Rice (short grain) 25g, Whole milk 100g, Sugar 15g, Vanilla 1g, Cornstarch 3g, Raisins 5g, Coconut flakes 1g" },
            { name: "Egyptian Baladi Bread", calories: 265, protein: 8, carbs: 55, fat: 1.5, category: "egyptian", defaultServingAmount: 1, defaultServingUnit: "pieces",
              ingredients: "Whole wheat flour 80g, Water 35g, Salt 2g, Yeast 1g, Bran 2g" },
            { name: "Gebna Beida (Egyptian White Cheese)", calories: 230, protein: 18, carbs: 3, fat: 16, category: "egyptian", defaultServingAmount: 50, defaultServingUnit: "grams",
              ingredients: "Traditional cheese (no recipe - commercial/artisanal product)" },
            { name: "Egyptian Lentil Soup", calories: 95, protein: 6, carbs: 17, fat: 1, category: "egyptian", defaultServingAmount: 250, defaultServingUnit: "grams",
              ingredients: "Red lentils 60g, Onion 25g, Carrot 20g, Tomato 20g, Garlic 5g, Vegetable stock 100g, Cumin 2g, Turmeric 1g, Olive oil 3g, Salt 2g, Lemon juice 5g" },
            { name: "Basbousa", calories: 320, protein: 5, carbs: 45, fat: 14, category: "egyptian", defaultServingAmount: 80, defaultServingUnit: "grams",
              ingredients: "Semolina 35g, Sugar 20g, Coconut 10g, Yogurt 15g, Butter 8g, Almonds 5g, Sugar syrup 25g, Baking powder 1g, Vanilla 1g" },
            { name: "Konafa", calories: 395, protein: 7, carbs: 42, fat: 22, category: "egyptian", defaultServingAmount: 100, defaultServingUnit: "grams",
              ingredients: "Konafa dough 40g, Ricotta/cream cheese 25g, Sugar 15g, Butter 12g, Pistachios 8g, Sugar syrup 20g, Rose water 2g" },
            
            // ===== ARABIC INGREDIENTS & SPICES =====
            // Traditional Spices & Seasonings
            { name: "Za'atar", calories: 14, protein: 0.25, carbs: 2.4, fat: 0.4, category: "arabic-spices", defaultServingAmount: 5, defaultServingUnit: "grams" },
            { name: "Sumac", calories: 10, protein: 0.09, carbs: 2.1, fat: 0.09, category: "arabic-spices", defaultServingAmount: 3, defaultServingUnit: "grams" },
            { name: "Baharat (7 Spice)", calories: 9, protein: 0.24, carbs: 1.7, fat: 0.15, category: "arabic-spices", defaultServingAmount: 3, defaultServingUnit: "grams" },
            { name: "Cardamom", calories: 6, protein: 0.22, carbs: 1.4, fat: 0.14, category: "arabic-spices", defaultServingAmount: 2, defaultServingUnit: "grams" },
            { name: "Dukkah", calories: 52, protein: 1.8, carbs: 2.2, fat: 4.2, category: "arabic-spices", defaultServingAmount: 10, defaultServingUnit: "grams" },
            { name: "Rose Water", calories: 1, protein: 0, carbs: 0, fat: 0, category: "arabic-spices", defaultServingAmount: 5, defaultServingUnit: "ml" },
            { name: "Orange Blossom Water", calories: 1, protein: 0, carbs: 0, fat: 0, category: "arabic-spices", defaultServingAmount: 5, defaultServingUnit: "ml" },
            
            // Traditional Grains & Legumes
            { name: "Freekeh", calories: 141, protein: 6, carbs: 28, fat: 1, category: "arabic-grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Egyptian Rice (cooked)", calories: 130, protein: 2.7, carbs: 28, fat: 0.3, category: "arabic-grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Fava Beans (Fresh)", calories: 88, protein: 8, carbs: 17, fat: 0.8, category: "arabic-grains", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Black Beluga Lentils (cooked)", calories: 115, protein: 9, carbs: 20, fat: 0.4, category: "arabic-grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            
            // Traditional Fruits & Sweets
            { name: "Medjool Dates", calories: 199, protein: 1.4, carbs: 54, fat: 0.1, category: "arabic-fruits", defaultServingAmount: 3, defaultServingUnit: "pieces" },
            { name: "Fresh Figs", calories: 74, protein: 0.8, carbs: 19, fat: 0.3, category: "arabic-fruits", defaultServingAmount: 3, defaultServingUnit: "pieces" },
            { name: "Pomegranate Seeds", calories: 83, protein: 1.7, carbs: 19, fat: 1.2, category: "arabic-fruits", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Turkish Delight", calories: 320, protein: 0, carbs: 80, fat: 0, category: "arabic-fruits", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Halva", calories: 141, protein: 3.9, carbs: 16.2, fat: 7.5, category: "arabic-fruits", defaultServingAmount: 30, defaultServingUnit: "grams" },
            
            // Traditional Dairy & Proteins
            { name: "Kashkaval Cheese", calories: 173, protein: 12.5, carbs: 1, fat: 13, category: "arabic-dairy", defaultServingAmount: 50, defaultServingUnit: "grams" },
            { name: "Jibneh Arabieh (Arabic Cheese)", calories: 140, protein: 10, carbs: 0.5, fat: 11, category: "arabic-dairy", defaultServingAmount: 50, defaultServingUnit: "grams" },
            { name: "Kefir", calories: 41, protein: 3.8, carbs: 4.5, fat: 1, category: "arabic-dairy", defaultServingAmount: 200, defaultServingUnit: "ml" },
            
            // ===== BEVERAGES (per 100ml for tea/coffee) =====
            { name: "Green Tea", calories: 1, protein: 0, carbs: 0, fat: 0, category: "beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Black Coffee", calories: 2, protein: 0.3, carbs: 0, fat: 0, category: "beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Coconut Water", calories: 19, protein: 0.7, carbs: 3.7, fat: 0.2, category: "beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            
            // Traditional Arabic/Middle Eastern Beverages
            { name: "Arabic Coffee (Qahwa)", calories: 2, protein: 0.1, carbs: 0, fat: 0, category: "arabic-beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Mint Tea (Atay)", calories: 2, protein: 0, carbs: 0.5, fat: 0, category: "arabic-beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Tamarind Juice", calories: 42, protein: 0.3, carbs: 11, fat: 0.1, category: "arabic-beverages", defaultServingAmount: 200, defaultServingUnit: "ml" },
            { name: "Hibiscus Tea (Karkade)", calories: 5, protein: 0.1, carbs: 1.3, fat: 0, category: "arabic-beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Sahlab", calories: 95, protein: 3, carbs: 18, fat: 1.5, category: "arabic-beverages", defaultServingAmount: 200, defaultServingUnit: "ml" },
            { name: "Jallab", calories: 85, protein: 0.2, carbs: 22, fat: 0.1, category: "arabic-beverages", defaultServingAmount: 200, defaultServingUnit: "ml" }
        ];

        // Unit conversion factors (to grams)
        const unitConversions = {
            grams: 1,
            cups: 240, // Approximate for most foods
            tablespoons: 15,
            pieces: 100 // Average weight per piece
        };

        function populateFoodList() {
            const foodList = document.getElementById('foodList');
            foodList.innerHTML = '';
            
            const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('foodCategoryFilter').value.toLowerCase();
            
            foodDatabase.forEach(food => {
                if (searchTerm && !food.name.toLowerCase().includes(searchTerm)) return;
                if (categoryFilter && food.category !== categoryFilter) return;
                
                const foodCard = document.createElement('div');
                foodCard.className = 'food-item-card';
                foodCard.style.border = '1px solid #e5e7eb';
                foodCard.style.borderRadius = '0.75rem';
                foodCard.style.padding = '1.25rem';
                foodCard.style.cursor = 'pointer';
                foodCard.style.transition = 'all 0.2s';
                foodCard.style.background = 'white';
                foodCard.onclick = () => selectFood(food, foodCard);
                
                foodCard.innerHTML = `
                    <div class="food-name" style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 1.1rem;">${food.name}</div>
                    <div class="food-category" style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">${food.category}</div>
                    <div class="food-nutrition" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; font-size: 0.9rem;">
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Calories</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.calories}</div>
                        </div>
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Protein</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.protein}g</div>
                        </div>
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Carbs</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.carbs}g</div>
                        </div>
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Fat</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.fat}g</div>
                        </div>
                    </div>
                    ${food.ingredients ? `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 0.5rem; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; display: flex; align-items: center;">
                            <span style="margin-right: 0.25rem;">🥄</span> Ingredients (per serving):
                        </div>
                        <div style="font-size: 0.7rem; color: #374151; line-height: 1.4;">
                            ${food.ingredients}
                        </div>
                    </div>
                    ` : ''}
                    <button class="btn-add-food" style="display: none; width: 100%; margin-top: 1rem; background: #006A67; color: white; border: none; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.95rem;">
                        <i class="fas fa-plus"></i> Add to ${currentMealType}
                    </button>
                `;
                
                foodList.appendChild(foodCard);
            });
            
            // Add event listeners for filtering
            document.getElementById('foodSearchInput').addEventListener('input', populateFoodList);
            document.getElementById('foodCategoryFilter').addEventListener('change', populateFoodList);
        }

        function selectFood(food, card) {
            // Remove selection from all cards
            document.querySelectorAll('.food-item-card').forEach(c => {
                c.style.borderColor = '#e5e7eb';
                c.style.boxShadow = 'none';
                c.querySelector('.btn-add-food').style.display = 'none';
            });
            
            // Select this card
            card.style.borderColor = '#2563eb';
            card.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.2)';
            selectedFood = food;
            
            // Show the add button for this food
            const addButton = card.querySelector('.btn-add-food');
            addButton.style.display = 'block';
            addButton.onclick = (e) => {
                e.stopPropagation();
                addSelectedFood(food);
            };
        }

        function addSelectedFood(food) {
            if (!food) return;
            addFoodToMealPlan(food, currentMealType);
            closeModal('foodSelectionModal');
        }

        function createMealItemElement(food) {
            const mealItem = document.createElement('div');
            mealItem.className = 'meal-item';
            
            // Determine if this is saved data or fresh food from database
            const isFromSavedData = food.servingAmount !== undefined;
            
            if (isFromSavedData) {
                console.log(`🔄 Loading saved food item: ${food.name} - ${food.calories} cal (serving: ${food.servingAmount}${food.servingUnit})`);
                
                // For saved data, use the original food database values as base
                const originalFood = foodDatabase.find(f => f.name === food.name || f.name === food.food);
                if (originalFood) {
                    mealItem.dataset.baseCalories = originalFood.calories;
                    mealItem.dataset.baseProtein = originalFood.protein;
                    mealItem.dataset.baseCarbs = originalFood.carbs;
                    mealItem.dataset.baseFat = originalFood.fat;
                    console.log(`📊 Using original base values: ${originalFood.calories} cal/100g`);
                } else {
                    // Fallback: calculate base values from saved data
                    const servingAmount = food.servingAmount || 100;
                    const factor = servingAmount / 100;
                    mealItem.dataset.baseCalories = Math.round((food.calories || 0) / factor);
                    mealItem.dataset.baseProtein = Math.round((food.protein || 0) / factor * 10) / 10;
                    mealItem.dataset.baseCarbs = Math.round((food.carbs || 0) / factor * 10) / 10;
                    mealItem.dataset.baseFat = Math.round((food.fat || 0) / factor * 10) / 10;
                    console.log(`📊 Calculated base values from saved data: ${mealItem.dataset.baseCalories} cal/100g`);
                }
                
                // Use the exact saved nutrition values (don't recalculate)
                var adjustedCalories = food.calories || 0;
                var adjustedProtein = food.protein || 0;
                var adjustedCarbs = food.carbs || 0;
                var adjustedFat = food.fat || 0;
                var defaultAmount = food.servingAmount || 100;
                var defaultUnit = food.servingUnit || 'grams';
                
                console.log(`✅ Using saved nutrition values: ${adjustedCalories} cal (no recalculation)`);
                
            } else {
                console.log(`🆕 Creating fresh food item: ${food.name}`);
                
                // For fresh foods from database, store original per-100g values
            mealItem.dataset.baseCalories = food.calories;
            mealItem.dataset.baseProtein = food.protein;
            mealItem.dataset.baseCarbs = food.carbs;
            mealItem.dataset.baseFat = food.fat;
                
                // Use default serving amount and unit from food database
                var defaultAmount = food.defaultServingAmount || 100;
                var defaultUnit = food.defaultServingUnit || 'grams';
                
                // Calculate nutrition values based on the default serving
                const servingMultiplier = defaultAmount / 100; // Since nutrition is per 100g
                var adjustedCalories = Math.round(food.calories * servingMultiplier);
                var adjustedProtein = Math.round(food.protein * servingMultiplier * 10) / 10;
                var adjustedCarbs = Math.round(food.carbs * servingMultiplier * 10) / 10;
                var adjustedFat = Math.round(food.fat * servingMultiplier * 10) / 10;
                
                console.log(`✅ Calculated nutrition for ${defaultAmount}${defaultUnit}: ${adjustedCalories} cal`);
            }
            
            mealItem.innerHTML = `
                <div class="serving-controls">
                    <span class="serving-label">Amount:</span>
                    <input type="number" class="serving-amount" value="${defaultAmount}" min="1" step="1" style="width:70px;">
                    <select class="serving-unit">
                        <option value="grams" ${defaultUnit === 'grams' ? 'selected' : ''}>Grams</option>
                        <option value="cups" ${defaultUnit === 'cups' ? 'selected' : ''}>Cups</option>
                        <option value="tablespoons" ${defaultUnit === 'tablespoons' ? 'selected' : ''}>Tablespoons</option>
                        <option value="pieces" ${defaultUnit === 'pieces' ? 'selected' : ''}>Pieces</option>
                    </select>
                </div>
                <input type="text" value="${food.name || food.food}" class="food-item" readonly>
                <div class="nutrition-inputs">
                    <div class="nutrition-input">
                        <div class="nutrition-label">Calories</div>
                        <input type="number" class="calories-value" value="${adjustedCalories}" style="width:70px;">
                    </div>
                    <div class="nutrition-input">
                        <div class="nutrition-label">Protein (g)</div>
                        <input type="number" class="protein-value" value="${adjustedProtein}" style="width:70px;">
                    </div>
                    <div class="nutrition-input">
                        <div class="nutrition-label">Carbs (g)</div>
                        <input type="number" class="carbs-value" value="${adjustedCarbs}" style="width:70px;">
                    </div>
                    <div class="nutrition-input">
                        <div class="nutrition-label">Fat (g)</div>
                        <input type="number" class="fat-value" value="${adjustedFat}" style="width:70px;">
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeMealItem(this)">
                    <i class="fas fa-trash"></i> Remove
                </button>
            `;
            // Auto-update nutrition values when amount/unit changes
            const amountInput = mealItem.querySelector('.serving-amount');
            const unitSelect = mealItem.querySelector('.serving-unit');
            amountInput.addEventListener('input', () => updateNutritionValuesWithServing(mealItem));
            unitSelect.addEventListener('change', () => updateNutritionValuesWithServing(mealItem));
            return mealItem;
        }

        function updateNutritionValuesWithServing(mealItem) {
            const amount = parseFloat(mealItem.querySelector('.serving-amount').value) || 0;
            const unit = mealItem.querySelector('.serving-unit').value;
            const foodName = mealItem.querySelector('.food-item')?.value || 'Unknown';
            
            console.log(`⚖️ Updating serving for ${foodName}: ${amount} ${unit}`);
            
            // Unit conversion factors (to grams)
            const unitConversions = {
                grams: 1,
                cups: 240,
                tablespoons: 15,
                pieces: 100
            };
            const grams = amount * (unitConversions[unit] || 1);
            const factor = grams / 100; // Nutrition is per 100g
            
            // Use base values for calculation
            const baseCalories = parseFloat(mealItem.dataset.baseCalories) || 0;
            const baseProtein = parseFloat(mealItem.dataset.baseProtein) || 0;
            const baseCarbs = parseFloat(mealItem.dataset.baseCarbs) || 0;
            const baseFat = parseFloat(mealItem.dataset.baseFat) || 0;
            
            // Calculate new values
            const newCalories = Math.round(baseCalories * factor);
            const newProtein = (baseProtein * factor).toFixed(1);
            const newCarbs = (baseCarbs * factor).toFixed(1);
            const newFat = (baseFat * factor).toFixed(1);
            
            // Update the UI
            mealItem.querySelector('.calories-value').value = newCalories;
            mealItem.querySelector('.protein-value').value = newProtein;
            mealItem.querySelector('.carbs-value').value = newCarbs;
            mealItem.querySelector('.fat-value').value = newFat;
            
            console.log(`✅ Updated ${foodName}: ${newCalories} cal, ${newProtein}g protein`);
            
            // Trigger real-time nutrition summary updates
            setTimeout(() => {
                updateNutritionSummary();
                updateDayNutritionSummary(currentDay);
            }, 50);
        }

        function addFoodToMealPlan(food, mealType) {
            console.log(`🍽️ Adding ${food.name} to ${mealType} for Day ${currentDay}`);
            
            // Find the meal section in the current modal
            let mealSection = null;
            let mealItems = null;
            
            // Find meal section by text content
            const mealSections = document.querySelectorAll('.meal-section');
            for (let section of mealSections) {
                const h4 = section.querySelector('h4');
                if (h4 && h4.textContent.toLowerCase().includes(mealType.toLowerCase())) {
                    mealSection = section;
                    break;
                }
            }
            
            if (!mealSection) {
                console.error('Meal section not found for:', mealType);
                return;
            }
            
            mealItems = mealSection.querySelector('.meal-items');
            
            const mealItem = createMealItemElement(food);
            mealItems.appendChild(mealItem);
            
            // Add event listeners for real-time updates
            addNutritionEventListeners(mealItem);
            
            console.log(`✅ Added ${food.name} (${food.calories} cal) to ${mealType}`);
            
            // Immediately trigger auto-calculation update
            setTimeout(() => {
                console.log(`🔄 Triggering nutrition updates after adding ${food.name}`);
                updateNutritionSummary();
                updateDayNutritionSummary(currentDay);
            }, 50);
        }

        function addNutritionEventListeners(mealItem) {
            // Add event listeners to nutrition input fields for real-time updates
            const nutritionInputs = mealItem.querySelectorAll('.calories-value, .protein-value, .carbs-value, .fat-value, .serving-amount');
            const servingUnit = mealItem.querySelector('.serving-unit');
            
            nutritionInputs.forEach(input => {
                input.addEventListener('input', () => {
                    setTimeout(() => {
                        updateNutritionSummary();
                        updateDayNutritionSummary(currentDay);
                    }, 100);
                });
            });
            
            if (servingUnit) {
                servingUnit.addEventListener('change', () => {
                    setTimeout(() => {
                        updateNutritionSummary();
                        updateDayNutritionSummary(currentDay);
                    }, 100);
                });
            }
        }

        function removeMealItem(button) {
            const mealItem = button.closest('.meal-item');
            const foodName = mealItem.querySelector('.food-item')?.value || 'Unknown';
            
            console.log(`🗑️ Removing ${foodName} from Day ${currentDay}`);
            
            mealItem.remove();
            
            // Immediately trigger auto-calculation update
            setTimeout(() => {
                console.log(`🔄 Triggering nutrition updates after removing ${foodName}`);
                updateNutritionSummary();
                updateDayNutritionSummary(currentDay);
            }, 50);
        }

        function viewConsultation(id) {
            const consultation = consultations.find(c => c.id === id);
            if (!consultation) return;

            alert(`Consultation Details:\n\nName: ${consultation.name}\nEmail: ${consultation.email}\nPhone: ${consultation.phone}\nGoals: ${consultation.goals}\nStatus: ${consultation.status}\nDate: ${new Date(consultation.createdAt).toLocaleDateString()}`);
        }

        function updateStatus(id) {
            currentConsultationId = id;
            const consultation = consultations.find(c => c.id === id);
            if (!consultation) return;

            alert(`Update status for consultation ID: ${id}`);
        }

        async function confirmPayment(consultationId, clientName, amount, paymentMethod, isCoachingOrder = false) {
            const currency = isCoachingOrder ? '$' : 'EGP';
            const serviceType = isCoachingOrder ? 'coaching programs' : 'nutrition/fitness services';
            
            const confirmMessage = `Confirm payment receipt for:

👤 Client: ${clientName}
💰 Amount: ${currency}${amount}
💳 Method: ${paymentMethod}
📋 Service: ${serviceType}

This will grant the client access to their purchased services.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Show loading state
                const confirmButtons = document.querySelectorAll(`[onclick*="confirmPayment('${consultationId}',"]`);
                confirmButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirming...';
                });

                // Find which collection this item belongs to
                const consultation = consultations.find(c => c.id === consultationId);
                const collectionName = consultation?.collection || 'consultations';
                
                console.log(`Updating payment status in ${collectionName} collection for document: ${consultationId}`);
                
                // Update document in the correct collection
                const docRef = window.doc(window.db, collectionName, consultationId);
                await window.updateDoc(docRef, {
                    paymentStatus: 'confirmed',
                    paymentConfirmedAt: new Date().toISOString(),
                    paymentConfirmedBy: window.auth.currentUser?.email || 'admin',
                    status: 'registered' // Automatically update status to registered
                });

                // Show success message
                const successMessage = isCoachingOrder ? 
                    `✅ Payment confirmed for ${clientName}! Client can now access their coaching programs.` :
                    `✅ Payment confirmed for ${clientName}! Client can now access their nutrition plans.`;
                showSuccess(successMessage);

                // Refresh the consultations list
                loadConsultations();

                console.log(`Payment confirmed for consultation: ${consultationId} - ${clientName} - ${currency}${amount} via ${paymentMethod}`);

            } catch (error) {
                console.error('Error confirming payment:', error);
                showError('❌ Failed to confirm payment. Please try again.');

                // Restore button state
                const confirmButtons = document.querySelectorAll(`[onclick*="confirmPayment('${consultationId}',"]`);
                confirmButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = 'Confirm Payment';
                });
            }
        }

        // Helper functions
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'flex';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.cssText = `
                background: #fef2f2;
                color: #dc2626;
                padding: 0.85rem;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                border: 1px solid #fecaca;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 500;
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            
            // Check if we're in the admin dashboard or login screen
            if (document.getElementById('adminDashboard').style.display !== 'none') {
                // Dashboard context - show as toast notification
                document.body.appendChild(errorDiv);
            } else {
                // Login context - show in login card
                const loginCard = document.querySelector('.login-card');
                if (loginCard) {
                    loginCard.insertBefore(errorDiv, document.getElementById('loginForm'));
                } else {
                    document.body.appendChild(errorDiv);
                }
            }
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.style.cssText = `
                background: #f0fdf4;
                color: #059669;
                padding: 0.85rem;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                border: 1px solid #bbf7d0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 500;
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            
            // Show as toast notification
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 5000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function refreshData() {
            switch(currentSection) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'consultations':
                    loadConsultations();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'nutrition':
                    loadNutritionPlans();
                    break;
                case 'exercises':
                    loadExercises();
                    break;
                case 'orders':
                    loadOrders();
                    break;
            }
            showSuccess('Data refreshed successfully!');
        }

        let currentViewPlanId = null; // Store current viewing plan ID for edit transition

        function viewNutritionPlan(id) {
            const plan = nutritionPlans.find(p => p.id === id);
            if (!plan) {
                showError('Nutrition plan not found.');
                return;
            }
            
            currentViewPlanId = id;
            
            // Generate comprehensive view content
            const content = document.getElementById('viewPlanContent');
            content.innerHTML = generateViewPlanHTML(plan);
            
            showModal('viewNutritionPlanModal');
        }

        function generateViewPlanHTML(plan) {
            const mealPlan = plan.mealPlan || {};
            const isMultiDay = Object.keys(mealPlan).some(key => !isNaN(key));
            
            // Check for client modifications
            const hasClientChanges = checkForClientChanges(plan);
            const lastModified = plan.lastModifiedAt ? new Date(plan.lastModifiedAt).toLocaleString() : 'Unknown';
            const modifiedBy = plan.lastModifiedBy || 'admin';
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="plan-info-card">
                        <h4 style="margin-top: 0; color: #4f46e5;">📋 Plan Information</h4>
                        <div class="info-row"><strong>Client:</strong> ${plan.clientName || 'N/A'}</div>
                        <div class="info-row"><strong>Plan Name:</strong> ${plan.planName || 'N/A'}</div>
                        <div class="info-row"><strong>Status:</strong> <span class="status-badge status-${plan.status || 'active'}">${plan.status || 'active'}</span></div>
                        <div class="info-row"><strong>Created:</strong> ${plan.createdAt ? new Date(plan.createdAt).toLocaleDateString() : 'N/A'}</div>
                        ${hasClientChanges ? `<div class="info-row" style="color: #059669;"><strong>⚠️ Client Modified:</strong> ${lastModified}</div>` : ''}
                        ${plan.planDescription ? `<div class="info-row"><strong>Description:</strong><br>${plan.planDescription}</div>` : ''}
                        ${plan.planNotes ? `<div class="info-row"><strong>Notes:</strong><br>${plan.planNotes}</div>` : ''}
                    </div>
                    
                    <div class="nutrition-summary-card">
                        <h4 style="margin-top: 0; color: #dc2626;">🎯 Daily Nutrition Targets</h4>
                        <div class="nutrition-grid">
                            <div class="nutrition-item">
                                <span class="nutrition-label">Calories</span>
                                <span class="nutrition-value">${plan.dailyCalories || 0}</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-label">Protein</span>
                                <span class="nutrition-value">${plan.dailyProtein || 0}g</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-label">Carbs</span>
                                <span class="nutrition-value">${plan.dailyCarbs || 0}g</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-label">Fat</span>
                                <span class="nutrition-value">${plan.dailyFat || 0}g</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="meal-plan-display">
                    <h4 style="margin-bottom: 1rem; color: #7c3aed;">🍽️ Meal Plan Details</h4>
                    ${generateMealPlanDisplayHTML(mealPlan, isMultiDay, plan)}
                </div>
            `;
            
            return html;
        }

        function generateMealPlanDisplayHTML(mealPlan, isMultiDay, plan) {
            if (!mealPlan || Object.keys(mealPlan).length === 0) {
                return '<div class="empty-state">No meal plan created yet.</div>';
            }
            
            if (isMultiDay) {
                // Multi-day format: { 1: {breakfast: [...], lunch: [...], dinner: [...]}, 2: {...}, ... }
                const days = Object.keys(mealPlan).map(Number).sort((a, b) => a - b);
                
                return days.map(day => `
                    <div class="day-section" style="margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                        <h5 style="margin-top: 0; color: #1f2937;">📅 Day ${day}</h5>
                        ${generateDayMealsHTML(mealPlan[day] || {}, plan)}
                    </div>
                `).join('');
            } else {
                // Single-day format: { breakfast: [...], lunch: [...], dinner: [...] }
                return `
                    <div class="day-section">
                        ${generateDayMealsHTML(mealPlan, plan)}
                    </div>
                `;
            }
        }

        function generateDayMealsHTML(dayMeals, plan) {
            const mealTypes = ['breakfast', 'lunch', 'dinner'];
            const mealIcons = { breakfast: '🌅', lunch: '☀️', dinner: '🌙' };
            
            return mealTypes.map(mealType => {
                const items = dayMeals[mealType] || [];
                const hasItems = Array.isArray(items) && items.length > 0;
                
                return `
                    <div class="meal-type-section" style="margin-bottom: 1.5rem;">
                        <h6 style="margin-bottom: 0.5rem; color: #374151;">${mealIcons[mealType]} ${mealType.charAt(0).toUpperCase() + mealType.slice(1)}</h6>
                        ${hasItems ? `
                            <div class="food-items-grid" style="display: grid; gap: 0.5rem;">
                                ${items.map((item, index) => generateFoodItemHTML(item, plan, index)).join('')}
                            </div>
                        ` : '<div class="empty-meal">No foods planned</div>'}
                    </div>
                `;
            }).join('');
        }

        function generateFoodItemHTML(item, plan, index) {
            // Format serving amount and unit for display
            const servingAmount = item.servingAmount || 100;
            const servingUnit = item.servingUnit || 'grams';
            const servingDisplay = servingUnit === 'grams' ? `${servingAmount}g` : 
                                 servingUnit === 'pieces' ? `${servingAmount} pcs` :
                                 servingUnit === 'cups' ? `${servingAmount} cup${servingAmount !== 1 ? 's' : ''}` :
                                 servingUnit === 'tablespoons' ? `${servingAmount} tbsp` :
                                 `${servingAmount} ${servingUnit}`;
            
            const foodName = item.food || item.name || 'Unknown Food';
            const isClientModified = checkIfFoodModifiedByClient(item, plan);
            
            // Find ingredient information from food database
            const foodData = foodDatabase.find(f => f.name === foodName);
            const ingredients = foodData?.ingredients || item.ingredients;
            
            return `
                <div class="food-item-view" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 1rem; padding: 0.75rem; background: ${isClientModified ? '#ecfdf5' : '#f9fafb'}; border-radius: 0.375rem; align-items: center; border-left: ${isClientModified ? '3px solid #10b981' : '3px solid transparent'};" ${ingredients ? `title="🥄 Ingredients: ${ingredients}"` : ''}>
                    <div style="font-weight: 500;">
                        ${isClientModified ? '🔄 ' : ''}${servingDisplay} ${foodName}
                        ${ingredients ? '<span style="color: #3b82f6; font-size: 0.7rem; margin-left: 0.25rem;">🥄</span>' : ''}
                        ${isClientModified ? '<br><small style="color: #059669;">Modified by client</small>' : ''}
                    </div>
                    <div style="text-align: center;">${item.calories || 0} cal</div>
                    <div style="text-align: center;">${item.protein || 0}g protein</div>
                    <div style="text-align: center;">${item.carbs || 0}g carbs</div>
                    <div style="text-align: center;">${item.fat || 0}g fat</div>
                </div>
            `;
        }

        function checkForClientChanges(plan) {
            return plan.lastModifiedBy === 'client' || 
                   (plan.lastModifiedAt && plan.lastModifiedBy);
        }

        function checkIfFoodModifiedByClient(item, plan) {
            // Simple check - in a real implementation, you might track individual food changes
            return plan.lastModifiedBy === 'client';
        }

        function editNutritionPlanFromView() {
            if (currentViewPlanId) {
                closeModal('viewNutritionPlanModal');
                editNutritionPlan(currentViewPlanId);
            }
        }

        async function deleteNutritionPlan(id, planName, clientName) {
            // Confirm deletion
            const confirmMessage = `Are you sure you want to delete this nutrition plan?

📋 Plan: ${planName || 'Unnamed Plan'}
👤 Client: ${clientName || 'Unknown Client'}

⚠️ This action cannot be undone!`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Show loading state
                const deleteButtons = document.querySelectorAll(`[onclick*="deleteNutritionPlan('${id}',"]`);
                deleteButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                });

                // Delete from Firebase
                await window.deleteDoc(window.doc(window.db, NUTRITION_PLANS_COLLECTION, id));

                // Show success message
                showSuccess(`✅ Nutrition plan "${planName}" deleted successfully!`);

                // Refresh the nutrition plans list
                loadNutritionPlans();

                console.log(`Deleted nutrition plan: ${id} - ${planName} for ${clientName}`);

            } catch (error) {
                console.error('Error deleting nutrition plan:', error);
                showError('❌ Failed to delete nutrition plan. Please try again.');

                // Restore button state
                const deleteButtons = document.querySelectorAll(`[onclick*="deleteNutritionPlan('${id}',"]`);
                deleteButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                });
            }
        }

        function editNutritionPlan(id) {
            const plan = nutritionPlans.find(p => p.id === id);
            if (!plan) {
                showError('Nutrition plan not found.');
                return;
            }
            document.getElementById('editPlanId').value = plan.id;
            document.getElementById('editPlanName').value = plan.planName || '';
            document.getElementById('editDailyCalories').value = plan.dailyCalories || '';
            document.getElementById('editDailyProtein').value = plan.dailyProtein || '';
            document.getElementById('editDailyCarbs').value = plan.dailyCarbs || '';
            document.getElementById('editDailyFat').value = plan.dailyFat || '';
            document.getElementById('editPlanDescription').value = plan.planDescription || '';
            document.getElementById('editPlanNotes').value = plan.planNotes || '';
            // Render meal plan sections
            renderEditMealPlan(plan.mealPlan || {});
            showModal('editNutritionPlanModal');
        }
        function renderEditMealPlan(mealPlan) {
            const container = document.getElementById('editMealPlanContainer');
            container.innerHTML = '';
            
            // Check if this is a multi-day meal plan
            const isMultiDay = Object.keys(mealPlan).some(key => !isNaN(key));
            
            if (isMultiDay) {
                // Multi-day format: { 1: {breakfast: [...], lunch: [...], dinner: [...]}, 2: {...}, ... }
                const days = Object.keys(mealPlan).map(Number).sort((a, b) => a - b);
                
                // Create day tabs
                const dayTabsContainer = document.createElement('div');
                dayTabsContainer.className = 'edit-day-tabs';
                dayTabsContainer.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;';
                
                let currentEditDay = days[0] || 1;
                
                days.forEach(day => {
                    const tab = document.createElement('button');
                    tab.type = 'button';
                    tab.className = `edit-day-tab ${day === currentEditDay ? 'active' : ''}`;
                    tab.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 0.375rem; cursor: pointer;';
                    tab.innerHTML = `📅 Day ${day}`;
                    tab.onclick = () => switchEditDay(day, mealPlan);
                    dayTabsContainer.appendChild(tab);
                });
                
                container.appendChild(dayTabsContainer);
                
                // Create content container
                const contentContainer = document.createElement('div');
                contentContainer.id = 'editDayContent';
                container.appendChild(contentContainer);
                
                // Render first day
                renderEditDayMealPlan(currentEditDay, mealPlan[currentEditDay] || {});
                
                // Store for access
                window.currentEditDay = currentEditDay;
                window.editMealPlanData = mealPlan;
                
            } else {
                // Single-day format: { breakfast: [...], lunch: [...], dinner: [...] }
                renderEditDayMealPlan(1, mealPlan);
                window.editMealPlanData = { 1: mealPlan };
            }
        }

        function switchEditDay(day, mealPlan) {
            // Update active tab
            document.querySelectorAll('.edit-day-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = '#f9fafb';
            });
            
            event.target.classList.add('active');
            event.target.style.background = '#dbeafe';
            
            // Render day content
            renderEditDayMealPlan(day, mealPlan[day] || {});
            window.currentEditDay = day;
        }

        function renderEditDayMealPlan(day, dayMeals) {
            const container = document.getElementById('editDayContent') || document.getElementById('editMealPlanContainer');
            const mealTypes = ['breakfast', 'lunch', 'dinner'];
            const mealIcons = { breakfast: '🌅', lunch: '☀️', dinner: '🌙' };
            
            container.innerHTML = `
                <div class="day-header" style="margin-bottom: 1rem;">
                    <h4 style="color: #374151;">📅 Day ${day} Meal Plan</h4>
                </div>
            `;
            
            mealTypes.forEach(mealType => {
                const section = document.createElement('div');
                section.className = 'meal-section';
                section.dataset.mealType = mealType;
                section.innerHTML = `
                    <h4 style="color: #6b7280;">${mealIcons[mealType]} ${mealType.charAt(0).toUpperCase() + mealType.slice(1)}</h4>
                    <div class="meal-items" style="margin-bottom: 1rem;"></div>
                    <button type="button" class="btn btn-add-food" onclick="showEditFoodSelectionModal('${mealType}')">
                        <i class="fas fa-plus"></i> Add Food Item
                    </button>
                `;
                
                // Add meal items
                const itemsContainer = section.querySelector('.meal-items');
                const items = dayMeals[mealType] || [];
                
                if (Array.isArray(items)) {
                    items.forEach(item => {
                    itemsContainer.appendChild(createEditMealItemElement(item));
                });
                } else {
                    console.warn(`Invalid meal items for ${mealType}:`, items);
                }
                
                container.appendChild(section);
            });
        }
        function createEditMealItemElement(food) {
            const mealItem = document.createElement('div');
            mealItem.className = 'meal-item';
            mealItem.dataset.baseCalories = food.baseCalories || food.calories;
            mealItem.dataset.baseProtein = food.baseProtein || food.protein;
            mealItem.dataset.baseCarbs = food.baseCarbs || food.carbs;
            mealItem.dataset.baseFat = food.baseFat || food.fat;
            
            // Get serving amount and unit from food data
            const servingAmount = food.servingAmount || 100;
            const servingUnit = food.servingUnit || 'grams';
            const isClientModified = food.lastModifiedBy === 'client';
            
            mealItem.innerHTML = `
                <div class="serving-controls" style="margin-bottom: 0.5rem;">
                    <span class="serving-label" style="font-weight: 500; margin-right: 0.5rem;">Amount:</span>
                    <input type="number" class="serving-amount" value="${servingAmount}" min="1" step="1" style="width:70px; margin-right: 0.5rem;">
                    <select class="serving-unit" style="margin-right: 0.5rem;">
                        <option value="grams" ${servingUnit === 'grams' ? 'selected' : ''}>Grams</option>
                        <option value="cups" ${servingUnit === 'cups' ? 'selected' : ''}>Cups</option>
                        <option value="tablespoons" ${servingUnit === 'tablespoons' ? 'selected' : ''}>Tablespoons</option>
                        <option value="pieces" ${servingUnit === 'pieces' ? 'selected' : ''}>Pieces</option>
                    </select>
                    ${isClientModified ? '<span style="color: #059669; font-size: 0.875rem; font-weight: 500;">🔄 Modified by client</span>' : ''}
                </div>
                <input type="text" value="${food.food || food.name}" class="food-item" readonly style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: ${isClientModified ? '#ecfdf5' : '#f9fafb'};">
                <div class="nutrition-inputs" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="nutrition-input">
                        <div class="nutrition-label" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Calories</div>
                        <input type="number" class="calories-value" value="${food.calories || 0}" style="width:100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    </div>
                    <div class="nutrition-input">
                        <div class="nutrition-label" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Protein (g)</div>
                        <input type="number" class="protein-value" value="${food.protein || 0}" style="width:100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    </div>
                    <div class="nutrition-input">
                        <div class="nutrition-label" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Carbs (g)</div>
                        <input type="number" class="carbs-value" value="${food.carbs || 0}" style="width:100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    </div>
                    <div class="nutrition-input">
                        <div class="nutrition-label" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Fat (g)</div>
                        <input type="number" class="fat-value" value="${food.fat || 0}" style="width:100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="this.closest('.meal-item').remove()" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                    <i class="fas fa-trash"></i> Remove
                </button>
            `;
            
            // Style the meal item if it was modified by client
            if (isClientModified) {
                mealItem.style.border = '2px solid #10b981';
                mealItem.style.borderRadius = '0.5rem';
                mealItem.style.padding = '1rem';
                mealItem.style.background = '#f0fdf4';
                mealItem.style.marginBottom = '1rem';
            } else {
                mealItem.style.border = '1px solid #e5e7eb';
                mealItem.style.borderRadius = '0.5rem';
                mealItem.style.padding = '1rem';
                mealItem.style.background = '#ffffff';
                mealItem.style.marginBottom = '1rem';
            }
            
            // Auto-update nutrition values when amount/unit changes
            const amountInput = mealItem.querySelector('.serving-amount');
            const unitSelect = mealItem.querySelector('.serving-unit');
            amountInput.addEventListener('input', () => updateNutritionValuesWithServing(mealItem));
            unitSelect.addEventListener('change', () => updateNutritionValuesWithServing(mealItem));
            return mealItem;
        }
        // Show food selection modal for editing
        function showEditFoodSelectionModal(mealType) {
            window._editMealType = mealType;
            window._editFoodTarget = 'edit';
            // Hide the edit modal while food selection is open
            document.getElementById('editNutritionPlanModal').classList.remove('active');
            populateFoodListForEdit();
            showModal('foodSelectionModal');
        }
        // Populate food list for edit mode
        function populateFoodListForEdit() {
            const foodList = document.getElementById('foodList');
            foodList.innerHTML = '';
            const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('foodCategoryFilter').value.toLowerCase();
            foodDatabase.forEach(food => {
                if (searchTerm && !food.name.toLowerCase().includes(searchTerm)) return;
                if (categoryFilter && food.category !== categoryFilter) return;
                const foodCard = document.createElement('div');
                foodCard.className = 'food-item-card';
                foodCard.style.border = '1px solid #e5e7eb';
                foodCard.style.borderRadius = '0.75rem';
                foodCard.style.padding = '1.25rem';
                foodCard.style.cursor = 'pointer';
                foodCard.style.transition = 'all 0.2s';
                foodCard.style.background = 'white';
                foodCard.onclick = () => selectFoodForEdit(food, foodCard);
                foodCard.innerHTML = `
                    <div class="food-name" style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 1.1rem;">${food.name}</div>
                    <div class="food-category" style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">${food.category}</div>
                    <div class="food-nutrition" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; font-size: 0.9rem;">
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Calories</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.calories}</div>
                        </div>
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Protein</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.protein}g</div>
                        </div>
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Carbs</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.carbs}g</div>
                        </div>
                        <div class="nutrition-item" style="text-align: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div class="nutrition-label" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Fat</div>
                            <div class="nutrition-value" style="font-weight: 600; color: #1f2937;">${food.fat}g</div>
                        </div>
                    </div>
                    ${food.ingredients ? `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 0.5rem; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; display: flex; align-items: center;">
                            <span style="margin-right: 0.25rem;">🥄</span> Ingredients (per serving):
                        </div>
                        <div style="font-size: 0.7rem; color: #374151; line-height: 1.4;">
                            ${food.ingredients}
                        </div>
                    </div>
                    ` : ''}
                    <button class="btn-add-food" style="display: none; width: 100%; margin-top: 1rem; background: #006A67; color: white; border: none; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.95rem;">
                        <i class="fas fa-plus"></i> Add to ${window._editMealType}
                    </button>
                `;
                foodList.appendChild(foodCard);
            });
            document.getElementById('foodSearchInput').addEventListener('input', populateFoodListForEdit);
            document.getElementById('foodCategoryFilter').addEventListener('change', populateFoodListForEdit);
        }
        function selectFoodForEdit(food, card) {
            document.querySelectorAll('.food-item-card').forEach(c => {
                c.style.borderColor = '#e5e7eb';
                c.style.boxShadow = 'none';
                c.querySelector('.btn-add-food').style.display = 'none';
            });
            card.style.borderColor = '#2563eb';
            card.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.2)';
            const addButton = card.querySelector('.btn-add-food');
            addButton.style.display = 'block';
            addButton.onclick = (e) => {
                e.stopPropagation();
                addSelectedFoodForEdit(food);
            };
        }
        function addSelectedFoodForEdit(food) {
            if (!food) return;
            // Find the meal section in the edit modal
            let mealSection = null;
            let mealItems = null;
            const mealSections = document.querySelectorAll('#editMealPlanContainer .meal-section');
            for (let section of mealSections) {
                const h4 = section.querySelector('h4');
                if (h4 && h4.textContent.toLowerCase().includes(window._editMealType)) {
                    mealSection = section;
                    break;
                }
            }
            if (!mealSection) return;
            mealItems = mealSection.querySelector('.meal-items');
            mealItems.appendChild(createEditMealItemElement({
                food: food.name,
                calories: food.calories,
                protein: food.protein,
                carbs: food.carbs,
                fat: food.fat
            }));
            closeModal('foodSelectionModal');
        }
        document.getElementById('editNutritionPlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const planId = document.getElementById('editPlanId').value;
            const planName = document.getElementById('editPlanName').value;
            const dailyCalories = parseInt(document.getElementById('editDailyCalories').value);
            const dailyProtein = parseInt(document.getElementById('editDailyProtein').value);
            const dailyCarbs = parseInt(document.getElementById('editDailyCarbs').value);
            const dailyFat = parseInt(document.getElementById('editDailyFat').value);
            const planDescription = document.getElementById('editPlanDescription').value;
            const planNotes = document.getElementById('editPlanNotes').value;
            // Collect meal plan data
            const mealPlan = {};
            const mealSections = document.querySelectorAll('#editMealPlanContainer .meal-section');
            mealSections.forEach(section => {
                // Fix: Extract only the meal type name, removing icons and extra spaces
                const mealType = section.querySelector('h4').textContent.replace(/\s+/g, ' ').trim().toLowerCase().split(' ').pop();
                const mealItems = [];
                section.querySelectorAll('.meal-item').forEach(item => {
                    const foodItem = item.querySelector('.food-item').value;
                    const calories = parseFloat(item.querySelector('.calories-value').textContent) || 0;
                    const protein = parseFloat(item.querySelector('.protein-value').textContent) || 0;
                    const carbs = parseFloat(item.querySelector('.carbs-value').textContent) || 0;
                    const fat = parseFloat(item.querySelector('.fat-value').textContent) || 0;
                    if (foodItem) {
                        mealItems.push({
                            food: foodItem,
                            calories: calories,
                            protein: protein,
                            carbs: carbs,
                            fat: fat
                        });
                    }
                });
                mealPlan[mealType] = mealItems;
            });
            try {
                const planRef = window.doc(window.db, NUTRITION_PLANS_COLLECTION, planId);
                await window.updateDoc(planRef, {
                    planName,
                    dailyCalories,
                    dailyProtein,
                    dailyCarbs,
                    dailyFat,
                    planDescription,
                    planNotes,
                    mealPlan,
                    updatedAt: new Date().toISOString()
                });
                closeModal('editNutritionPlanModal');
                showSuccess('Nutrition plan updated successfully!');
                loadNutritionPlans();
            } catch (error) {
                console.error('Error updating nutrition plan:', error);
                showError('Failed to update nutrition plan. Please try again.');
            }
        });
        // Patch closeModal to restore edit modal if needed
        const _originalCloseModal = closeModal;
        closeModal = function(modalId) {
            _originalCloseModal(modalId);
            if (modalId === 'foodSelectionModal' && window._editFoodTarget === 'edit') {
                document.getElementById('editNutritionPlanModal').classList.add('active');
            }
        }

        // In the food selection modal, add a button and form for custom food
        // Add after the food search and category filter
        const foodSelectionContent = document.querySelector('.food-selection-content');
        if (foodSelectionContent && !document.getElementById('customFoodBtn')) {
            const customFoodBtn = document.createElement('button');
            customFoodBtn.id = 'customFoodBtn';
            customFoodBtn.className = 'btn btn-primary';
            customFoodBtn.type = 'button';
            customFoodBtn.style = 'margin-bottom: 1rem; width: 100%';
            customFoodBtn.innerHTML = '<i class="fas fa-plus"></i> Add Custom Food';
            foodSelectionContent.insertBefore(customFoodBtn, foodSelectionContent.firstChild);
            const customFoodForm = document.createElement('form');
            customFoodForm.id = 'customFoodForm';
            customFoodForm.style = 'display:none; margin-bottom:1rem; background:#f9fafb; padding:1rem; border-radius:0.5rem;';
            customFoodForm.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:0.5rem;align-items:end;">
                    <div><label>Food</label><input type="text" id="customFoodName" required style="width:100%"></div>
                    <div><label>Calories</label><input type="number" id="customFoodCalories" required style="width:100%"></div>
                    <div><label>Protein (g)</label><input type="number" id="customFoodProtein" required style="width:100%"></div>
                    <div><label>Carbs (g)</label><input type="number" id="customFoodCarbs" required style="width:100%"></div>
                    <div><label>Fat (g)</label><input type="number" id="customFoodFat" required style="width:100%"></div>
                </div>
                <button type="submit" class="btn btn-success" style="margin-top:0.75rem;width:100%"><i class="fas fa-plus"></i> Add Custom Food</button>
            `;
            foodSelectionContent.insertBefore(customFoodForm, foodSelectionContent.children[1]);
            customFoodBtn.onclick = () => {
                customFoodForm.style.display = customFoodForm.style.display === 'none' ? 'block' : 'none';
            };
            customFoodForm.onsubmit = function(e) {
                e.preventDefault();
                const food = {
                    name: document.getElementById('customFoodName').value,
                    calories: parseFloat(document.getElementById('customFoodCalories').value),
                    protein: parseFloat(document.getElementById('customFoodProtein').value),
                    carbs: parseFloat(document.getElementById('customFoodCarbs').value),
                    fat: parseFloat(document.getElementById('customFoodFat').value)
                };
                if (window._editFoodTarget === 'edit') {
                    addSelectedFoodForEdit(food);
                } else {
                    addSelectedFood(food, window.currentMealType);
                }
                customFoodForm.reset();
                customFoodForm.style.display = 'none';
            };
        }

        // Mobile menu toggle functionality
        function initializeMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarClose = document.getElementById('sidebarClose');

            // Toggle sidebar
            function toggleSidebar() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                
                // Toggle hamburger icon
                const icon = mobileMenuToggle.querySelector('i');
                if (sidebar.classList.contains('active')) {
                    icon.className = 'fas fa-times';
                    mobileMenuToggle.classList.add('active');
                } else {
                    icon.className = 'fas fa-bars';
                    mobileMenuToggle.classList.remove('active');
                }
            }

            // Close sidebar
            function closeSidebar() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                const icon = mobileMenuToggle.querySelector('i');
                icon.className = 'fas fa-bars';
                mobileMenuToggle.classList.remove('active');
            }

            // Event listeners
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', toggleSidebar);
            }

            if (sidebarClose) {
                sidebarClose.addEventListener('click', closeSidebar);
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', closeSidebar);
            }

            // Close sidebar when nav link is clicked on mobile
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        closeSidebar();
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    closeSidebar();
                }
            });

            // Prevent body scroll when sidebar is open on mobile
            const observer = new MutationObserver(() => {
                if (sidebar.classList.contains('active') && window.innerWidth <= 768) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            });

            observer.observe(sidebar, { attributes: true, attributeFilter: ['class'] });
        }

        // Initialize mobile menu when dashboard is shown
        const originalShowDashboard = showDashboard;
        showDashboard = function() {
            originalShowDashboard();
            initializeMobileMenu();
        };

        // Also initialize if dashboard is already visible
        if (document.getElementById('adminDashboard').style.display !== 'none') {
            initializeMobileMenu();
        }

        // Enhanced Nutrition Plan Creation Functions
        let calculationMode = 'manual';
        let currentMealTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
        let currentDay = 1;
        let maxDays = 7;
        let mealPlanData = {}; // Will store data for each day
        let isCopyingData = false; // Flag to prevent data corruption during copy operations

        function toggleCalculationMode() {
            const mode = document.querySelector('input[name="calculationMode"]:checked').value;
            calculationMode = mode;
            
            const autoCalculateBtn = document.getElementById('autoCalculateBtn');
            const nutritionInputs = document.querySelectorAll('#dailyCalories, #dailyProtein, #dailyCarbs, #dailyFat');
            
            if (mode === 'auto') {
                autoCalculateBtn.style.display = 'block';
                nutritionInputs.forEach(input => {
                    input.style.background = '#f3f4f6';
                    input.style.color = '#6b7280';
                    input.readOnly = true;
                });
                autoCalculateFromMeals();
            } else {
                autoCalculateBtn.style.display = 'none';
                nutritionInputs.forEach(input => {
                    input.style.background = 'white';
                    input.style.color = '#1f2937';
                    input.readOnly = false;
                });
            }
            updateNutritionProgress();
        }

        function calculateMealTotals() {
            const totals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            
            document.querySelectorAll('.meal-item').forEach(item => {
                // Handle both input elements and div elements for nutrition values
                const caloriesElement = item.querySelector('.calories-value');
                const proteinElement = item.querySelector('.protein-value');
                const carbsElement = item.querySelector('.carbs-value');
                const fatElement = item.querySelector('.fat-value');
                
                const calories = parseFloat(caloriesElement?.value || caloriesElement?.textContent || 0);
                const protein = parseFloat(proteinElement?.value || proteinElement?.textContent || 0);
                const carbs = parseFloat(carbsElement?.value || carbsElement?.textContent || 0);
                const fat = parseFloat(fatElement?.value || fatElement?.textContent || 0);
                
                // Only skip items with 0 calories (empty items)
                if (calories > 0) {
                    totals.calories += calories;
                    totals.protein += protein;
                    totals.carbs += carbs;
                    totals.fat += fat;
                }
            });
            
            console.log('Calculated meal totals:', totals); // Debug log
            currentMealTotals = totals;
            return totals;
        }

        function updateNutritionSummary() {
            const totals = calculateMealTotals();
            
            document.getElementById('totalCalories').textContent = Math.round(totals.calories);
            document.getElementById('totalProtein').textContent = Math.round(totals.protein * 10) / 10 + 'g';
            document.getElementById('totalCarbs').textContent = Math.round(totals.carbs * 10) / 10 + 'g';
            document.getElementById('totalFat').textContent = Math.round(totals.fat * 10) / 10 + 'g';
            
            // Update calculated values display
            document.getElementById('calculatedCalories').textContent = `From meals: ${Math.round(totals.calories)}`;
            document.getElementById('calculatedProtein').textContent = `From meals: ${Math.round(totals.protein * 10) / 10}g`;
            document.getElementById('calculatedCarbs').textContent = `From meals: ${Math.round(totals.carbs * 10) / 10}g`;
            document.getElementById('calculatedFat').textContent = `From meals: ${Math.round(totals.fat * 10) / 10}g`;
            
            // Auto-update goals if in auto mode
            if (calculationMode === 'auto') {
                document.getElementById('dailyCalories').value = Math.round(totals.calories);
                document.getElementById('dailyProtein').value = Math.round(totals.protein);
                document.getElementById('dailyCarbs').value = Math.round(totals.carbs);
                document.getElementById('dailyFat').value = Math.round(totals.fat);
            }
            
            updateNutritionProgress();
        }

        function autoCalculateFromMeals() {
            // Calculate averages across all days with food
            let totalDays = 0;
            let averageTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            
            for (let day = 1; day <= maxDays; day++) {
                if (mealPlanData[day]) {
                    let dayTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
                    let hasFood = false;
                    
                    Object.values(mealPlanData[day]).forEach(meals => {
                        meals.forEach(item => {
                            dayTotals.calories += item.calories || 0;
                            dayTotals.protein += item.protein || 0;
                            dayTotals.carbs += item.carbs || 0;
                            dayTotals.fat += item.fat || 0;
                            hasFood = true;
                        });
                    });
                    
                    if (hasFood) {
                        averageTotals.calories += dayTotals.calories;
                        averageTotals.protein += dayTotals.protein;
                        averageTotals.carbs += dayTotals.carbs;
                        averageTotals.fat += dayTotals.fat;
                        totalDays++;
                    }
                }
            }
            
            // If no days have food, use current day totals
            if (totalDays === 0) {
                averageTotals = calculateMealTotals();
                totalDays = 1;
            } else {
                // Calculate averages
                averageTotals.calories = averageTotals.calories / totalDays;
                averageTotals.protein = averageTotals.protein / totalDays;
                averageTotals.carbs = averageTotals.carbs / totalDays;
                averageTotals.fat = averageTotals.fat / totalDays;
            }
            
            // Add some buffer for better nutrition planning (10% increase)
            const bufferedTotals = {
                calories: Math.round(averageTotals.calories * 1.1),
                protein: Math.round(averageTotals.protein * 1.1),
                carbs: Math.round(averageTotals.carbs * 1.1),
                fat: Math.round(averageTotals.fat * 1.1)
            };
            
            document.getElementById('dailyCalories').value = bufferedTotals.calories;
            document.getElementById('dailyProtein').value = bufferedTotals.protein;
            document.getElementById('dailyCarbs').value = bufferedTotals.carbs;
            document.getElementById('dailyFat').value = bufferedTotals.fat;
            
            updateNutritionProgress();
            
            // Show success animation
            const nutritionSection = document.getElementById('nutritionGoalsSection');
            nutritionSection.classList.add('nutrition-goals-complete');
            setTimeout(() => {
                nutritionSection.classList.remove('nutrition-goals-complete');
            }, 2000);
            
            const dayText = totalDays > 1 ? `${totalDays} days` : 'current day';
            showSuccess(`Nutrition goals auto-calculated from ${dayText} of meal planning!`);
        }

        function updateNutritionProgress() {
            const goals = {
                calories: parseInt(document.getElementById('dailyCalories').value) || 0,
                protein: parseInt(document.getElementById('dailyProtein').value) || 0,
                carbs: parseInt(document.getElementById('dailyCarbs').value) || 0,
                fat: parseInt(document.getElementById('dailyFat').value) || 0
            };
            
            const totals = currentMealTotals;
            
            // Calculate progress percentages
            const caloriesProgress = Math.min(100, (totals.calories / goals.calories) * 100);
            const proteinProgress = Math.min(100, (totals.protein / goals.protein) * 100);
            const carbsProgress = Math.min(100, (totals.carbs / goals.carbs) * 100);
            const fatProgress = Math.min(100, (totals.fat / goals.fat) * 100);
            
            // Update progress bars
            document.getElementById('caloriesProgress').style.width = caloriesProgress + '%';
            document.getElementById('proteinProgress').style.width = proteinProgress + '%';
            document.getElementById('carbsProgress').style.width = carbsProgress + '%';
            document.getElementById('fatProgress').style.width = fatProgress + '%';
            
            // Add warning animation if significantly over goals
            const inputs = [
                { element: document.getElementById('dailyCalories'), progress: caloriesProgress },
                { element: document.getElementById('dailyProtein'), progress: proteinProgress },
                { element: document.getElementById('dailyCarbs'), progress: carbsProgress },
                { element: document.getElementById('dailyFat'), progress: fatProgress }
            ];
            
            inputs.forEach(({ element, progress }) => {
                if (progress > 120) {
                    element.parentElement.classList.add('nutrition-warning');
                    setTimeout(() => {
                        element.parentElement.classList.remove('nutrition-warning');
                    }, 500);
                }
            });
        }

        // Auto-calculation is now built directly into the core functions

        // Initialize nutrition tracking when the nutrition plan modal opens
        const originalShowCreateNutritionPlanModal = showCreateNutritionPlanModal;
        showCreateNutritionPlanModal = async function() {
            await originalShowCreateNutritionPlanModal();
            
            // Initialize the nutrition calculator
            setTimeout(() => {
                updateNutritionSummary();
                updateNutritionProgress();
            }, 200);
        };

        // Add observers for meal plan changes
        function observeMealPlanChanges() {
            const mealPlanContainer = document.getElementById('mealPlanContainer');
            if (mealPlanContainer) {
                const observer = new MutationObserver(() => {
                    updateNutritionSummary();
                });
                
                observer.observe(mealPlanContainer, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['textContent']
                });
            }
        }

        // Initialize observers when DOM is ready
        document.addEventListener('DOMContentLoaded', observeMealPlanChanges);

        // Multi-Day Meal Planning Functions
        function initializeMealPlanData() {
            // Initialize empty meal plan data for all days
            console.log('Initializing meal plan data for', maxDays, 'days');
            
            for (let day = 1; day <= maxDays; day++) {
                if (!mealPlanData[day]) {
                    mealPlanData[day] = {
                        breakfast: [],
                        lunch: [],
                        dinner: []
                    };
                }
            }
            
            console.log('Meal plan data initialized:', mealPlanData);
        }

        function switchDay(day) {
            console.log(`🔄 Switching from Day ${currentDay} to Day ${day}`);
            
            // Don't save/switch during copy operations
            if (isCopyingData) {
                console.log(`🚫 Ignoring day switch during copy operation`);
                return;
            }
            
            // Save current day data before switching
            console.log(`💾 Saving data for current day (${currentDay}) before switching`);
            saveCurrentDayData();
            
            // Update current day
            const previousDay = currentDay;
            currentDay = day;
            console.log(`📅 Current day updated from ${previousDay} to ${currentDay}`);
            
            // Update UI
            updateDayTabs();
            loadDayMealPlan(day);
            updateDayTitle(day);
            updateDayNutritionSummary(day);
            
            console.log(`✅ Switch to Day ${day} completed`);
        }

        function updateDayTabs() {
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
                if (parseInt(tab.dataset.day) === currentDay) {
                    tab.classList.add('active');
                }
            });
        }

        function updateDayTitle(day) {
            document.getElementById('currentDayTitle').innerHTML = 
                `<i class="fas fa-calendar-day"></i> Day ${day} Meal Plan`;
        }

        function saveCurrentDayData() {
            // Don't save during copy operations to prevent data corruption
            if (isCopyingData) {
                console.log(`🚫 Skipping save during copy operation`);
                return;
            }
            
            if (!mealPlanData[currentDay]) {
                mealPlanData[currentDay] = { breakfast: [], lunch: [], dinner: [] };
            }
            
            console.log(`💾 Starting to save data for Day ${currentDay}`);
            
            // Create a backup of all other days' data to prevent corruption
            const backupData = {};
            Object.keys(mealPlanData).forEach(day => {
                if (parseInt(day) !== currentDay) {
                    backupData[day] = JSON.parse(JSON.stringify(mealPlanData[day]));
                }
            });
            
            // Save current meal plan to data structure
            const mealSections = document.querySelectorAll('.meal-section');
            const newDayData = { breakfast: [], lunch: [], dinner: [] };
            
            mealSections.forEach(section => {
                const mealType = section.querySelector('h4').textContent.replace(/\s+/g, ' ').trim().toLowerCase().split(' ').pop();
                const mealItems = [];
                
                console.log(`📋 Processing ${mealType} section`);
                
                section.querySelectorAll('.meal-item').forEach((item, index) => {
                    const foodItem = item.querySelector('.food-item')?.value || '';
                    
                    // Handle both input elements and div elements for nutrition values
                    const caloriesElement = item.querySelector('.calories-value');
                    const proteinElement = item.querySelector('.protein-value');
                    const carbsElement = item.querySelector('.carbs-value');
                    const fatElement = item.querySelector('.fat-value');
                    
                    const calories = parseFloat(caloriesElement?.value || caloriesElement?.textContent || 0);
                    const protein = parseFloat(proteinElement?.value || proteinElement?.textContent || 0);
                    const carbs = parseFloat(carbsElement?.value || carbsElement?.textContent || 0);
                    const fat = parseFloat(fatElement?.value || fatElement?.textContent || 0);
                    
                    // Get serving amount and unit
                    const servingAmount = parseFloat(item.querySelector('.serving-amount')?.value || 100);
                    const servingUnit = item.querySelector('.serving-unit')?.value || 'grams';
                    
                    console.log(`🍽️ Item ${index}: ${foodItem} - ${calories} cal, ${protein}g protein`);
                    
                    // Skip empty items only (don't filter out real foods that user added)
                    const isEmpty = !foodItem.trim() || calories === 0;
                    
                    if (foodItem && !isEmpty) {
                        const itemData = {
                            name: foodItem,  // Use 'name' property for consistency
                            food: foodItem,  // Keep 'food' property for backward compatibility
                            calories: calories,
                            protein: protein,
                            carbs: carbs,
                            fat: fat,
                            servingAmount: servingAmount,  // Save serving amount
                            servingUnit: servingUnit       // Save serving unit
                        };
                        mealItems.push(itemData);
                        console.log(`✅ Saved item: ${foodItem} - ${calories} cal, ${servingAmount}${servingUnit} (exact values preserved)`);
                    } else {
                        console.log(`❌ Skipped empty item: ${foodItem} (${calories} cal)`);
                    }
                });
                
                newDayData[mealType] = mealItems;
                console.log(`📊 ${mealType} final items:`, mealItems);
            });
            
            // Only save to current day and restore other days from backup
            mealPlanData[currentDay] = newDayData;
            
            // Restore backup data to prevent any accidental overwrites
            Object.keys(backupData).forEach(day => {
                if (mealPlanData[day] && backupData[day]) {
                    // Only restore if the backed up data has items (to prevent losing real data)
                    let hasBackupItems = false;
                    Object.values(backupData[day]).forEach(meals => {
                        if (meals && Array.isArray(meals) && meals.length > 0) {
                            hasBackupItems = true;
                        }
                    });
                    
                    if (hasBackupItems) {
                        mealPlanData[day] = backupData[day];
                        console.log(`🔒 Restored backup data for Day ${day}`);
                    }
                }
            });
            
            console.log(`💾 Completed saving data for Day ${currentDay}:`, mealPlanData[currentDay]);
        }

        function loadDayMealPlan(day) {
            console.log(`🔄 Loading meal plan for Day ${day}`, mealPlanData[day]);
            
            const container = document.getElementById('mealPlanContainer');
            
            // Don't regenerate HTML if it's not a fresh load
            if (!container.querySelector('.meal-section')) {
                container.innerHTML = generateMealSectionsHTML();
            }
            
            // Clear all existing meal items first
            const allMealItems = container.querySelectorAll('.meal-items');
            allMealItems.forEach(mealItemsContainer => {
                mealItemsContainer.innerHTML = '';
            });
            
            // Load saved data for this day
            if (mealPlanData[day]) {
                Object.keys(mealPlanData[day]).forEach(mealType => {
                    console.log(`📋 Loading ${mealType} for Day ${day}:`, mealPlanData[day][mealType]);
                    
                    const mealSection = findMealSectionByType(container, mealType);
                    if (!mealSection) {
                        console.error(`Could not find meal section for ${mealType}`);
                        return;
                    }
                    
                    const mealItems = mealSection.querySelector('.meal-items');
                    
                    mealPlanData[day][mealType].forEach((item, index) => {
                        console.log(`🍽️ Creating meal item ${index} for ${mealType}:`, item);
                        
                        try {
                            const mealItemElement = createMealItemElement(item);
                            mealItems.appendChild(mealItemElement);
                            
                            // Add event listeners for real-time updates
                            addNutritionEventListeners(mealItemElement);
                            
                            console.log(`✅ Successfully created item: ${item.name} (${item.calories} cal)`);
                        } catch (error) {
                            console.error(`❌ Error creating meal item for ${mealType}:`, error, item);
                        }
                    });
                });
            } else {
                console.log(`📭 No data found for Day ${day} - starting with empty day`);
            }
            
            // Update nutrition summary for this day
            setTimeout(() => {
                console.log(`🔢 Updating nutrition summary for Day ${day}`);
                updateNutritionSummary();
                updateDayNutritionSummary(day);
            }, 100);
        }

        function generateMealSectionsHTML() {
            console.log('🏗️ Generating clean meal sections HTML');
            return `
                <div class="meal-section">
                    <h4><i class="fas fa-sun"></i> Breakfast</h4>
                    <div class="meal-items"></div>
                    <button type="button" class="btn btn-add-food" onclick="showFoodSelectionModal('breakfast')">
                        <i class="fas fa-plus"></i> Add Food Item
                    </button>
                </div>
                <div class="meal-section">
                    <h4><i class="fas fa-sun"></i> Lunch</h4>
                    <div class="meal-items"></div>
                    <button type="button" class="btn btn-add-food" onclick="showFoodSelectionModal('lunch')">
                        <i class="fas fa-plus"></i> Add Food Item
                    </button>
                </div>
                <div class="meal-section">
                    <h4><i class="fas fa-moon"></i> Dinner</h4>
                    <div class="meal-items"></div>
                    <button type="button" class="btn btn-add-food" onclick="showFoodSelectionModal('dinner')">
                        <i class="fas fa-plus"></i> Add Food Item
                    </button>
                </div>
            `;
        }

        function updateDayNutritionSummary(day) {
            console.log(`🔢 Updating day nutrition summary for Day ${day}`);
            
            // Calculate from CURRENT UI state, not saved data
            let totals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            
            // Get totals from current meal items in the UI
            document.querySelectorAll('.meal-item').forEach(item => {
                const caloriesElement = item.querySelector('.calories-value');
                const proteinElement = item.querySelector('.protein-value');
                const carbsElement = item.querySelector('.carbs-value');
                const fatElement = item.querySelector('.fat-value');
                
                const calories = parseFloat(caloriesElement?.value || caloriesElement?.textContent || 0);
                const protein = parseFloat(proteinElement?.value || proteinElement?.textContent || 0);
                const carbs = parseFloat(carbsElement?.value || carbsElement?.textContent || 0);
                const fat = parseFloat(fatElement?.value || fatElement?.textContent || 0);
                
                // Only add if calories > 0 (skip empty items)
                if (calories > 0) {
                    totals.calories += calories;
                    totals.protein += protein;
                    totals.carbs += carbs;
                    totals.fat += fat;
                    
                    const foodName = item.querySelector('.food-item')?.value || 'Unknown';
                    console.log(`📊 Adding to day summary: ${foodName} - ${calories} cal, ${protein}g protein`);
                }
            });
            
            console.log(`📈 Day ${day} totals:`, totals);
            
            // Update the day nutrition summary display
            const summaryElement = document.getElementById('dayNutritionSummary');
            if (summaryElement) {
                summaryElement.textContent = 
                    `${Math.round(totals.calories)} cal • ${Math.round(totals.protein * 10) / 10}g protein • ${Math.round(totals.carbs * 10) / 10}g carbs • ${Math.round(totals.fat * 10) / 10}g fat`;
                
                console.log(`✅ Updated day summary: ${summaryElement.textContent}`);
            } else {
                console.error('❌ dayNutritionSummary element not found!');
            }
        }

        function addNewDay() {
            maxDays++;
            const dayTabs = document.querySelector('.day-tabs');
            const addButton = dayTabs.querySelector('.btn-add-day');
            
            const newTab = document.createElement('button');
            newTab.type = 'button';
            newTab.className = 'day-tab';
            newTab.dataset.day = maxDays;
            newTab.onclick = () => switchDay(maxDays);
            newTab.innerHTML = `<i class="fas fa-calendar-day"></i> Day ${maxDays}`;
            
            dayTabs.insertBefore(newTab, addButton);
            
            // Initialize data for new day
            mealPlanData[maxDays] = { breakfast: [], lunch: [], dinner: [] };
            
            // Switch to new day
            switchDay(maxDays);
            
            showSuccess(`Day ${maxDays} added to meal plan!`);
        }

        function copyFromPreviousDay() {
            console.log(`📋 Attempting to copy from previous day. Current day: ${currentDay}`);
            
            if (currentDay <= 1) {
                showError('No previous day to copy from!');
                return;
            }
            
            const previousDay = currentDay - 1;
            console.log(`📅 Previous day: ${previousDay}`);
            
            // Set flag to prevent data corruption during copy
            isCopyingData = true;
            console.log(`🔒 Set copy flag - preventing automatic saves`);
            
            try {
                // Check if mealPlanData exists and has the previous day
                if (!mealPlanData || !mealPlanData[previousDay]) {
                    console.error(`❌ No data found for day ${previousDay}:`, mealPlanData);
                    showError(`Day ${previousDay} data not found! Make sure to switch to Day ${previousDay} and add foods first.`);
                    return;
                }
                
                console.log(`✅ Found data for day ${previousDay}:`, mealPlanData[previousDay]);
                
                // Check if previous day has any food items
                let hasFoodItems = false;
                let totalItems = 0;
                
                Object.values(mealPlanData[previousDay]).forEach(meals => {
                    if (meals && Array.isArray(meals) && meals.length > 0) {
                        hasFoodItems = true;
                        totalItems += meals.length;
                    }
                });
                
                if (!hasFoodItems) {
                    showError(`Day ${previousDay} is empty! Switch to Day ${previousDay} and add some foods first before copying.`);
                    return;
                }
                
                // Check if current day has data in UI (not just saved data)
                const currentUIItems = document.querySelectorAll('.meal-item');
                let currentDayHasUIData = false;
                currentUIItems.forEach(item => {
                    const calories = parseFloat(item.querySelector('.calories-value')?.value || 0);
                    if (calories > 0) currentDayHasUIData = true;
                });
                
                if (currentDayHasUIData) {
                    if (!confirm(`Day ${currentDay} already has meal data. Replace it with Day ${previousDay}'s meal plan?`)) {
                        return;
                    }
                }
                
                console.log(`🔄 Starting copy operation from Day ${previousDay} to Day ${currentDay}`);
                
                // Store original data to prevent corruption
                const originalPreviousDayData = JSON.parse(JSON.stringify(mealPlanData[previousDay]));
                
                // Create a completely independent deep copy of previous day's data
                const copiedData = {
                    breakfast: originalPreviousDayData.breakfast ? originalPreviousDayData.breakfast.map(item => {
                        const copiedItem = {...item};
                        console.log(`📋 Copying ${copiedItem.name}: ${copiedItem.calories} cal, ${copiedItem.servingAmount}${copiedItem.servingUnit}`);
                        return copiedItem;
                    }) : [],
                    lunch: originalPreviousDayData.lunch ? originalPreviousDayData.lunch.map(item => {
                        const copiedItem = {...item};
                        console.log(`📋 Copying ${copiedItem.name}: ${copiedItem.calories} cal, ${copiedItem.servingAmount}${copiedItem.servingUnit}`);
                        return copiedItem;
                    }) : [],
                    dinner: originalPreviousDayData.dinner ? originalPreviousDayData.dinner.map(item => {
                        const copiedItem = {...item};
                        console.log(`📋 Copying ${copiedItem.name}: ${copiedItem.calories} cal, ${copiedItem.servingAmount}${copiedItem.servingUnit}`);
                        return copiedItem;
                    }) : []
                };
                
                console.log(`📋 Original Day ${previousDay} data (should remain unchanged):`, originalPreviousDayData);
                console.log(`📋 Copied data for Day ${currentDay}:`, copiedData);
                
                // Assign the copied data to current day
                mealPlanData[currentDay] = copiedData;
                
                // Ensure previous day data is preserved
                mealPlanData[previousDay] = originalPreviousDayData;
                
                // Clear the UI completely first
                const container = document.getElementById('mealPlanContainer');
                const allMealItems = container.querySelectorAll('.meal-items');
                allMealItems.forEach(mealItemsContainer => {
                    mealItemsContainer.innerHTML = '';
                });
                
                console.log(`🧹 Cleared UI for Day ${currentDay}`);
                
                // Load the copied data into the UI (this should not affect previous day's data)
                loadDayMealPlan(currentDay);
                
                // Update nutrition summary for current day only
                setTimeout(() => {
                    updateNutritionSummary();
                    updateDayNutritionSummary(currentDay);
                    
                    // Verify that previous day data wasn't modified
                    console.log(`🔍 Verification - Day ${previousDay} data after copy:`, mealPlanData[previousDay]);
                    console.log(`🔍 Verification - Day ${currentDay} data after copy:`, mealPlanData[currentDay]);
                    
                    // Verify calorie totals
                    let prevDayTotals = {calories: 0, protein: 0};
                    Object.values(mealPlanData[previousDay]).forEach(meals => {
                        meals.forEach(item => {
                            prevDayTotals.calories += item.calories || 0;
                            prevDayTotals.protein += item.protein || 0;
                        });
                    });
                    
                    let currentDayTotals = {calories: 0, protein: 0};
                    Object.values(mealPlanData[currentDay]).forEach(meals => {
                        meals.forEach(item => {
                            currentDayTotals.calories += item.calories || 0;
                            currentDayTotals.protein += item.protein || 0;
                        });
                    });
                    
                    console.log(`📊 Day ${previousDay} totals: ${prevDayTotals.calories} cal, ${prevDayTotals.protein}g protein`);
                    console.log(`📊 Day ${currentDay} totals: ${currentDayTotals.calories} cal, ${currentDayTotals.protein}g protein`);
                    
                }, 200);
                
                showSuccess(`✅ Successfully copied meal plan from Day ${previousDay}! Found ${totalItems} food items.`);
                
            } catch (error) {
                console.error('❌ Error copying data:', error);
                showError('Failed to copy meal plan. Please try again.');
            } finally {
                // Always clear the flag
                setTimeout(() => {
                    isCopyingData = false;
                    console.log(`🔓 Cleared copy flag - automatic saves re-enabled`);
                }, 500);
            }
        }

        function clearCurrentDay() {
            if (confirm(`Are you sure you want to clear all meals for Day ${currentDay}?`)) {
                mealPlanData[currentDay] = { breakfast: [], lunch: [], dinner: [] };
                loadDayMealPlan(currentDay);
                showSuccess(`Day ${currentDay} cleared!`);
            }
        }

        // Auto-calculation is now built directly into addFoodToMealPlan and removeMealItem functions

        // Enhanced nutrition plan form submission to include multi-day data
        function collectMultiDayMealPlan() {
            // Save current day before collecting
            saveCurrentDayData();
            
            // Return multi-day meal plan data
            return mealPlanData;
        }

        // Initialize multi-day system when modal opens
        const originalShowCreateNutritionPlanModalEnhanced = showCreateNutritionPlanModal;
        showCreateNutritionPlanModal = async function() {
            await originalShowCreateNutritionPlanModalEnhanced();
            
            // Initialize multi-day system
            initializeMealPlanData();
            
            // Clear default items and load clean day 1
            clearDefaultMealItems();
            loadDayMealPlan(1);
            updateDayTabs();
            
            setTimeout(() => {
                updateNutritionSummary();
                updateDayNutritionSummary(1);
            }, 200);
        };

        // Test function for copy operations
        function testCopyOperation() {
            console.log(`🧪 Testing copy operation with current data:`);
            console.log(`Current day: ${currentDay}`);
            console.log(`Meal plan data:`, mealPlanData);
            
            // Test different serving sizes
            const testItems = document.querySelectorAll('.meal-item');
            testItems.forEach((item, index) => {
                const foodName = item.querySelector('.food-item')?.value || 'Unknown';
                const calories = parseFloat(item.querySelector('.calories-value')?.value || 0);
                const servingAmount = parseFloat(item.querySelector('.serving-amount')?.value || 100);
                const servingUnit = item.querySelector('.serving-unit')?.value || 'grams';
                
                console.log(`🧪 Test item ${index}: ${foodName} - ${calories} cal, ${servingAmount}${servingUnit}`);
                
                // Verify base values
                const baseCalories = parseFloat(item.dataset.baseCalories || 0);
                const expectedCalories = Math.round(baseCalories * (servingAmount / 100));
                
                if (Math.abs(calories - expectedCalories) > 1) {
                    console.warn(`⚠️ Potential calculation issue: ${foodName} has ${calories} cal but expected ${expectedCalories} cal`);
                } else {
                    console.log(`✅ ${foodName} nutrition values are correct`);
                }
            });
        }
        
        // Make test function available globally for debugging
        window.testCopyOperation = testCopyOperation;
        
        // Function to clear default meal items from the UI
        function clearDefaultMealItems() {
            const container = document.getElementById('mealPlanContainer');
            if (container) {
                // Remove all existing meal items but keep the structure
                const allMealItems = container.querySelectorAll('.meal-items');
                allMealItems.forEach(mealItemsContainer => {
                    mealItemsContainer.innerHTML = '';
                });
                console.log('Cleared default meal items from UI');
            }
        }

        // Helper function to find meal sections by meal type
        function findMealSectionByType(container, mealType) {
            const sections = container.querySelectorAll('.meal-section');
            for (let section of sections) {
                const h4 = section.querySelector('h4');
                if (h4 && h4.textContent.toLowerCase().includes(mealType.toLowerCase())) {
                    return section;
                }
            }
            return null;
        }

        // Override the nutrition plan form submission to include multi-day data
        const originalNutritionPlanForm = document.getElementById('nutritionPlanForm');
        if (originalNutritionPlanForm) {
            const originalSubmitHandler = originalNutritionPlanForm.onsubmit;
            originalNutritionPlanForm.addEventListener('submit', function(e) {
                // Save current day data before submission
                saveCurrentDayData();
                
                // Replace the mealPlan data with multi-day data
                const multiDayMealPlan = collectMultiDayMealPlan();
                
                // Continue with original submission but with enhanced data
                // The form will now include multi-day meal plans
            });
        }

        // Exercise action functions
        function viewExercise(id) {
            const exercise = exercises.find(e => e.id === id);
            if (!exercise) {
                showError('Exercise not found.');
                return;
            }
            
            const content = document.getElementById('viewExerciseContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="plan-info-card">
                        <h4 style="margin-top: 0; color: #4f46e5;">📋 Exercise Information</h4>
                        <div class="info-row"><strong>Client:</strong> ${exercise.clientName || 'N/A'}</div>
                        <div class="info-row"><strong>Exercise:</strong> ${exercise.exerciseName || 'N/A'}</div>
                        <div class="info-row"><strong>Category:</strong> <span class="status-badge status-${exercise.category || 'active'}">${exercise.category || 'N/A'}</span></div>
                        <div class="info-row"><strong>Status:</strong> <span class="status-badge status-${exercise.status || 'active'}">${exercise.status || 'active'}</span></div>
                        <div class="info-row"><strong>Assigned:</strong> ${exercise.createdAt ? new Date(exercise.createdAt).toLocaleDateString() : 'N/A'}</div>
                        ${exercise.description ? `<div class="info-row"><strong>Description:</strong><br>${exercise.description}</div>` : ''}
                        ${exercise.notes ? `<div class="info-row"><strong>Notes:</strong><br>${exercise.notes}</div>` : ''}
                    </div>
                    
                    <div class="nutrition-summary-card">
                        <h4 style="margin-top: 0; color: #dc2626;">🏋️ Exercise Details</h4>
                        <div class="nutrition-grid">
                            <div class="nutrition-item">
                                <span class="nutrition-label">Sets</span>
                                <span class="nutrition-value">${exercise.sets || 0}</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-label">Reps</span>
                                <span class="nutrition-value">${exercise.reps || 0}</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-label">Videos</span>
                                <span class="nutrition-value">${exercise.videoFiles ? exercise.videoFiles.length : (exercise.videoFile ? 1 : 0)}</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="nutrition-label">Total Reps</span>
                                <span class="nutrition-value">${(exercise.sets || 0) * (exercise.reps || 0)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${(exercise.videoFiles && exercise.videoFiles.length > 0) || exercise.videoFile ? `
                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: #7c3aed;">🎥 Exercise Videos</h4>
                    <div style="background: #f3f4f6; border-radius: 0.5rem; padding: 2rem;">
                        ${exercise.videoFiles && exercise.videoFiles.length > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <p style="color: #6b7280; margin-bottom: 1rem; font-weight: 600;">Available Videos (${exercise.videoFiles.length}):</p>
                                <div style="display: grid; gap: 0.5rem;">
                                    ${exercise.videoFiles.map((video, index) => `
                                        <div style="display: flex; align-items: center; justify-content: space-between; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.75rem;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="fas fa-video" style="color: #0ea5e9;"></i>
                                                <span style="font-size: 0.875rem;">${video}</span>
                                            </div>
                                            <button class="btn btn-sm btn-primary" onclick="viewExerciseVideo('${video}')">
                                                <i class="fas fa-play"></i> Play
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : exercise.videoFile ? `
                            <div style="text-align: center;">
                        <p style="color: #6b7280; margin-bottom: 1rem;">Video: ${exercise.videoFile}</p>
                        <p style="color: #9ca3af; font-size: 0.875rem;">Place your video file in the videos folder with the name: ${exercise.videoFile}</p>
                        <button class="btn btn-primary" onclick="viewExerciseVideo('${exercise.videoFile}')">
                            <i class="fas fa-play"></i> Play Video
                        </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            `;
            
            window.currentViewExerciseId = id;
            showModal('viewExerciseModal');
        }

        function viewExerciseVideo(videoFile) {
            if (!videoFile) {
                showError('No video file specified for this exercise.');
                return;
            }
            
            console.log('=== VIEW EXERCISE VIDEO FUNCTION CALLED ===');
            console.log('Video file:', videoFile);
            
            // Create a modal to show the video
            const videoModal = document.createElement('div');
            videoModal.className = 'modal active';
            videoModal.style.cssText = `
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 2000;
                align-items: center;
                justify-content: center;
                -webkit-overflow-scrolling: touch;
            `;
            
            // Add responsive styles for mobile
            const style = document.createElement('style');
            style.textContent = `
                @media (max-width: 768px) {
                    #videoModal .modal-content {
                        width: 100% !important;
                        height: 100% !important;
                        max-width: none !important;
                        max-height: none !important;
                        border-radius: 0 !important;
                        margin: 0 !important;
                        padding: 0.25rem !important;
                    }
                    
                    #videoModal video {
                        width: 100% !important;
                        height: calc(100vh - 80px) !important;
                        min-height: 500px !important;
                        object-fit: cover !important;
                        border-radius: 0.5rem !important;
                    }
                    
                    #videoModal h3 {
                        font-size: 1rem !important;
                        margin-bottom: 0.5rem !important;
                    }
                    
                    #videoModal p {
                        font-size: 0.75rem !important;
                        margin-top: 0.5rem !important;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Get base filename for multiple format support
            const baseName = videoFile.replace(/\.[^/.]+$/, '');
            
            videoModal.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 1rem; max-width: 800px; width: 95%; max-height: 95vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; color: #1f2937; font-size: 1.25rem;">Exercise Video: ${videoFile}</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0.5rem; -webkit-tap-highlight-color: transparent;">&times;</button>
                    </div>
                    <div style="background: #000; border-radius: 0.5rem; position: relative; margin-bottom: 1rem;">
                        <video 
                            controls 
                            playsinline 
                            webkit-playsinline 
                            style="width: 100%; height: auto; min-height: 400px; border-radius: 0.5rem; display: block; object-fit: cover;" 
                            preload="metadata" 
                            poster=""
                            muted="true"
                            autoplay="false"
                            webkit-playsinline="true"
                            x-webkit-airplay="allow"
                            controlsList="nodownload">
                            <!-- Safari prefers MP4 with H.264 codec first -->
                            <source src="videos/${baseName}.mp4" type="video/mp4; codecs=\"avc1.42E01E, mp4a.40.2\"">
                            <source src="videos/${baseName}.m4v" type="video/mp4">
                            <!-- Original file as fallback -->
                            <source src="videos/${videoFile}" type="video/webm">
                            <source src="videos/${baseName}.mov" type="video/quicktime">
                            <source src="videos/${baseName}.3gp" type="video/3gpp">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <p style="color: #6b7280; font-size: 0.875rem; text-align: center; margin: 0;">
                        Safari requires MP4 format. If video doesn't play, ensure "${baseName}.mp4" exists in the videos folder.
                    </p>
                </div>
            `;
            
            document.body.appendChild(videoModal);
            
            // Safari-specific video handling
            const video = videoModal.querySelector('video');
            if (video) {
                // Safari-specific event listeners
                video.addEventListener('loadstart', () => {
                    console.log('Video load started');
                });
                
                video.addEventListener('loadedmetadata', () => {
                    console.log('Video metadata loaded successfully');
                });
                
                video.addEventListener('loadeddata', () => {
                    console.log('Video data loaded');
                });
                
                video.addEventListener('canplay', () => {
                    console.log('Video can play');
                });
                
                video.addEventListener('canplaythrough', () => {
                    console.log('Video can play through without buffering');
                });
                
                video.addEventListener('error', (e) => {
                    console.error('Video error:', e);
                    console.error('Video error details:', video.error);
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(255, 0, 0, 0.8);
                        color: white;
                        padding: 1rem;
                        border-radius: 0.5rem;
                        text-align: center;
                        max-width: 80%;
                    `;
                    
                    let errorMessage = 'Unable to load video';
                    if (video.error) {
                        switch(video.error.code) {
                            case 1:
                                errorMessage = 'Video loading aborted';
                                break;
                            case 2:
                                errorMessage = 'Network error loading video';
                                break;
                            case 3:
                                errorMessage = 'Video decoding failed';
                                break;
                            case 4:
                                errorMessage = 'Video format not supported';
                                break;
                        }
                    }
                    
                    errorDiv.innerHTML = `
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⚠️</div>
                        <p style="margin: 0; font-size: 1rem;">${errorMessage}</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">File: ${videoFile}</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #ffeb3b;">Safari requires MP4 format with H.264 codec</p>
                    `;
                    video.parentElement.appendChild(errorDiv);
                });
                
                // Force video to load on Safari
                video.load();
            }
            
            // Close modal when clicking outside
            videoModal.addEventListener('click', (e) => {
                if (e.target === videoModal) {
                    videoModal.remove();
                }
            });
        }

        function editExerciseFromView() {
            if (window.currentViewExerciseId) {
                closeModal('viewExerciseModal');
                editExercise(window.currentViewExerciseId);
            }
        }

        function editExercise(id) {
            const exercise = exercises.find(e => e.id === id);
            if (!exercise) {
                showError('Exercise not found.');
                return;
            }
            
            document.getElementById('editExerciseId').value = exercise.id;
            document.getElementById('editExerciseName').value = exercise.exerciseName || '';
            document.getElementById('editWorkoutSplit').value = exercise.workoutSplit || '';
            // Update categories based on workout split
            updateEditExerciseCategories();
            document.getElementById('editExerciseCategory').value = exercise.category || '';
            // Handle multiple videos
            if (exercise.videoFiles && Array.isArray(exercise.videoFiles)) {
                editSelectedVideos = [...exercise.videoFiles];
                updateVideoListDisplay('editSelectedVideos', editSelectedVideos);
                document.getElementById('editExerciseVideo').value = '';
            } else if (exercise.videoFile) {
                // Backward compatibility with single video
                editSelectedVideos = [exercise.videoFile];
                updateVideoListDisplay('editSelectedVideos', editSelectedVideos);
                document.getElementById('editExerciseVideo').value = '';
            } else {
                editSelectedVideos = [];
                updateVideoListDisplay('editSelectedVideos', editSelectedVideos);
                document.getElementById('editExerciseVideo').value = '';
            }
            document.getElementById('editExerciseStatus').value = exercise.status || 'active';
            document.getElementById('editExerciseSets').value = exercise.sets || '';
            document.getElementById('editExerciseReps').value = exercise.reps || '';
            document.getElementById('editExerciseDescription').value = exercise.description || '';
            document.getElementById('editExerciseNotes').value = exercise.notes || '';
            
            showModal('editExerciseModal');
        }

        async function deleteExercise(id, exerciseName, clientName) {
            const confirmMessage = `Are you sure you want to delete this exercise?

🏋️ Exercise: ${exerciseName || 'Unnamed Exercise'}
👤 Client: ${clientName || 'Unknown Client'}

⚠️ This action cannot be undone!`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const deleteButtons = document.querySelectorAll(`[onclick*="deleteExercise('${id}',"]`);
                deleteButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                });

                await window.deleteDoc(window.doc(window.db, EXERCISES_COLLECTION, id));

                showSuccess(`✅ Exercise "${exerciseName}" deleted successfully!`);
                loadExercises();

            } catch (error) {
                console.error('Error deleting exercise:', error);
                showError('❌ Failed to delete exercise. Please try again.');

                const deleteButtons = document.querySelectorAll(`[onclick*="deleteExercise('${id}',"]`);
                deleteButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                });
            }
        }

        // Edit exercise form handler
        document.getElementById('editExerciseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const exerciseId = document.getElementById('editExerciseId').value;
            const exerciseName = document.getElementById('editExerciseName').value;
            const workoutSplit = document.getElementById('editWorkoutSplit').value;
            const category = document.getElementById('editExerciseCategory').value;
            const videoFiles = editSelectedVideos.length > 0 ? editSelectedVideos : [document.getElementById('editExerciseVideo').value.trim()].filter(v => v);
            
            if (videoFiles.length === 0) {
                showError('Please add at least one video file.');
                return;
            }
            const status = document.getElementById('editExerciseStatus').value;
            const sets = parseInt(document.getElementById('editExerciseSets').value);
            const reps = parseInt(document.getElementById('editExerciseReps').value);
            const description = document.getElementById('editExerciseDescription').value;
            const notes = document.getElementById('editExerciseNotes').value;

            try {
                const exerciseRef = window.doc(window.db, EXERCISES_COLLECTION, exerciseId);
                await window.updateDoc(exerciseRef, {
                    exerciseName,
                    workoutSplit,
                    category,
                    videoFiles,
                    status,
                    sets,
                    reps,
                    description,
                    notes,
                    updatedAt: new Date().toISOString()
                });
                
                closeModal('editExerciseModal');
                showSuccess('Exercise updated successfully!');
                loadExercises();
            } catch (error) {
                console.error('Error updating exercise:', error);
                showError('Failed to update exercise. Please try again.');
            }
        });

        // Video autocomplete functionality
        let videoFiles = [];
        let currentAutocomplete = null;

        // Load video files from the videos folder
        async function loadVideoFiles() {
            try {
                // Since we can't directly read the folder, we'll use a predefined list
                // You can update this list by scanning your videos folder
                videoFiles = [
                    '90 hip mobility.mp4',
                    'abduction machine.mp4',
                    'addiction machine.mp4',
                    'ankle mobility.mp4',
                    'back extension glutes.mp4',
                    'back extension.mp4',
                    'bar bridge.mp4',
                    'bar squats.mp4',
                    'barballe chest press.mp4',
                    'bbc streaches.mp4',
                    'bent over bar.mp4',
                    'bi curl dp.mp4',
                    'bi curl machine.mp4',
                    'bike.mp4',
                    'body weight calf raises.mp4',
                    'body weight dips.mp4',
                    'body weight lunges.mp4',
                    'body weight squats.mp4',
                    'body weight sumo squats.mp4',
                    'bulgarin lunges glutes.mp4',
                    'bulgrain lunges dp.mp4',
                    'chest press cable.mp4',
                    'chest press dp.mp4',
                    'close grip chest press tri.mp4',
                    'close grip ez bi curl cable.mp4',
                    'close grip lat pull down.mp4',
                    'close grip raw machine.mp4',
                    'close grip seated raw.mp4',
                    'close grip shoulder press machine.mp4',
                    'construction bi machine.mp4',
                    'cow cat.mp4',
                    'crunches.mp4',
                    'dead bug.mp4',
                    'dead lift bar.mp4',
                    'dead lift dp.mp4',
                    'decline machine panatta.mp4',
                    'decline machine.mp4',
                    'dips machine tri.mp4',
                    'dog hip mobility 2.mp4',
                    'dog hip mobility.mp4',
                    'dog rotition.mp4',
                    'dp bridge.mp4',
                    'dp sumo squats.mp4',
                    'elbow blank.mp4',
                    'ez bar curl.mp4',
                    'ez bar skull cruches.mp4',
                    'ez cable over head tri.mp4',
                    'ez cable push down.mp4',
                    'ez cable shrugs.mp4',
                    'ez construction curl.mp4',
                    'ez pull over cable.mp4',
                    'ez reverse bent over cable.mp4',
                    'fly cable.mp4',
                    'front raises bar.mp4',
                    'front raises cable.mp4',
                    'front raises hummer dp.mp4',
                    'front squats dp.mp4',
                    'high blank.mp4',
                    'hip and addiction mobility.mp4',
                    'hummer curl dp.mp4',
                    'i mobility.mp4',
                    'incle push up.mp4',
                    'incline bar.mp4',
                    'incline chest press cable.mp4',
                    'incline chest press dp.mp4',
                    'incline fly cable.mp4',
                    'incline fly dp.mp4',
                    'incline machine.mp4',
                    'incline raw dp.mp4',
                    'incline rear delt dp.mp4',
                    'knee crunches.mp4',
                    'knee twist.mp4',
                    'KVAW5374.mp4',
                    'kyphosis 1.mp4',
                    'kyphosis 2.mp4',
                    'kyphosis 3.mp4',
                    'lat pull down machine.mp4',
                    'lateral raises dp.mp4',
                    'lateral raises machine.mp4',
                    'law rear delt cable.mp4',
                    'leg daynamic streach.mp4',
                    'leg extension machine.mp4',
                    'leg raises abs.mp4',
                    'leg raises on dips.mp4',
                    'leg streach 1.mp4',
                    'leg streach 2.mp4',
                    'leg streach 3.mp4',
                    'leg streach 4.mp4',
                    'leg streaches 2.mp4',
                    'lunges walk dp.mp4',
                    'lying curl machine.mp4',
                    'militry shoulder press.mp4',
                    'mobility and core.mp4',
                    'mobility scaupla 2.mp4',
                    'mobility scaupla.mp4',
                    'narrow destince leg press machine.mp4',
                    'pull up.mp4',
                    'rear delt cable.mp4',
                    'rear delt fly machine.mp4',
                    'reverse bent over bar.mp4',
                    'reverse ez bar curl.mp4',
                    'reverse ez cable front raises.mp4',
                    'reverse lat pull down.mp4',
                    'reverse scorbion.mp4',
                    'reverse seated raw.mp4',
                    'reverse single arm lat pull down machine.mp4',
                    'rope cruches.mp4',
                    'rope face pull.mp4',
                    'rope front raises.mp4',
                    'rope hummer curl.mp4',
                    'rope pull over cable.mp4',
                    'rope push down.mp4',
                    'ropr low raw cable.mp4',
                    'rotation tara.mp4',
                    'russian twist.mp4',
                    'scoliosis 1.mp4',
                    'scoliosis 2.mp4',
                    'scoliosis 3.mp4',
                    'scoliosis 4.mp4',
                    'scoliosis 5.mp4',
                    'scorbion.mp4',
                    'seated bi curl dp.mp4',
                    'seated calf raises.mp4',
                    'seated hip mobility.mp4',
                    'seated leg curl.mp4',
                    'shoulder press machine.mp4',
                    'shoulder taps.mp4',
                    'shrugs tara.mp4',
                    'shulder press dp.mp4',
                    'shulder taps 2.mp4',
                    'side blank.mp4',
                    'side to cable single arm push down.mp4',
                    'single arm bi curl cable.mp4',
                    'single arm construction bi curl.mp4',
                    'single arm construction curl cable.mp4',
                    'single arm construction curl.mp4',
                    'single arm french cable tri.mp4',
                    'single arm front raises cable.mp4',
                    'single arm hummer construction curl.mp4',
                    'single arm kick back.mp4',
                    'single arm lateral raises cable.mp4',
                    'single arm lateral raises machine.mp4',
                    'single arm low raw machine.mp4',
                    'single arm over head tri.mp4',
                    'single arm push down.mp4',
                    'single arm raw cable.mp4',
                    'single arm raw lat.mp4',
                    'single arm raw machine.mp4',
                    'single arm raw seated raw.mp4',
                    'single arm reverse curl.mp4',
                    'single arm shoulder press dp.mp4',
                    'single leg calf raises.mp4',
                    'single leg cross over kick back.mp4',
                    'single leg kick back cable.mp4',
                    'single leg RDL.mp4',
                    'skull cruches dp.mp4',
                    'smith calf raises.mp4',
                    'spider curl.mp4',
                    'straght bar push down.mp4',
                    'straght bar rest and saaed.mp4',
                    'straght leg raises abs.mp4',
                    'streach 1.mp4',
                    'streach 2.mp4',
                    'streach 3.mp4',
                    'streach 4.mp4',
                    'streach 5.mp4',
                    'streach 6.mp4',
                    'streach with band 2.mp4',
                    'streach with band 3.mp4',
                    'streach with band.mp4',
                    't mobility.mp4',
                    'toe taps.mp4',
                    'twist mobility.mp4',
                    'twist tara.mp4',
                    'two hand bi curl cable.mp4',
                    'two hand push down.mp4',
                    'upper daynamic streach.mp4',
                    'v construction curl machine.mp4',
                    'v over head cable.mp4',
                    'v push down.mp4',
                    'w mobility.mp4',
                    'wide destice leg press machine.mp4',
                    'wide ez bi curl cable.mp4',
                    'wide grip bent over cable.mp4',
                    'wide grip lat pull down traps.mp4',
                    'wide grip raw machine 2.mp4',
                    'wide grip raw machine.mp4',
                    'wide grip seated raw.mp4',
                    'wide lat pull down.mp4',
                    'WSAH1192.mp4',
                    'y mobility.mp4'
                ];
                
                console.log('Video files loaded:', videoFiles.length, 'videos');
            } catch (error) {
                console.error('Error loading video files:', error);
                videoFiles = [];
            }
        }

        // Filter video files based on input
        function filterVideos(searchTerm) {
            if (!searchTerm) return [];
            return videoFiles.filter(video => 
                video.toLowerCase().includes(searchTerm.toLowerCase())
            ).slice(0, 10); // Limit to 10 results
        }

        // Show autocomplete dropdown
        function showAutocomplete(input, autocompleteDiv, filteredVideos) {
            if (filteredVideos.length === 0) {
                autocompleteDiv.style.display = 'none';
                return;
            }

            autocompleteDiv.innerHTML = filteredVideos.map(video => `
                <div class="autocomplete-item" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background-color 0.2s;" 
                     onmouseover="this.style.backgroundColor='#f9fafb'" 
                     onmouseout="this.style.backgroundColor='white'"
                     onclick="selectVideo('${video}', '${input.id}')">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-video" style="color: #0ea5e9; font-size: 0.875rem;"></i>
                        <span style="font-size: 0.875rem;">${video}</span>
                    </div>
                </div>
            `).join('');

            autocompleteDiv.style.display = 'block';
        }

        // Select video from autocomplete
        function selectVideo(videoName, inputId) {
            document.getElementById(inputId).value = videoName;
            hideAutocomplete(inputId);
        }

        // Hide autocomplete dropdown
        function hideAutocomplete(inputId) {
            const autocompleteDiv = inputId === 'exerciseVideo' ? 
                document.getElementById('videoAutocomplete') : 
                document.getElementById('editVideoAutocomplete');
            if (autocompleteDiv) {
                autocompleteDiv.style.display = 'none';
            }
        }

        // Initialize autocomplete for video inputs
        function initializeVideoAutocomplete() {
            const exerciseVideoInput = document.getElementById('exerciseVideo');
            const editExerciseVideoInput = document.getElementById('editExerciseVideo');

            if (exerciseVideoInput) {
                exerciseVideoInput.addEventListener('input', function() {
                    const filteredVideos = filterVideos(this.value);
                    showAutocomplete(this, document.getElementById('videoAutocomplete'), filteredVideos);
                });

                exerciseVideoInput.addEventListener('blur', function() {
                    setTimeout(() => hideAutocomplete('exerciseVideo'), 200);
                });
            }

            if (editExerciseVideoInput) {
                editExerciseVideoInput.addEventListener('input', function() {
                    const filteredVideos = filterVideos(this.value);
                    showAutocomplete(this, document.getElementById('editVideoAutocomplete'), filteredVideos);
                });

                editExerciseVideoInput.addEventListener('blur', function() {
                    setTimeout(() => hideAutocomplete('editExerciseVideo'), 200);
                });
            }
        }

        // Workout split categories
        const workoutSplits = {
            'push-pull-legs': {
                name: 'Push Pull Legs (3 Days)',
                categories: [
                    { value: 'push', label: 'Push (Chest, Shoulders, Triceps)' },
                    { value: 'pull', label: 'Pull (Back, Biceps)' },
                    { value: 'legs', label: 'Legs (Quads, Hamstrings, Calves)' }
                ]
            },
            'arnold-split': {
                name: 'Arnold Split (4 Days)',
                categories: [
                    { value: 'chest-back', label: 'Chest & Back' },
                    { value: 'shoulders-arms', label: 'Shoulders & Arms' },
                    { value: 'legs', label: 'Legs' },
                    { value: 'rest', label: 'Rest Day' }
                ]
            },
            'bro-split': {
                name: 'Bro Split (5-6 Days)',
                categories: [
                    { value: 'chest', label: 'Chest' },
                    { value: 'back', label: 'Back' },
                    { value: 'shoulders', label: 'Shoulders' },
                    { value: 'biceps', label: 'Biceps' },
                    { value: 'triceps', label: 'Triceps' },
                    { value: 'legs', label: 'Legs' },
                    { value: 'abs', label: 'Abs' },
                    { value: 'cardio', label: 'Cardio' }
                ]
            }
        };

        // Update exercise categories based on selected workout split
        function updateExerciseCategories() {
            const workoutSplit = document.getElementById('workoutSplit').value;
            const categorySelect = document.getElementById('exerciseCategory');
            
            // Clear current options
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            
            if (workoutSplit && workoutSplits[workoutSplit]) {
                const categories = workoutSplits[workoutSplit].categories;
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.value;
                    option.textContent = category.label;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Update edit exercise categories based on selected workout split
        function updateEditExerciseCategories() {
            const workoutSplit = document.getElementById('editWorkoutSplit').value;
            const categorySelect = document.getElementById('editExerciseCategory');
            
            // Clear current options
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            
            if (workoutSplit && workoutSplits[workoutSplit]) {
                const categories = workoutSplits[workoutSplit].categories;
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.value;
                    option.textContent = category.label;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Multiple video management
        let selectedVideos = [];
        let editSelectedVideos = [];

        // Add video to create form list
        function addVideoToList() {
            const videoInput = document.getElementById('exerciseVideo');
            const videoName = videoInput.value.trim();
            
            if (!videoName) {
                showError('Please enter a video file name.');
                return;
            }
            
            if (selectedVideos.includes(videoName)) {
                showError('This video is already in the list.');
                return;
            }
            
            selectedVideos.push(videoName);
            updateVideoListDisplay('selectedVideos', selectedVideos);
            videoInput.value = '';
            hideAutocomplete('exerciseVideo');
        }

        // Add video to edit form list
        function addEditVideoToList() {
            const videoInput = document.getElementById('editExerciseVideo');
            const videoName = videoInput.value.trim();
            
            if (!videoName) {
                showError('Please enter a video file name.');
                return;
            }
            
            if (editSelectedVideos.includes(videoName)) {
                showError('This video is already in the list.');
                return;
            }
            
            editSelectedVideos.push(videoName);
            updateVideoListDisplay('editSelectedVideos', editSelectedVideos);
            videoInput.value = '';
            hideAutocomplete('editExerciseVideo');
        }

        // Remove video from list
        function removeVideoFromList(videoName, isEdit = false) {
            if (isEdit) {
                editSelectedVideos = editSelectedVideos.filter(v => v !== videoName);
                updateVideoListDisplay('editSelectedVideos', editSelectedVideos);
            } else {
                selectedVideos = selectedVideos.filter(v => v !== videoName);
                updateVideoListDisplay('selectedVideos', selectedVideos);
            }
        }

        // Clear all videos from list
        function clearVideoList() {
            selectedVideos = [];
            updateVideoListDisplay('selectedVideos', selectedVideos);
        }

        function clearEditVideoList() {
            editSelectedVideos = [];
            updateVideoListDisplay('editSelectedVideos', editSelectedVideos);
        }

        // Update video list display
        function updateVideoListDisplay(containerId, videos) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (videos.length === 0) {
                container.innerHTML = '<div style="color: #9ca3af; font-size: 0.875rem; font-style: italic;">No videos added yet</div>';
                return;
            }
            
            const videoList = videos.map((video, index) => `
                <div style="display: flex; align-items: center; justify-content: space-between; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; margin-bottom: 0.25rem; transition: all 0.2s ease;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; transition: background-color 0.2s ease;" 
                         onclick="viewExerciseVideo('${video}')" 
                         title="Click to preview video"
                         onmouseover="this.style.backgroundColor='#e5e7eb'" 
                         onmouseout="this.style.backgroundColor='transparent'">
                        <i class="fas fa-video" style="color: #0ea5e9; font-size: 0.75rem;"></i>
                        <span style="font-size: 0.875rem; color: #374151;">${video}</span>
                        <i class="fas fa-play" style="color: #10b981; font-size: 0.75rem; margin-left: 0.25rem;"></i>
                    </div>
                    <button type="button" onclick="removeVideoFromList('${video}', ${containerId === 'editSelectedVideos'})" 
                            style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem; border-radius: 0.25rem; transition: background-color 0.2s ease;"
                            onmouseover="this.style.backgroundColor='#fef2f2'" 
                            onmouseout="this.style.backgroundColor='transparent'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = videoList;
        }

        // Update selectVideo function to work with multiple videos
        function selectVideo(videoName, inputId) {
            document.getElementById(inputId).value = videoName;
            hideAutocomplete(inputId);
        }

        // Load video files when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadVideoFiles();
            initializeVideoAutocomplete();
            
            // Initialize video lists
            updateVideoListDisplay('selectedVideos', selectedVideos);
            updateVideoListDisplay('editSelectedVideos', editSelectedVideos);
        });
    </script>
</body>
</html>